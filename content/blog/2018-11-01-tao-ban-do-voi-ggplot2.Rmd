---
title: "Tạo bản đồ với ggplot2"
author: "Hoàng Đức Anh"
date: "2018-11-01"
categories:
  - Data Vizualization
tags:
  - ggplot2
  - map
summary: "Tạo bản đồ với ggplot2"
banner: "img/banners/banner-20.png"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

# Giới thiệu

Khi phân tích dữ liệu, xây dựng bản đồ là một trong những công cụ rất mạnh giúp cho việc trực quan hóa, đặc biệt trong lĩnh vực kinh doanh, marketing. Việc xây dựng bản đồ giúp truyền tài kết quả phân tích một cách nhanh chóng và hiệu quả. 

Với cách làm truyền thống, việc xây dựng bản đồ là không hề dễ dàng. Các packages như `sp`, `sf` hay `tmap` đều rất mạnh trong vẽ biểu đồ. Tuy nhiên, các packages này đều chưa thực sự tương thích với hệ sinh thái của `tidyverse`. Tuy nhiên, với `ggplot2` phiên bản từ `2.3` trở lên, việc xây dựng biểu đồ được thực hiện khá rất dễ dàng với sự tương thích của `tidyverse`.

Trong bài viết này, `Ranalytics` sẽ hướng dẫn các bạn vẽ biểu đồ Việt Nam một cách đơn giản.

---

## Bước 1: Load dữ liệu địa lý

Để dọc dữ liệu địa lý định dang `.shp`, ta sử dụng package `sf` với hàm `st_read`. Dữ liệu về bản đồ Việt Nam được `Ranalytics` chuẩn bị ở đường link sau [https://github.com/anhhd/data/VNM_adm]

```{r, eval = F}
library(tidyverse)
library(sf)
vn <- st_read("VNM_adm/VNM_adm1.shp")
vn %>% class
```

```{r, echo = F}
library(tidyverse)
library(sf)
vn <- st_read("../../static/data/VNM_adm/VNM_adm1.shp")
vn %>% class
```


---

## Bước 2: Trực quan hóa biểu đồ

Như chúng ta thấy, dữ liệu có định dang `sf` và `data.frame`. Với `ggplot2` từ 2.3, ta có thể trực quan hóa object `sf` như sau

```{r}
theme_set(
  theme_minimal() +
  theme(axis.line = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank()))

vn %>% 
  ggplot() +
  geom_sf(aes(fill = NAME_1)) +
  theme(legend.position = "none") 
```

---

## Bước 3: Tạo biểu đồ nhiệt

Với định dạng `sf`, ta hoàn toàn có thể tạo thêm biến mới thể hiện doanh số bán hàng hoặc lượng dân cư và thể hiện dưới dạng biểu đồ nhiệt như sau.

```{r}
#Tạo thêm biến sale
df <- vn %>% mutate(sale = runif(63, 1, 10))
df %>% names
```

```{r}
df %>% 
  ggplot() +
  geom_sf(aes(fill = sale)) +
  scale_fill_viridis_c()
```

---

## Tạo biểu đồ với cấp quận, thành phố

```{r, eval = F}
# Load biểu đồ cấp quận huyện
vn2 <- st_read("VNM_adm/VNM_adm2.shp")
```

```{r, echo = F}
vn2 <- st_read("../../static/data/VNM_adm/VNM_adm2.shp")
```

```{r}
# Lọc biểu đồ với 1 tỉnh
vn2 %>% 
  filter(NAME_1 == "Yên Bái") %>% 
  # Tạo thêm doanh số bán hàng
  mutate(sale = runif(nrow(.), 1, 10)) %>% 
  ggplot() +
  geom_sf(aes(fill = sale)) +
  geom_sf_text(aes(label = VARNAME_2)) +
  scale_fill_viridis_c() +
  labs(title = "Volume of Vodka in Yen Bai in 2018",
       caption = "Created by Ranalytics.vn")
```

---

Như vậy chúng ta đã học được cách xây dựng biểu đồ cơ bản với `ggplot2`. Chúc các bạn làm việc hiệu quả với `Ranalytics.vn`





<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Phân tích dữ liệu thực tế với R</title>
  <meta name="description" content="A book example for a Chapman &amp; Hall book.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Phân tích dữ liệu thực tế với R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="github-repo" content="yihui/bookdown-crc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Phân tích dữ liệu thực tế với R" />
  
  <meta name="twitter:description" content="A book example for a Chapman &amp; Hall book." />
  

<meta name="author" content="Hoàng Đức Anh">


<meta name="date" content="2018-09-10">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html">
<link rel="next" href="trc-quan-hoa-d-liu.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css\style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Phân tích dữ liệu thực tế với R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Lời mở đầu</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#tai-sao-nen-oc-cun-sach-nay"><i class="fa fa-check"></i>Tại sao nên đọc cuốn sách này</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#cu-truc-cua-sach"><i class="fa fa-check"></i>Cấu trúc của sách</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#cac-phn-mm-uc-s-dung"><i class="fa fa-check"></i>Các phần mềm được sử dụng</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#li-cam-on"><i class="fa fa-check"></i>Lời cảm ơn</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="v-tac-gia.html"><a href="v-tac-gia.html"><i class="fa fa-check"></i>Về tác giả</a></li>
<li class="part"><span><b>I Các kiến thức cơ bản</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Khoa học dữ liệu và nghề phân tích dữ liệu</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#khoa-hoc-d-liu"><i class="fa fa-check"></i><b>1.1</b> Khoa học dữ liệu</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#tai-sao-phan-tich-d-liu-la-ngh-kho"><i class="fa fa-check"></i><b>1.2</b> Tại sao phân tích dữ liệu là nghề khó?</a></li>
</ul></li>
<li class="part"><span><b>II Ứng dụng thực tế</b></span></li>
<li class="chapter" data-level="2" data-path="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html"><a href="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html"><i class="fa fa-check"></i><b>2</b> Các phương pháp phân tích dữ liệu thực tế ứng dụng với R</a><ul>
<li class="chapter" data-level="2.1" data-path="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html"><a href="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html#phn-1"><i class="fa fa-check"></i><b>2.1</b> Phần 1</a></li>
<li class="chapter" data-level="2.2" data-path="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html"><a href="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html#phn-2"><i class="fa fa-check"></i><b>2.2</b> Phần 2</a></li>
<li class="chapter" data-level="2.3" data-path="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html"><a href="cac-phuong-phap-phan-tich-d-liu-thc-t-ng-dung-vi-r.html#phn-3"><i class="fa fa-check"></i><b>2.3</b> Phần 3</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><i class="fa fa-check"></i><b>3</b> Ngữ pháp của biến đổi dữ liệu với DPLYR</a><ul>
<li class="chapter" data-level="3.1" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#gii-thiu-v-pipe-operator"><i class="fa fa-check"></i><b>3.1</b> Giới thiệu về pipe operator</a></li>
<li class="chapter" data-level="3.2" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#cac-ham-co-ban-trong-dplyr"><i class="fa fa-check"></i><b>3.2</b> Các hàm cơ bản trong dplyr</a><ul>
<li class="chapter" data-level="3.2.1" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#nhom-cau-lnh-truy-vn-d-liu"><i class="fa fa-check"></i><b>3.2.1</b> Nhóm câu lệnh truy vấn dữ liệu</a></li>
<li class="chapter" data-level="3.2.2" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#nhom-cau-lnh-bin-i-d-liu"><i class="fa fa-check"></i><b>3.2.2</b> Nhóm câu lệnh biến đổi dữ liệu</a></li>
<li class="chapter" data-level="3.2.3" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#nhom-ham-tng-hp-d-liu-vi-summarise"><i class="fa fa-check"></i><b>3.2.3</b> Nhóm hàm tổng hợp dữ liệu với <code>summarise</code></a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#cac-ham-nang-cao-trong-dplyr"><i class="fa fa-check"></i><b>3.3</b> Các hàm nâng cao trong dplyr</a><ul>
<li class="chapter" data-level="3.3.1" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#iu-kin-phan-nhom-vi-case_when"><i class="fa fa-check"></i><b>3.3.1</b> Điều kiện phân nhóm với <code>case_when</code></a></li>
<li class="chapter" data-level="3.3.2" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#tao-them-bin-mi-theo-iu-kin-vi-mutate_if-mutate_at"><i class="fa fa-check"></i><b>3.3.2</b> Tạo thêm biến mới theo điều kiện với <code>mutate_if</code> &amp; <code>mutate_at</code></a></li>
<li class="chapter" data-level="3.3.3" data-path="ng-phap-cua-bin-i-d-liu-vi-dplyr.html"><a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html#tng-hp-d-liu-theo-iu-kin-vi-summarise_at-va-summarise_if"><i class="fa fa-check"></i><b>3.3.3</b> Tổng hợp dữ liệu theo điều kiện với <code>summarise_at</code> và <code>summarise_if</code></a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Các vấn đề khác</b></span></li>
<li class="chapter" data-level="4" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html"><i class="fa fa-check"></i><b>4</b> Cơ bản về SQL</a><ul>
<li class="chapter" data-level="4.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#kt-ni-r-vi-sql-server"><i class="fa fa-check"></i><b>4.1</b> Kết nối R với SQL Server</a><ul>
<li class="chapter" data-level="4.1.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cach-1-cai-t-rodbc-kt-ni-vi-ms-sql-server"><i class="fa fa-check"></i><b>4.1.1</b> Cách 1: Cài đặt RODBC &amp; kết nối với MS SQL Server</a></li>
<li class="chapter" data-level="4.1.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cach-2-s-dung-dbi-sqlrserver-odbc"><i class="fa fa-check"></i><b>4.1.2</b> Cách 2: Sử dụng DBI, SQLRServer, odbc</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#so-b-sql"><i class="fa fa-check"></i><b>4.2</b> Sơ bộ SQL</a></li>
<li class="chapter" data-level="4.3" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cac-cau-lnh-co-ban-trong-sql"><i class="fa fa-check"></i><b>4.3</b> Các câu lệnh cơ bản trong SQL</a><ul>
<li class="chapter" data-level="4.3.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#ham-select"><i class="fa fa-check"></i><b>4.3.1</b> Hàm SELECT</a></li>
<li class="chapter" data-level="4.3.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cau-lnh-where"><i class="fa fa-check"></i><b>4.3.2</b> Câu lệnh where</a></li>
<li class="chapter" data-level="4.3.3" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cac-phep-tinh-aggregation"><i class="fa fa-check"></i><b>4.3.3</b> Các phép tính aggregation</a></li>
<li class="chapter" data-level="4.3.4" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cac-phep-tinh-toan-co-ban"><i class="fa fa-check"></i><b>4.3.4</b> Các phép tính toán cơ bản</a></li>
<li class="chapter" data-level="4.3.5" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cac-phep-tinh-vi-string"><i class="fa fa-check"></i><b>4.3.5</b> Các phép tính với string</a></li>
<li class="chapter" data-level="4.3.6" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#join-cac-bang"><i class="fa fa-check"></i><b>4.3.6</b> Join các bảng</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#sub-query"><i class="fa fa-check"></i><b>4.4</b> Sub Query</a><ul>
<li class="chapter" data-level="4.4.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#sub-query-thong-thung"><i class="fa fa-check"></i><b>4.4.1</b> Sub query thông thường</a></li>
<li class="chapter" data-level="4.4.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#exists"><i class="fa fa-check"></i><b>4.4.2</b> Exists</a></li>
<li class="chapter" data-level="4.4.3" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#any-vs.all"><i class="fa fa-check"></i><b>4.4.3</b> Any vs. All</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#data-manipulation"><i class="fa fa-check"></i><b>4.5</b> Data Manipulation</a></li>
<li class="chapter" data-level="4.6" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#tao-data-base"><i class="fa fa-check"></i><b>4.6</b> Tạo Data Base</a></li>
<li class="chapter" data-level="4.7" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#view"><i class="fa fa-check"></i><b>4.7</b> View</a></li>
<li class="chapter" data-level="4.8" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#index"><i class="fa fa-check"></i><b>4.8</b> Index</a><ul>
<li class="chapter" data-level="4.8.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#bang-tam"><i class="fa fa-check"></i><b>4.8.1</b> Bảng tạm</a></li>
<li class="chapter" data-level="4.8.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#khai-quat-cac-cau-lnh-truy-vn-trong-sql"><i class="fa fa-check"></i><b>4.8.2</b> Khái quát các câu lệnh truy vấn trong SQL</a></li>
<li class="chapter" data-level="4.8.3" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#kim-tra-kiu-d-liu-trong-bang"><i class="fa fa-check"></i><b>4.8.3</b> Kiểm tra kiểu dữ liệu trong bảng</a></li>
</ul></li>
<li class="chapter" data-level="4.9" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#sql-ng"><i class="fa fa-check"></i><b>4.9</b> SQL động</a><ul>
<li class="chapter" data-level="4.9.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#s-dung-exec"><i class="fa fa-check"></i><b>4.9.1</b> Sử dụng EXEC</a></li>
<li class="chapter" data-level="4.9.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#luu-y-khi-s-dung-sql-ng"><i class="fa fa-check"></i><b>4.9.2</b> Lưu ý khi sử dụng SQL động</a></li>
</ul></li>
<li class="chapter" data-level="4.10" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#t-sql"><i class="fa fa-check"></i><b>4.10</b> T-SQL</a><ul>
<li class="chapter" data-level="4.10.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#procedure"><i class="fa fa-check"></i><b>4.10.1</b> Procedure</a></li>
<li class="chapter" data-level="4.10.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#hin-thi-tt-ca-cac-procedure-ang-luu-trong-h-thng"><i class="fa fa-check"></i><b>4.10.2</b> Hiển thị tất cả các procedure đang lưu trong hệ thống</a></li>
<li class="chapter" data-level="4.10.3" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#tao-procedure"><i class="fa fa-check"></i><b>4.10.3</b> Tạo procedure</a></li>
<li class="chapter" data-level="4.10.4" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#gan-kt-qua-1-procedure-vao-bin"><i class="fa fa-check"></i><b>4.10.4</b> Gán kết quả 1 procedure vào biến</a></li>
<li class="chapter" data-level="4.10.5" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#gan-kt-qua-function"><i class="fa fa-check"></i><b>4.10.5</b> Gán kết quả function</a></li>
<li class="chapter" data-level="4.10.6" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#vong-lp-voi-bang"><i class="fa fa-check"></i><b>4.10.6</b> Vòng lặp vơi bảng</a></li>
<li class="chapter" data-level="4.10.7" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#window-function"><i class="fa fa-check"></i><b>4.10.7</b> Window function</a></li>
</ul></li>
<li class="chapter" data-level="4.11" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#pivot---unpivot"><i class="fa fa-check"></i><b>4.11</b> Pivot - Unpivot</a><ul>
<li class="chapter" data-level="4.11.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#procedure-unpivot"><i class="fa fa-check"></i><b>4.11.1</b> Procedure unpivot</a></li>
</ul></li>
<li class="chapter" data-level="4.12" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#s-dung-index"><i class="fa fa-check"></i><b>4.12</b> Sử dụng Index</a></li>
<li class="chapter" data-level="4.13" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cac-luu-y-khac"><i class="fa fa-check"></i><b>4.13</b> Các lưu ý khác</a></li>
<li class="chapter" data-level="4.14" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#so-sanh-khac"><i class="fa fa-check"></i><b>4.14</b> So sánh khác</a><ul>
<li class="chapter" data-level="4.14.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#auto-wrap-in-mssql"><i class="fa fa-check"></i><b>4.14.1</b> Auto Wrap in MSSQL</a></li>
<li class="chapter" data-level="4.14.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#sa-lai-font-mau-cua-text-editor"><i class="fa fa-check"></i><b>4.14.2</b> Sửa lại font màu của Text Editor</a></li>
<li class="chapter" data-level="4.14.3" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#format-inh-dang-them-ky-t-00-truc-s"><i class="fa fa-check"></i><b>4.14.3</b> Format định dạng thêm ký tự 00 trước số</a></li>
<li class="chapter" data-level="4.14.4" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#kim-tra-inh-dang-d-liu-mt-bang"><i class="fa fa-check"></i><b>4.14.4</b> Kiểm tra định dạng dữ liệu một bảng</a></li>
<li class="chapter" data-level="4.14.5" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#convert-t-ting-vit-co-du-sang-khong-du"><i class="fa fa-check"></i><b>4.14.5</b> Convert từ tiếng Việt có dấu sang không dấu</a></li>
<li class="chapter" data-level="4.14.6" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#cac-luu-y-giup-tang-tc--truy-vn"><i class="fa fa-check"></i><b>4.14.6</b> Các lưu ý giúp tăng tốc độ truy vấn</a></li>
</ul></li>
<li class="chapter" data-level="4.15" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#tai-liu-tham-khao"><i class="fa fa-check"></i><b>4.15</b> Tài liệu tham khảo</a></li>
<li class="chapter" data-level="4.16" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#xay-dng-data-warehouse-data-mart"><i class="fa fa-check"></i><b>4.16</b> Xây dựng Data warehouse &amp; Data Mart</a><ul>
<li class="chapter" data-level="4.16.1" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#xay-dng-bang"><i class="fa fa-check"></i><b>4.16.1</b> Xây dựng bảng</a></li>
<li class="chapter" data-level="4.16.2" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#xay-dng-database"><i class="fa fa-check"></i><b>4.16.2</b> Xây dựng database</a></li>
</ul></li>
<li class="chapter" data-level="4.17" data-path="co-ban-v-sql.html"><a href="co-ban-v-sql.html#s-dung-sqlcmd"><i class="fa fa-check"></i><b>4.17</b> Sử dụng SQLCMD</a></li>
</ul></li>
<li class="part"><span><b>IV Case study</b></span></li>
<li class="chapter" data-level="5" data-path="trc-quan-hoa-d-liu.html"><a href="trc-quan-hoa-d-liu.html"><i class="fa fa-check"></i><b>5</b> Trực quan hóa dữ liệu</a><ul>
<li class="chapter" data-level="5.1" data-path="trc-quan-hoa-d-liu.html"><a href="trc-quan-hoa-d-liu.html#xay-dng-phu-ban-hang-theo-tng-nhom"><i class="fa fa-check"></i><b>5.1</b> Xây dựng phễu bán hàng theo từng nhóm</a></li>
<li class="chapter" data-level="5.2" data-path="trc-quan-hoa-d-liu.html"><a href="trc-quan-hoa-d-liu.html#ve-biu--warterfall-cho-aciveinactive-users"><i class="fa fa-check"></i><b>5.2</b> Vẽ biểu đồ warterfall cho acive/inactive users</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="more-to-say.html"><a href="more-to-say.html"><i class="fa fa-check"></i><b>A</b> More to Say</a></li>
<li class="chapter" data-level="" data-path="tai-liu-tham-khao-1.html"><a href="tai-liu-tham-khao-1.html"><i class="fa fa-check"></i>Tài liệu tham khảo</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Phân tích dữ liệu thực tế với R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="co-ban-v-sql" class="section level1">
<h1><span class="header-section-number">Chương 4</span> Cơ bản về SQL</h1>
<div id="kt-ni-r-vi-sql-server" class="section level2">
<h2><span class="header-section-number">4.1</span> Kết nối R với SQL Server</h2>
<div id="cach-1-cai-t-rodbc-kt-ni-vi-ms-sql-server" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Cách 1: Cài đặt RODBC &amp; kết nối với MS SQL Server</h3>
<p><strong>Giải pháp</strong>: Sử dụng RODBC</p>
<ul>
<li><strong>Bước 1</strong>: Vào Control Panel &gt;&gt; Administrative Tool &gt;&gt; ODBC Data Source &gt;&gt; Add &gt;&gt; Chọn Server &gt;&gt; Lựa chọn login vào Server &gt;&gt; Test Data &gt;&gt; Test Data Source</li>
<li><strong>Bước 2</strong>: Khởi tạo connection với SQL từ R</li>
</ul>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1"><span class="co">#Cài đặt connection với SQLServer</span></a>
<a class="sourceLine" id="cb103-2" data-line-number="2"><span class="kw">library</span>(RODBC)</a>
<a class="sourceLine" id="cb103-3" data-line-number="3">ch &lt;-<span class="st"> </span><span class="kw">odbcConnect</span>(<span class="st">&quot;sql&quot;</span>, <span class="dt">uid =</span> <span class="st">&quot;sa&quot;</span>, <span class="dt">pwd =</span> <span class="st">&quot;123&quot;</span>)</a>
<a class="sourceLine" id="cb103-4" data-line-number="4"><span class="co">#Kết nối SQL với R</span></a>
<a class="sourceLine" id="cb103-5" data-line-number="5"><span class="kw">sqlQuery</span>(ch, <span class="st">&quot;</span></a>
<a class="sourceLine" id="cb103-6" data-line-number="6"><span class="st">         SELECT top 100 * from learnsql.dbo.account&quot;</span>) <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb103-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ACCOUNT_ID=</span>ACCOUNT_ID <span class="op">%&gt;%</span><span class="st"> </span>factor) <span class="op">%&gt;%</span><span class="st"> </span>summary</a>
<a class="sourceLine" id="cb103-8" data-line-number="8">gbm <span class="op">%&gt;%</span><span class="st"> </span>summary</a></code></pre></div>
</div>
<div id="cach-2-s-dung-dbi-sqlrserver-odbc" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Cách 2: Sử dụng DBI, SQLRServer, odbc</h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb104-2" data-line-number="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb104-3" data-line-number="3"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb104-4" data-line-number="4"><span class="kw">library</span>(odbc)</a>
<a class="sourceLine" id="cb104-5" data-line-number="5"><span class="kw">library</span>(RSQLServer)</a>
<a class="sourceLine" id="cb104-6" data-line-number="6"><span class="kw">sessionInfo</span>()</a>
<a class="sourceLine" id="cb104-7" data-line-number="7"><span class="co"># Step 1: Tạo connection với odbc</span></a>
<a class="sourceLine" id="cb104-8" data-line-number="8"></a>
<a class="sourceLine" id="cb104-9" data-line-number="9">con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),</a>
<a class="sourceLine" id="cb104-10" data-line-number="10">                 <span class="dt">Driver    =</span> <span class="st">&quot;SQL Server&quot;</span>, </a>
<a class="sourceLine" id="cb104-11" data-line-number="11">                 <span class="dt">Server    =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb104-12" data-line-number="12">                 <span class="dt">Database  =</span> <span class="st">&quot;learningsql&quot;</span>,</a>
<a class="sourceLine" id="cb104-13" data-line-number="13">                 <span class="dt">UID       =</span> <span class="st">&quot;sa&quot;</span>,</a>
<a class="sourceLine" id="cb104-14" data-line-number="14">                 <span class="dt">PWD       =</span> <span class="dv">123456</span>,</a>
<a class="sourceLine" id="cb104-15" data-line-number="15">                 <span class="dt">Port      =</span> <span class="dv">1433</span>)</a>
<a class="sourceLine" id="cb104-16" data-line-number="16"></a>
<a class="sourceLine" id="cb104-17" data-line-number="17"><span class="co">#Xem danh sách các bảng trong DB</span></a>
<a class="sourceLine" id="cb104-18" data-line-number="18"></a>
<a class="sourceLine" id="cb104-19" data-line-number="19"><span class="kw">dbListTables</span>(con, <span class="dt">schema_name =</span> <span class="st">&quot;dbo&quot;</span>)</a>
<a class="sourceLine" id="cb104-20" data-line-number="20"></a>
<a class="sourceLine" id="cb104-21" data-line-number="21"><span class="co">#Xem danh sách các cột trong 1 bảng</span></a>
<a class="sourceLine" id="cb104-22" data-line-number="22"></a>
<a class="sourceLine" id="cb104-23" data-line-number="23"><span class="kw">dbListFields</span>(con, <span class="st">&quot;CUSTOMER_PRODUCT_HOLDING&quot;</span>)</a>
<a class="sourceLine" id="cb104-24" data-line-number="24"></a>
<a class="sourceLine" id="cb104-25" data-line-number="25"><span class="co">#Preview 1 bảng</span></a>
<a class="sourceLine" id="cb104-26" data-line-number="26">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;KPI_2017&quot;</span>)</a>
<a class="sourceLine" id="cb104-27" data-line-number="27"></a>
<a class="sourceLine" id="cb104-28" data-line-number="28"><span class="co">#Đếm số dòng với tally</span></a>
<a class="sourceLine" id="cb104-29" data-line-number="29"></a>
<a class="sourceLine" id="cb104-30" data-line-number="30">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;KPI_2017&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>tally</a>
<a class="sourceLine" id="cb104-31" data-line-number="31"></a>
<a class="sourceLine" id="cb104-32" data-line-number="32"><span class="co">#Convert sang SQL Query</span></a>
<a class="sourceLine" id="cb104-33" data-line-number="33"></a>
<a class="sourceLine" id="cb104-34" data-line-number="34">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;KPI_2017&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb104-35" data-line-number="35"></a>
<a class="sourceLine" id="cb104-36" data-line-number="36">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;KPI_2017&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-37" data-line-number="37"><span class="st">  </span><span class="kw">group_by</span>(SEGMENT) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-38" data-line-number="38"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-39" data-line-number="39"><span class="st">  </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb104-40" data-line-number="40"></a>
<a class="sourceLine" id="cb104-41" data-line-number="41">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;KPI_2017&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-42" data-line-number="42"><span class="st">  </span><span class="kw">group_by</span>(SEGMENT) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-43" data-line-number="43"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="kw">dense_rank</span>(Volumn)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-44" data-line-number="44"><span class="st">  </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb104-45" data-line-number="45"></a>
<a class="sourceLine" id="cb104-46" data-line-number="46"><span class="kw">tbl</span>(con, <span class="st">&quot;KPI_2017&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-47" data-line-number="47"><span class="st">  </span><span class="kw">left_join</span>(<span class="kw">tbl</span>(con, <span class="st">&quot;DimDate&quot;</span>), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;Date&quot;</span> =<span class="st"> &quot;DateKey&quot;</span>))  -&gt;<span class="st"> </span>df</a>
<a class="sourceLine" id="cb104-48" data-line-number="48"></a>
<a class="sourceLine" id="cb104-49" data-line-number="49"><span class="co">#Write dataframe vào bảng</span></a>
<a class="sourceLine" id="cb104-50" data-line-number="50">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;CUSTOMER_PRODUCT_HOLDING&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-51" data-line-number="51"><span class="st">  </span><span class="kw">select</span>(CIF, <span class="dv">12</span><span class="op">:</span><span class="dv">28</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-52" data-line-number="52"><span class="st">  </span><span class="kw">head</span>(<span class="dv">100</span>) -&gt;<span class="st"> </span>df</a>
<a class="sourceLine" id="cb104-53" data-line-number="53">df <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(var, value, <span class="op">-</span>CIF) -&gt;<span class="st"> </span>df2</a>
<a class="sourceLine" id="cb104-54" data-line-number="54"></a>
<a class="sourceLine" id="cb104-55" data-line-number="55"><span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer_ph_melt&quot;</span>, df2)</a>
<a class="sourceLine" id="cb104-56" data-line-number="56"></a>
<a class="sourceLine" id="cb104-57" data-line-number="57"><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;select top 10 * from [TRANGTQ2].[DBS_DAILY].[dbo].[CARD_20170621]&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-58" data-line-number="58"><span class="st">  </span><span class="kw">dbFetch</span>()</a>
<a class="sourceLine" id="cb104-59" data-line-number="59"></a>
<a class="sourceLine" id="cb104-60" data-line-number="60"><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select top 10 * from [TRANGTQ2].[DBS_DAILY].[dbo].[CARD_20170621]&quot;</span>)  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-61" data-line-number="61"><span class="st">  </span>tbl</a></code></pre></div>
<p><strong>Các ứng dụng nâng cao</strong>:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb105-1" data-line-number="1"><span class="co">#Hỗ trợ hiển thị nhiều lần query trong cùng 1 bảng</span></a>
<a class="sourceLine" id="cb105-2" data-line-number="2">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;CUSTOMER&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(CITY) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">no =</span> <span class="kw">paste0</span>(STATE, <span class="st">&quot;_new&quot;</span>)) -&gt;<span class="st"> </span>df</a>
<a class="sourceLine" id="cb105-5" data-line-number="5">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(no <span class="op">==</span><span class="st"> &quot;HA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb105-6" data-line-number="6"><span class="co">#Lần 1</span></a>
<a class="sourceLine" id="cb105-7" data-line-number="7">df1 &lt;-<span class="st"> </span><span class="kw">head</span>(df)  <span class="op">%&gt;%</span><span class="st"> </span>ungroup </a>
<a class="sourceLine" id="cb105-8" data-line-number="8"><span class="co">#Lần 2</span></a>
<a class="sourceLine" id="cb105-9" data-line-number="9">df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-10" data-line-number="10"><span class="st">  </span>ungroup <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(CUST_ID <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-12" data-line-number="12"><span class="st">  </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb105-13" data-line-number="13"></a>
<a class="sourceLine" id="cb105-14" data-line-number="14"><span class="co">#Khi biến đổi trên nhiều bảng,</span></a>
<a class="sourceLine" id="cb105-15" data-line-number="15"><span class="co">#chưa cho phép biến đổi linh hoạt như R</span></a>
<a class="sourceLine" id="cb105-16" data-line-number="16"></a>
<a class="sourceLine" id="cb105-17" data-line-number="17">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(CUST_ID <span class="op">%in%</span><span class="st"> </span>(df1 <span class="op">%&gt;%</span><span class="st"> </span>collect)<span class="op">$</span>CUST_ID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb105-18" data-line-number="18"><span class="st">  </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb105-19" data-line-number="19">                   </a>
<a class="sourceLine" id="cb105-20" data-line-number="20"></a>
<a class="sourceLine" id="cb105-21" data-line-number="21">df1.data<span class="op">$</span>CUST_ID</a></code></pre></div>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" data-line-number="1"><span class="co"># Tạo hàm cho connection</span></a>
<a class="sourceLine" id="cb106-2" data-line-number="2"></a>
<a class="sourceLine" id="cb106-3" data-line-number="3">vp_dbConnect &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">database =</span> <span class="st">&quot;master&quot;</span>, </a>
<a class="sourceLine" id="cb106-4" data-line-number="4">                         <span class="dt">UID =</span> <span class="st">&quot;sa&quot;</span>, </a>
<a class="sourceLine" id="cb106-5" data-line-number="5">                         <span class="dt">PWD =</span> <span class="st">&quot;123456&quot;</span>,</a>
<a class="sourceLine" id="cb106-6" data-line-number="6">                         <span class="dt">Server =</span> <span class="st">&quot;localhost&quot;</span>){</a>
<a class="sourceLine" id="cb106-7" data-line-number="7">  connect &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(),</a>
<a class="sourceLine" id="cb106-8" data-line-number="8">                       <span class="dt">Driver    =</span> <span class="st">&quot;SQL Server&quot;</span>, </a>
<a class="sourceLine" id="cb106-9" data-line-number="9">                       <span class="dt">Server    =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb106-10" data-line-number="10">                       <span class="dt">Database  =</span> database,</a>
<a class="sourceLine" id="cb106-11" data-line-number="11">                       <span class="dt">UID       =</span> UID,</a>
<a class="sourceLine" id="cb106-12" data-line-number="12">                       <span class="dt">PWD       =</span> PWD,</a>
<a class="sourceLine" id="cb106-13" data-line-number="13">                       <span class="dt">Port      =</span> <span class="dv">1433</span>)</a>
<a class="sourceLine" id="cb106-14" data-line-number="14">  <span class="kw">return</span>(connect)</a>
<a class="sourceLine" id="cb106-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb106-16" data-line-number="16"></a>
<a class="sourceLine" id="cb106-17" data-line-number="17"></a>
<a class="sourceLine" id="cb106-18" data-line-number="18">daily_connect &lt;-<span class="st"> </span><span class="kw">vp_dbConnect</span>(<span class="dt">database =</span> <span class="st">&quot;DATA&quot;</span>)</a>
<a class="sourceLine" id="cb106-19" data-line-number="19"></a>
<a class="sourceLine" id="cb106-20" data-line-number="20"><span class="kw">vp_dbConnect</span>(<span class="st">&quot;DATA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-21" data-line-number="21"><span class="st">  </span><span class="kw">tbl</span>(<span class="st">&quot;TBL_LIMIT_ORG&quot;</span>)</a>
<a class="sourceLine" id="cb106-22" data-line-number="22"></a>
<a class="sourceLine" id="cb106-23" data-line-number="23"><span class="kw">vp_dbConnect</span>(<span class="st">&quot;DBS_BI&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-24" data-line-number="24"><span class="st">  </span><span class="kw">tbl</span>(<span class="st">&quot;CUSTOMER_PRODUCT_HOLDING&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-25" data-line-number="25"><span class="st">  </span>collect</a>
<a class="sourceLine" id="cb106-26" data-line-number="26"></a>
<a class="sourceLine" id="cb106-27" data-line-number="27"><span class="co">#connect với H2O</span></a>
<a class="sourceLine" id="cb106-28" data-line-number="28"><span class="kw">library</span>(h2o)</a>
<a class="sourceLine" id="cb106-29" data-line-number="29"><span class="kw">h2o.init</span>()</a>
<a class="sourceLine" id="cb106-30" data-line-number="30"><span class="kw">vp_dbConnect</span>(<span class="st">&quot;DATA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-31" data-line-number="31"><span class="st">  </span><span class="kw">tbl</span>(<span class="st">&quot;TBL_LIMIT_ORG&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-32" data-line-number="32"><span class="st">  </span>as.h2o -&gt;<span class="st"> </span>df.h2o</a>
<a class="sourceLine" id="cb106-33" data-line-number="33">df.h2o <span class="op">%&gt;%</span><span class="st"> </span>h2o.summary</a>
<a class="sourceLine" id="cb106-34" data-line-number="34"></a>
<a class="sourceLine" id="cb106-35" data-line-number="35"><span class="co">#Connect với Spark</span></a>
<a class="sourceLine" id="cb106-36" data-line-number="36"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb106-37" data-line-number="37"><span class="kw">spark_install</span>(<span class="dt">version =</span> <span class="st">&quot;2.1.0&quot;</span>)</a>
<a class="sourceLine" id="cb106-38" data-line-number="38">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>, <span class="dt">version =</span> <span class="st">&quot;2.1.0&quot;</span>)</a>
<a class="sourceLine" id="cb106-39" data-line-number="39"></a>
<a class="sourceLine" id="cb106-40" data-line-number="40"><span class="co">#Cách 1: Copy từ data frame</span></a>
<a class="sourceLine" id="cb106-41" data-line-number="41"><span class="kw">vp_dbConnect</span>(<span class="st">&quot;DATA&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-42" data-line-number="42"><span class="st">          </span><span class="kw">tbl</span>(<span class="st">&quot;TBL_LIMIT_ORG&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect -&gt;<span class="st"> </span>df</a>
<a class="sourceLine" id="cb106-43" data-line-number="43"><span class="kw">copy_to</span>(sc, df, <span class="dt">overwrite =</span> T) -&gt;<span class="st"> </span>tbl_new</a>
<a class="sourceLine" id="cb106-44" data-line-number="44"></a>
<a class="sourceLine" id="cb106-45" data-line-number="45"><span class="co">#Cách 2: Copy trực tiếp từ tbl_sql</span></a>
<a class="sourceLine" id="cb106-46" data-line-number="46"><span class="kw">vp_dbConnect</span>(<span class="st">&quot;DATA&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-47" data-line-number="47"><span class="st">          </span><span class="kw">tbl</span>(<span class="st">&quot;TBL_LIMIT_ORG&quot;</span>) -&gt;<span class="st"> </span>tbl_sql</a>
<a class="sourceLine" id="cb106-48" data-line-number="48"><span class="kw">copy_to</span>(sc, tbl_sql, <span class="dt">overwrite =</span> T) -&gt;<span class="st"> </span>tbl_new2</a>
<a class="sourceLine" id="cb106-49" data-line-number="49"></a>
<a class="sourceLine" id="cb106-50" data-line-number="50"><span class="co">#So sánh</span></a>
<a class="sourceLine" id="cb106-51" data-line-number="51">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">object.size</span>()</a>
<a class="sourceLine" id="cb106-52" data-line-number="52">tbl_new2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">object.size</span>()</a>
<a class="sourceLine" id="cb106-53" data-line-number="53">tbl_new <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">object.size</span>()</a>
<a class="sourceLine" id="cb106-54" data-line-number="54"></a>
<a class="sourceLine" id="cb106-55" data-line-number="55">tbl_new <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-56" data-line-number="56"><span class="st">  </span><span class="kw">group_by</span>(ACCOUNT) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-57" data-line-number="57"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">no =</span> <span class="kw">max</span>(INTERNAL_AMOUNT)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-58" data-line-number="58"><span class="st">  </span><span class="kw">filter</span>(no <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000000</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-59" data-line-number="59"><span class="st">  </span><span class="kw">arrange</span>(no) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-60" data-line-number="60"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">no =</span> no <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-61" data-line-number="61"><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-62" data-line-number="62"><span class="st">  </span>summary</a>
<a class="sourceLine" id="cb106-63" data-line-number="63">  </a>
<a class="sourceLine" id="cb106-64" data-line-number="64">tbl_sql <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-65" data-line-number="65"><span class="st">  </span><span class="kw">group_by</span>(ACCOUNT) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-66" data-line-number="66"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">no =</span> <span class="kw">max</span>(INTERNAL_AMOUNT)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-67" data-line-number="67"><span class="st">  </span><span class="kw">filter</span>(no <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000000</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-68" data-line-number="68"><span class="st">  </span><span class="kw">arrange</span>(no) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-69" data-line-number="69"><span class="st">  </span><span class="kw">show_query</span>()</a></code></pre></div>
</div>
</div>
<div id="so-b-sql" class="section level2">
<h2><span class="header-section-number">4.2</span> Sơ bộ SQL</h2>
<p>SQL là viết tắt của <em>Structured Language Query</em>, tuy nhiên SQL không chỉ dừng lại ở việc Query mà còn udpate, xóa, thay thế… dữ liệu trong database.</p>
<p>SQL được cấu thành từ 3 bộ phận:</p>
<ul>
<li>Data Manipulation Language (DML): Select, Insert, Update, Delete</li>
<li>Data Definition Language (DDL): Create, Alter, Drop</li>
<li>Data Control Language (DCL): Grant, Revok &amp; Deny</li>
</ul>
<p><strong>Cách viêt comment</strong></p>
<div class="sourceCode" id="cb107"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb107-1" data-line-number="1"><span class="co">/*</span></a>
<a class="sourceLine" id="cb107-2" data-line-number="2"><span class="co">Cách 1: This is </span></a>
<a class="sourceLine" id="cb107-3" data-line-number="3"><span class="co">my block of comment</span></a>
<a class="sourceLine" id="cb107-4" data-line-number="4"><span class="co">*/</span></a>
<a class="sourceLine" id="cb107-5" data-line-number="5"></a>
<a class="sourceLine" id="cb107-6" data-line-number="6"><span class="co">--Cách 2</span></a>
<a class="sourceLine" id="cb107-7" data-line-number="7"><span class="co">--Khó dùng hơn</span></a></code></pre></div>
</div>
<div id="cac-cau-lnh-co-ban-trong-sql" class="section level2">
<h2><span class="header-section-number">4.3</span> Các câu lệnh cơ bản trong SQL</h2>
<div id="ham-select" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Hàm SELECT</h3>
<p><strong>Lưu ý</strong>: Các bảng thường bắt đầu bằng <strong>.dbo</strong>, gọi là <em>schema</em>. Thông thường, schema này là default. Tuy nhiên, nếu DB admin đổi schema, ta cần phải đổi câu lệnh</p>
<ul>
<li>Lấy tất cả các biến</li>
</ul>
<div class="sourceCode" id="cb108"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="co">---Cách 1</span></a>
<a class="sourceLine" id="cb108-2" data-line-number="2"><span class="kw">select</span> * <span class="kw">from</span> AdventureWorksDW2012.dbo.DimCustomer</a>
<a class="sourceLine" id="cb108-3" data-line-number="3"><span class="co">---Cách 2</span></a>
<a class="sourceLine" id="cb108-4" data-line-number="4"><span class="kw">select</span> * <span class="kw">from</span> AdventureWorksDW2012..DimCustomer</a>
<a class="sourceLine" id="cb108-5" data-line-number="5"></a>
<a class="sourceLine" id="cb108-6" data-line-number="6"><span class="co">---Cách 3: Khai báo DB với use</span></a>
<a class="sourceLine" id="cb108-7" data-line-number="7"><span class="kw">use</span> AdventureWorksDW2012</a>
<a class="sourceLine" id="cb108-8" data-line-number="8"><span class="kw">select</span> * <span class="kw">from</span> DimCustomer</a></code></pre></div>
<ul>
<li>Lấy top n dòng đầu tiên hoặc n phần trăm đầu tiên</li>
</ul>
<div class="sourceCode" id="cb109"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb109-1" data-line-number="1"> <span class="kw">select</span> top <span class="dv">5</span> * <span class="kw">from</span> learnsql.dbo.product</a>
<a class="sourceLine" id="cb109-2" data-line-number="2"> <span class="kw">select</span> top <span class="dv">50</span> <span class="kw">percent</span> * <span class="kw">from</span> learnsql.dbo.product</a></code></pre></div>
<ul>
<li>Lấy một vài biến</li>
</ul>
<div class="sourceCode" id="cb110"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb110-1" data-line-number="1"><span class="co">--Cách 1</span></a>
<a class="sourceLine" id="cb110-2" data-line-number="2"><span class="kw">select</span> Product_CD, Date_offered <span class="kw">from</span> learnsql.dbo.product</a>
<a class="sourceLine" id="cb110-3" data-line-number="3"></a>
<a class="sourceLine" id="cb110-4" data-line-number="4"><span class="co">-- Cách 2</span></a>
<a class="sourceLine" id="cb110-5" data-line-number="5"><span class="kw">select</span> A.Product_CD, A.Date_offered </a>
<a class="sourceLine" id="cb110-6" data-line-number="6">        <span class="kw">from</span> learnsql.dbo.product A</a>
<a class="sourceLine" id="cb110-7" data-line-number="7">        </a>
<a class="sourceLine" id="cb110-8" data-line-number="8"><span class="co">-- Cách 3: Dùng Aliases</span></a>
<a class="sourceLine" id="cb110-9" data-line-number="9"><span class="kw">select</span> Product_CD <span class="kw">as</span> [Product <span class="kw">new</span> CD] <span class="kw">from</span> learnsql.dbo.product</a></code></pre></div>
<p><strong>Lưu ý</strong>: Đặt tên bảng là A trong cách thứ 2 giúp ích khi lấy dữ liệu và nhóm các giá trị từ nhiều bảng</p>
<ul>
<li>Ghép kết quả</li>
</ul>
<div class="sourceCode" id="cb111"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb111-1" data-line-number="1"><span class="co">--- TH1: Cùng kiểu dữ liệu nvarchar</span></a>
<a class="sourceLine" id="cb111-2" data-line-number="2"><span class="kw">select</span> firstname + <span class="st">&#39;,&#39;</span> + lastname <span class="kw">as</span> [FULL_NAME] <span class="kw">from</span> dimcustomer</a>
<a class="sourceLine" id="cb111-3" data-line-number="3"></a>
<a class="sourceLine" id="cb111-4" data-line-number="4"><span class="co">--- TH2: nvarchar với numeric</span></a>
<a class="sourceLine" id="cb111-5" data-line-number="5"><span class="co">--- Dùng cast</span></a>
<a class="sourceLine" id="cb111-6" data-line-number="6"></a>
<a class="sourceLine" id="cb111-7" data-line-number="7"><span class="kw">select</span> lastname + <span class="st">&#39; &#39;</span> + <span class="fu">cast</span>(customerkey <span class="kw">as</span> <span class="dt">nvarchar</span>) <span class="kw">as</span> [Name <span class="kw">ID</span>]</a>
<a class="sourceLine" id="cb111-8" data-line-number="8"><span class="kw">from</span> dimcustomer</a>
<a class="sourceLine" id="cb111-9" data-line-number="9"></a>
<a class="sourceLine" id="cb111-10" data-line-number="10"><span class="co">--- Dùng convert</span></a>
<a class="sourceLine" id="cb111-11" data-line-number="11"><span class="kw">select</span> lastname + <span class="st">&#39; &#39;</span> + <span class="fu">convert</span>(<span class="dt">nvarchar</span>, customerkey) <span class="kw">as</span> [Name <span class="kw">ID</span>]</a>
<a class="sourceLine" id="cb111-12" data-line-number="12"><span class="kw">from</span> DimCustomer</a></code></pre></div>
<ul>
<li>Lấy các giá trị không trùng lặp: dùng hàm distinct</li>
</ul>
<div class="sourceCode" id="cb112"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb112-1" data-line-number="1"><span class="kw">Select</span> <span class="kw">Distinct</span> Pro.Product_Type_Cd <span class="kw">from</span> db.Product Pro;</a></code></pre></div>
<div id="format-date" class="section level4">
<h4><span class="header-section-number">4.3.1.1</span> Format date</h4>
<p>3 loại định dạng cơ bản: 101 (mm/dd/yyyy), 102 (mm/dd/yy), 103 (dd/mm/yyyy)</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb113-1" data-line-number="1"><span class="kw">select</span> <span class="fu">convert</span>(<span class="dt">varchar</span>,birthdate,<span class="dv">101</span>) <span class="kw">as</span> Date1,</a>
<a class="sourceLine" id="cb113-2" data-line-number="2">       <span class="fu">convert</span>(<span class="dt">varchar</span>, BirthDate, <span class="dv">102</span>) <span class="kw">as</span> Date2,</a>
<a class="sourceLine" id="cb113-3" data-line-number="3">       <span class="fu">convert</span>(<span class="dt">varchar</span>, birthdate, <span class="dv">103</span>) <span class="kw">as</span> Date3</a>
<a class="sourceLine" id="cb113-4" data-line-number="4"> <span class="kw">from</span> dimcustomer</a></code></pre></div>
</div>
<div id="x-ly-null" class="section level4">
<h4><span class="header-section-number">4.3.1.2</span> Xử lý null</h4>
<ul>
<li>Khi concanate 2 string, 1 string là NULL, SQL sẽ trả ra kết quả NULL (không như R, tự động loại NA)</li>
</ul>
<div class="sourceCode" id="cb114"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb114-1" data-line-number="1"><span class="co">--- Dữ liệu gốc</span></a>
<a class="sourceLine" id="cb114-2" data-line-number="2"><span class="kw">select</span> firstname, middlename, lastname <span class="kw">from</span> DimCustomer</a>
<a class="sourceLine" id="cb114-3" data-line-number="3"></a>
<a class="sourceLine" id="cb114-4" data-line-number="4"><span class="co">--- Giá trị NULL</span></a>
<a class="sourceLine" id="cb114-5" data-line-number="5"><span class="kw">select</span> firstname + <span class="st">&#39; &#39;</span> + middlename + <span class="st">&#39; &#39;</span> + lastname <span class="kw">as</span> [<span class="kw">Full</span> Name]</a>
<a class="sourceLine" id="cb114-6" data-line-number="6"><span class="kw">from</span> dimcustomer</a>
<a class="sourceLine" id="cb114-7" data-line-number="7"></a>
<a class="sourceLine" id="cb114-8" data-line-number="8"><span class="co">--- Xử lý cách 1: Dùng ISNULL</span></a>
<a class="sourceLine" id="cb114-9" data-line-number="9"><span class="kw">select</span> firstname + <span class="st">&#39; &#39;</span> + isnull(middlename,<span class="st">&#39;&#39;</span>) + <span class="st">&#39; &#39;</span> + lastname</a>
<a class="sourceLine" id="cb114-10" data-line-number="10"><span class="kw">as</span> [<span class="kw">Full</span> Name] <span class="kw">from</span> dimcustomer</a>
<a class="sourceLine" id="cb114-11" data-line-number="11"></a>
<a class="sourceLine" id="cb114-12" data-line-number="12"><span class="co">--- Xử lý cách 2: Dùng CASE WHEN</span></a>
<a class="sourceLine" id="cb114-13" data-line-number="13"><span class="kw">select</span> firstname + <span class="st">&#39; &#39;</span> +</a>
<a class="sourceLine" id="cb114-14" data-line-number="14"><span class="kw">case</span></a>
<a class="sourceLine" id="cb114-15" data-line-number="15"><span class="kw">when</span> middlename <span class="kw">is</span> <span class="kw">null</span> <span class="kw">then</span> <span class="st">&#39;&#39;</span></a>
<a class="sourceLine" id="cb114-16" data-line-number="16"><span class="kw">else</span> middlename + <span class="st">&#39; &#39;</span></a>
<a class="sourceLine" id="cb114-17" data-line-number="17"><span class="kw">end</span></a>
<a class="sourceLine" id="cb114-18" data-line-number="18">+ lastname <span class="kw">as</span> [<span class="kw">Full</span> Name] <span class="kw">from</span> dimcustomer</a>
<a class="sourceLine" id="cb114-19" data-line-number="19"></a>
<a class="sourceLine" id="cb114-20" data-line-number="20">- Xử lý cách <span class="dv">3</span>: Dùng <span class="kw">Coalesce</span></a>
<a class="sourceLine" id="cb114-21" data-line-number="21"><span class="kw">select</span> <span class="kw">coalesce</span>(firstname + <span class="st">&#39; &#39;</span> + middlename + <span class="st">&#39; &#39;</span> +lastname,</a>
<a class="sourceLine" id="cb114-22" data-line-number="22">firstname + <span class="st">&#39; &#39;</span> +lastname) <span class="kw">as</span> [<span class="kw">Full</span> Name] <span class="kw">from</span> dimcustomer</a></code></pre></div>
</div>
<div id="case-when" class="section level4">
<h4><span class="header-section-number">4.3.1.3</span> CASE WHEN</h4>
<div class="sourceCode" id="cb115"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb115-1" data-line-number="1"><span class="kw">select</span> AVAIL_BALANCE,</a>
<a class="sourceLine" id="cb115-2" data-line-number="2">(<span class="kw">CASE</span>  <span class="kw">when</span> AVAIL_BALANCE &lt; <span class="dv">5000</span> <span class="kw">then</span> N<span class="st">&#39;small&#39;</span></a>
<a class="sourceLine" id="cb115-3" data-line-number="3">      <span class="kw">when</span> AVAIL_BALANCE &gt;= <span class="dv">5000</span> <span class="kw">AND</span> AVAIL_BALANCE &lt;= <span class="dv">10000</span> <span class="kw">then</span> N<span class="st">&#39;medium&#39;</span></a>
<a class="sourceLine" id="cb115-4" data-line-number="4">      <span class="kw">else</span> N<span class="st">&#39;high&#39;</span></a>
<a class="sourceLine" id="cb115-5" data-line-number="5">      <span class="kw">END</span>) <span class="kw">as</span> <span class="kw">category</span>  </a>
<a class="sourceLine" id="cb115-6" data-line-number="6"><span class="kw">from</span> <span class="kw">account</span></a></code></pre></div>
<p><strong>Lưu ý</strong>:</p>
<ul>
<li>N trong câu lệnh trên viết tắt của NVARCHAR để khai báo dạng lệnh</li>
</ul>
</div>
</div>
<div id="cau-lnh-where" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Câu lệnh where</h3>
<ul>
<li><strong>Where</strong>: Tìm điều kiện theo dòng</li>
</ul>
<div class="sourceCode" id="cb116"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb116-1" data-line-number="1"><span class="kw">Select</span> * <span class="kw">From</span> </a>
<a class="sourceLine" id="cb116-2" data-line-number="2">      learnsql.dbo.Product Pro </a>
<a class="sourceLine" id="cb116-3" data-line-number="3">      <span class="kw">Where</span> Pro.Product_Type_Cd = <span class="st">&#39;LOAN&#39;</span>  </a>
<a class="sourceLine" id="cb116-4" data-line-number="4"></a>
<a class="sourceLine" id="cb116-5" data-line-number="5"><span class="co">--- Dấu khác      </span></a>
<a class="sourceLine" id="cb116-6" data-line-number="6"><span class="kw">Select</span> * <span class="kw">From</span> </a>
<a class="sourceLine" id="cb116-7" data-line-number="7">      learnsql.dbo.Product Pro </a>
<a class="sourceLine" id="cb116-8" data-line-number="8">      <span class="kw">Where</span> Pro.Product_Type_Cd &lt;&gt; <span class="st">&#39;LOAN&#39;</span>        </a></code></pre></div>
<ul>
<li>IN</li>
</ul>
<div class="sourceCode" id="cb117"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb117-1" data-line-number="1"><span class="co">--Lựa chọn nhiều điều kiện</span></a>
<a class="sourceLine" id="cb117-2" data-line-number="2"><span class="kw">Select</span> Emp.Emp_Id</a>
<a class="sourceLine" id="cb117-3" data-line-number="3">     ,Emp.First_Name</a>
<a class="sourceLine" id="cb117-4" data-line-number="4">     ,Emp.Last_Name</a>
<a class="sourceLine" id="cb117-5" data-line-number="5">     ,Emp.Dept_Id</a>
<a class="sourceLine" id="cb117-6" data-line-number="6">    <span class="kw">From</span>  learnsql.dbo.Employee Emp</a>
<a class="sourceLine" id="cb117-7" data-line-number="7">    <span class="kw">Where</span>  Emp.First_Name <span class="kw">In</span> (<span class="st">&#39;Susan&#39;</span>,<span class="st">&#39;Paula&#39;</span>) <span class="kw">OR</span></a>
<a class="sourceLine" id="cb117-8" data-line-number="8">           (Emp.Last_Name <span class="kw">not</span> <span class="kw">In</span> (<span class="st">&#39;Fleming&#39;</span>, <span class="st">&#39;Roberts&#39;</span>) <span class="kw">AND</span> </a>
<a class="sourceLine" id="cb117-9" data-line-number="9">           Emp.Emp_Id = <span class="st">&#39;6&#39;</span>)</a></code></pre></div>
<p><strong>Lưu ý</strong>: Toán tử IN trong SQL tương tự như %in% trong R</p>
<ul>
<li>Kết hợp toán tử AND, OR</li>
</ul>
<div class="sourceCode" id="cb118"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb118-1" data-line-number="1"><span class="kw">Select</span> * <span class="kw">From</span> </a>
<a class="sourceLine" id="cb118-2" data-line-number="2">      learnsql.dbo.Product Pro </a>
<a class="sourceLine" id="cb118-3" data-line-number="3">      <span class="kw">Where</span> (Pro.Product_Type_Cd = <span class="st">&#39;LOAN&#39;</span> <span class="kw">AND</span> </a>
<a class="sourceLine" id="cb118-4" data-line-number="4">      Pro.Product_CD = <span class="st">&#39;AUT&#39;</span>) <span class="kw">OR</span></a>
<a class="sourceLine" id="cb118-5" data-line-number="5">      (Pro.NAME <span class="kw">like</span> <span class="st">&#39;%dep%&#39;</span>)</a></code></pre></div>
<ul>
<li>Truy vấn đồng thời tính toán trong SQL</li>
</ul>
<div class="sourceCode" id="cb119"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb119-1" data-line-number="1"><span class="co">--Lưu ý: Để phép toán cần tính trong dấu ngoặc đơn</span></a>
<a class="sourceLine" id="cb119-2" data-line-number="2"><span class="co">--DUC_ANH là tên biến mới sau khi biến đổi</span></a>
<a class="sourceLine" id="cb119-3" data-line-number="3"><span class="kw">SELECT</span> top <span class="dv">10</span> [BUSINESS_DATE]</a>
<a class="sourceLine" id="cb119-4" data-line-number="4">      ,[ACNT_CONTRACT_ID]</a>
<a class="sourceLine" id="cb119-5" data-line-number="5">      ,[CARD_STATUS]</a>
<a class="sourceLine" id="cb119-6" data-line-number="6">      ,([CARD_LIMIT] + <span class="dv">10000</span>)/<span class="dv">30</span> <span class="kw">as</span> DUC_ANH</a>
<a class="sourceLine" id="cb119-7" data-line-number="7">      ,[BALANCE]</a>
<a class="sourceLine" id="cb119-8" data-line-number="8">      ,[T24_CIF]</a>
<a class="sourceLine" id="cb119-9" data-line-number="9">      ,[CUSTOMER_NAME]</a>
<a class="sourceLine" id="cb119-10" data-line-number="10">  <span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[CARD_HIS]</a>
<a class="sourceLine" id="cb119-11" data-line-number="11">  <span class="kw">where</span> customer_name <span class="kw">like</span> <span class="st">&#39;%ANH&#39;</span></a></code></pre></div>
<p><strong>Lưu ý</strong>:</p>
<ul>
<li>Để phân biệt tên của các cột trong bảng với các điều kiện có thể bị trùng. VD: Tên bảng là <strong>OR</strong> dễ bị trùng với điều kiện OR, ta đặt tên bảng, tên DB trong dấu ngoặc vuông</li>
<li>Các phép toán thường gặp =,&lt;, &gt;, &gt;=, &lt;=, IN, &lt;&gt;, is not null</li>
<li>Các toán tử với <strong>Wild Card</strong>: LIKE, NOT LIKE
<ul>
<li>Ký tự <strong>%ANH</strong>: tìm các character bắt đầu bằng bất cứ thứ gì nhưng sau đó đi kèm chuỗi ký tự ANH</li>
<li>Ký tự **_** (underscore): tìm các ký tự đơn.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb120"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb120-1" data-line-number="1"><span class="kw">SELECT</span> top <span class="dv">10</span> [BUSINESS_DATE]</a>
<a class="sourceLine" id="cb120-2" data-line-number="2">      ,[CUSTOMER_NAME]</a>
<a class="sourceLine" id="cb120-3" data-line-number="3">  <span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[CARD_HIS]</a>
<a class="sourceLine" id="cb120-4" data-line-number="4">  <span class="kw">where</span> customer_name <span class="kw">like</span> <span class="st">&#39;%ANH&#39;</span> <span class="kw">OR</span></a>
<a class="sourceLine" id="cb120-5" data-line-number="5">  customer_name <span class="kw">like</span> <span class="st">&#39;A_H&#39;</span> <span class="kw">and</span></a>
<a class="sourceLine" id="cb120-6" data-line-number="6">  card_status <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span></a></code></pre></div>
<ul>
<li><strong>Having</strong>: Tìm điều kiện sau khi có kết quả. Lưu ý: Câu lệnh Having không hoạt động với ALIAS, phải hiển thị điều kiện từ bảng gốc</li>
</ul>
<div class="sourceCode" id="cb121"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb121-1" data-line-number="1"><span class="kw">select</span> </a>
<a class="sourceLine" id="cb121-2" data-line-number="2"> OPEN_BRANCH_ID</a>
<a class="sourceLine" id="cb121-3" data-line-number="3">,<span class="fu">sum</span>(AVAIL_BALANCE) <span class="kw">as</span> <span class="kw">new</span></a>
<a class="sourceLine" id="cb121-4" data-line-number="4"><span class="kw">from</span> <span class="kw">account</span></a>
<a class="sourceLine" id="cb121-5" data-line-number="5"><span class="kw">group</span> <span class="kw">by</span> OPEN_BRANCH_ID </a>
<a class="sourceLine" id="cb121-6" data-line-number="6"><span class="kw">having</span> <span class="fu">sum</span>(AVAIL_BALANCE) &gt;= <span class="dv">500000</span></a>
<a class="sourceLine" id="cb121-7" data-line-number="7"></a>
<a class="sourceLine" id="cb121-8" data-line-number="8"><span class="co">-- Câu lệnh sau sẽ không chạy với where</span></a>
<a class="sourceLine" id="cb121-9" data-line-number="9"></a>
<a class="sourceLine" id="cb121-10" data-line-number="10"><span class="kw">select</span> </a>
<a class="sourceLine" id="cb121-11" data-line-number="11"> OPEN_BRANCH_ID</a>
<a class="sourceLine" id="cb121-12" data-line-number="12">,<span class="fu">sum</span>(AVAIL_BALANCE) <span class="kw">as</span> <span class="kw">new</span></a>
<a class="sourceLine" id="cb121-13" data-line-number="13"><span class="kw">where</span> <span class="fu">sum</span>(AVAIL_BALANCE) &gt;= <span class="dv">500000</span></a>
<a class="sourceLine" id="cb121-14" data-line-number="14"><span class="kw">from</span> <span class="kw">account</span></a>
<a class="sourceLine" id="cb121-15" data-line-number="15"><span class="kw">group</span> <span class="kw">by</span> OPEN_BRANCH_ID </a></code></pre></div>
<p><strong>Lưu ý</strong>: Ký tự trong SQL cần đặt trong 1 dấu nháy đơn ’’</p>
<ul>
<li>Có thể sử dụng các phép toán đơn giản trong WHERE</li>
</ul>
<div class="sourceCode" id="cb122"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="kw">select</span> * <span class="kw">from</span> <span class="kw">ACCOUNT</span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2"><span class="kw">where</span> AVAIL_BALANCE + <span class="dv">30</span> &lt;= <span class="dv">6000</span></a></code></pre></div>
<p><strong>UNION vs. UNION ALL</strong></p>
<ul>
<li>UNION: Loại bỏ các giá trị trùng của các dòng</li>
<li>UNION ALL: Hiển thị tất cả các giá trị</li>
</ul>
<div class="sourceCode" id="cb123"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb123-1" data-line-number="1">  (<span class="kw">SELECT</span> top <span class="dv">10</span> </a>
<a class="sourceLine" id="cb123-2" data-line-number="2">  [CUSTOMER_NAME]</a>
<a class="sourceLine" id="cb123-3" data-line-number="3">  <span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[CARD_HIS]</a>
<a class="sourceLine" id="cb123-4" data-line-number="4">  <span class="kw">where</span> [CUSTOMER_NAME] <span class="kw">like</span> <span class="st">&#39;%HƯƠNG&#39;</span>)</a>
<a class="sourceLine" id="cb123-5" data-line-number="5">  <span class="kw">UNION</span> <span class="kw">ALL</span></a>
<a class="sourceLine" id="cb123-6" data-line-number="6">  <span class="kw">SELECT</span> top <span class="dv">10</span> </a>
<a class="sourceLine" id="cb123-7" data-line-number="7">  [CUSTOMER_NAME]</a>
<a class="sourceLine" id="cb123-8" data-line-number="8">  <span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[BALANCE_HIS]</a>
<a class="sourceLine" id="cb123-9" data-line-number="9">  <span class="kw">where</span> [CUSTOMER_NAME] <span class="kw">like</span> <span class="st">&#39;%HƯƠNG&#39;</span></a></code></pre></div>
</div>
<div id="cac-phep-tinh-aggregation" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Các phép tính aggregation</h3>
<ul>
<li>Các phép tính: COUNT, AGV, MIN, MAX, VARIANCE, STDDEV</li>
</ul>
<div class="sourceCode" id="cb124"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb124-1" data-line-number="1"> <span class="kw">select</span> <span class="fu">count</span>(AMOUNT) <span class="kw">as</span> n</a>
<a class="sourceLine" id="cb124-2" data-line-number="2"> , <span class="fu">max</span>(amount) <span class="kw">as</span> <span class="fu">max</span></a>
<a class="sourceLine" id="cb124-3" data-line-number="3"> , <span class="fu">min</span>(amount) <span class="kw">as</span> <span class="fu">min</span></a>
<a class="sourceLine" id="cb124-4" data-line-number="4"> , <span class="fu">sum</span>(amount) <span class="kw">as</span> <span class="fu">sum</span></a>
<a class="sourceLine" id="cb124-5" data-line-number="5"> , var(amount) <span class="kw">as</span> var</a>
<a class="sourceLine" id="cb124-6" data-line-number="6"> , STDEV(amount) <span class="kw">as</span> std_dev</a>
<a class="sourceLine" id="cb124-7" data-line-number="7"> <span class="kw">from</span> [learnsql].[dbo].[ACC_TRANSACTION]</a></code></pre></div>
</div>
<div id="cac-phep-tinh-toan-co-ban" class="section level3">
<h3><span class="header-section-number">4.3.4</span> Các phép tính toán cơ bản</h3>
<ul>
<li>FLOOR: Trả số nguyên lớn nhất nhỏ hơn số đã có</li>
<li>CEILING: trả số nguyên nhỏ nhất lớn hơn số đã có</li>
<li>ABS: Trả giá trị tuyệt đối</li>
<li>Các hàm khác: LN, LOG, EXP, POWER</li>
</ul>
<div class="sourceCode" id="cb125"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb125-1" data-line-number="1"><span class="kw">select</span> CEILING(<span class="fl">5.3</span>)</a>
<a class="sourceLine" id="cb125-2" data-line-number="2"><span class="kw">select</span> <span class="fu">floor</span>(<span class="fl">5.3</span>)</a>
<a class="sourceLine" id="cb125-3" data-line-number="3"><span class="kw">select</span> <span class="fu">abs</span>(-<span class="fl">5.3</span>)</a>
<a class="sourceLine" id="cb125-4" data-line-number="4"><span class="kw">select</span> <span class="fu">power</span>(<span class="dv">4</span>,<span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="cac-phep-tinh-vi-string" class="section level3">
<h3><span class="header-section-number">4.3.5</span> Các phép tính với string</h3>
<ul>
<li>CONCAT: Nối các string, tương tự như <strong>paste0</strong> trong R</li>
<li>LOWER, UPPER: Viết hoa, viết thường các biến</li>
</ul>
<div class="sourceCode" id="cb126"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb126-1" data-line-number="1">  <span class="kw">SELECT</span> top <span class="dv">10</span> </a>
<a class="sourceLine" id="cb126-2" data-line-number="2">        [<span class="kw">ID</span>]</a>
<a class="sourceLine" id="cb126-3" data-line-number="3">   ,[BUSINESS_DATE]</a>
<a class="sourceLine" id="cb126-4" data-line-number="4">   ,<span class="fu">LOWER</span>([CUSTOMER_NAME])</a>
<a class="sourceLine" id="cb126-5" data-line-number="5">     , <span class="fu">CONCAT</span>(CUSTOMER_NAME, <span class="st">&#39;_&#39;</span>, <span class="kw">ID</span>) <span class="kw">as</span> new_var</a>
<a class="sourceLine" id="cb126-6" data-line-number="6">  <span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[BALANCE_HIS]</a>
<a class="sourceLine" id="cb126-7" data-line-number="7">  <span class="kw">where</span> customer_name <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span></a></code></pre></div>
<ul>
<li>REPLACE: Thay thế các ký tự trong biến</li>
</ul>
<div class="sourceCode" id="cb127"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb127-1" data-line-number="1"><span class="kw">SELECT</span> top <span class="dv">10</span> </a>
<a class="sourceLine" id="cb127-2" data-line-number="2">     [<span class="kw">ID</span>]</a>
<a class="sourceLine" id="cb127-3" data-line-number="3">  ,[CUSTOMER_NAME] </a>
<a class="sourceLine" id="cb127-4" data-line-number="4">    ,<span class="kw">REPLACE</span>(CUSTOMER_NAME, <span class="st">&#39;THI&#39;</span>, <span class="st">&#39;***&#39;</span>) <span class="kw">as</span> new_name</a>
<a class="sourceLine" id="cb127-5" data-line-number="5"><span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[BALANCE_HIS]</a>
<a class="sourceLine" id="cb127-6" data-line-number="6"><span class="kw">where</span> customer_name <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span></a></code></pre></div>
<ul>
<li>SUBSTRING(var, a, b): Hiển thị b ký tự từ ký tự thứ a của var</li>
</ul>
<div class="sourceCode" id="cb128"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb128-1" data-line-number="1"> <span class="kw">SELECT</span> top <span class="dv">10</span> </a>
<a class="sourceLine" id="cb128-2" data-line-number="2">    CUSTOMER_NAME</a>
<a class="sourceLine" id="cb128-3" data-line-number="3">    ,substring(CUSTOMER_NAME, <span class="dv">2</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb128-4" data-line-number="4"><span class="kw">FROM</span> [SERVER74].[BICDATA].[dbo].[BALANCE_HIS]</a>
<a class="sourceLine" id="cb128-5" data-line-number="5">  <span class="kw">where</span> customer_name <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span></a></code></pre></div>
</div>
<div id="join-cac-bang" class="section level3">
<h3><span class="header-section-number">4.3.6</span> Join các bảng</h3>
<ul>
<li><strong>Trường hợp 1 - Select tất cả các dòng không theo điều kiện</strong>: SQL sẽ nối mỗi dòng ở bảng 1 với mỗi dòng ở bảng 2. Tổng số dòng trong bảng mới sẽ là m*n dòng (m dòng ở bảng 1 và n dòng ở bảng 2)</li>
</ul>
<div class="sourceCode" id="cb129"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb129-1" data-line-number="1"><span class="co">--Trường hợp 1: Không có where</span></a>
<a class="sourceLine" id="cb129-2" data-line-number="2"><span class="kw">select</span> </a>
<a class="sourceLine" id="cb129-3" data-line-number="3">A.ACCOUNT_ID, A.AVAIL_BALANCE,</a>
<a class="sourceLine" id="cb129-4" data-line-number="4">B.ADDRESS, B.CITY </a>
<a class="sourceLine" id="cb129-5" data-line-number="5"><span class="kw">from</span></a>
<a class="sourceLine" id="cb129-6" data-line-number="6">[learnsql].[dbo].[<span class="kw">ACCOUNT</span>] A, [learnsql].[dbo].[CUSTOMER] B</a>
<a class="sourceLine" id="cb129-7" data-line-number="7"><span class="kw">order</span> <span class="kw">by</span> B.CITY</a>
<a class="sourceLine" id="cb129-8" data-line-number="8"></a>
<a class="sourceLine" id="cb129-9" data-line-number="9"><span class="co">--Trường hợp 2: Sử dụng where</span></a>
<a class="sourceLine" id="cb129-10" data-line-number="10"><span class="kw">select</span> </a>
<a class="sourceLine" id="cb129-11" data-line-number="11">A.ACCOUNT_ID, A.AVAIL_BALANCE,</a>
<a class="sourceLine" id="cb129-12" data-line-number="12">B.ADDRESS, B.CITY </a>
<a class="sourceLine" id="cb129-13" data-line-number="13"><span class="kw">from</span></a>
<a class="sourceLine" id="cb129-14" data-line-number="14">[learnsql].[dbo].[<span class="kw">ACCOUNT</span>] A, [learnsql].[dbo].[CUSTOMER] B</a>
<a class="sourceLine" id="cb129-15" data-line-number="15"><span class="kw">where</span> A.ACCOUNT_ID &gt; B.CUST_ID <span class="kw">and</span> city = <span class="st">&#39;Woburn&#39;</span></a>
<a class="sourceLine" id="cb129-16" data-line-number="16"><span class="kw">order</span> <span class="kw">by</span> AVAIL_BALANCE</a></code></pre></div>
<ul>
<li><strong>Trường hợp 2 - Left join, right join</strong>: Các cột từ các bảng khác nhau thì cần phải xác định alias</li>
</ul>
<div class="sourceCode" id="cb130"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb130-1" data-line-number="1">  <span class="kw">select</span> </a>
<a class="sourceLine" id="cb130-2" data-line-number="2">  B.BRANCH_ID, B.ADDRESS, B.CITY, B.NAME,</a>
<a class="sourceLine" id="cb130-3" data-line-number="3">  A.ACCOUNT_ID, A.AVAIL_BALANCE</a>
<a class="sourceLine" id="cb130-4" data-line-number="4">  <span class="kw">from</span> branch B</a>
<a class="sourceLine" id="cb130-5" data-line-number="5">  <span class="kw">left</span> <span class="kw">outer</span> <span class="kw">join</span> <span class="kw">account</span> A</a>
<a class="sourceLine" id="cb130-6" data-line-number="6">  <span class="kw">on</span> B.BRANCH_ID = A.OPEN_BRANCH_ID</a>
<a class="sourceLine" id="cb130-7" data-line-number="7">  <span class="kw">where</span> BRANCH_ID = <span class="st">&#39;2&#39;</span></a></code></pre></div>
<ul>
<li>Lưu ý: Khi câu lệnh bị lỗi Ambiguity, nguyên nhân có thể là do key nối các bảng lại bị trùng với cột khi truy vấn</li>
</ul>
<div class="sourceCode" id="cb131"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb131-1" data-line-number="1"><span class="co">---Trường hợp 1: Không hoạt động</span></a>
<a class="sourceLine" id="cb131-2" data-line-number="2"><span class="kw">select</span> EnglishProductName, EnglishProductSubcategoryName,</a>
<a class="sourceLine" id="cb131-3" data-line-number="3">ProductSubcategoryKey <span class="kw">from</span> DimProduct <span class="kw">as</span> P <span class="kw">inner</span> <span class="kw">join</span></a>
<a class="sourceLine" id="cb131-4" data-line-number="4">DimProductSubcategory <span class="kw">as</span> S</a>
<a class="sourceLine" id="cb131-5" data-line-number="5"><span class="kw">on</span> P.ProductSubcategoryKey = S.ProductSubcategoryKey</a>
<a class="sourceLine" id="cb131-6" data-line-number="6"></a>
<a class="sourceLine" id="cb131-7" data-line-number="7"><span class="co">---Trường hợp 2: Hoạt động, sau khi đưa alias</span></a>
<a class="sourceLine" id="cb131-8" data-line-number="8"><span class="kw">select</span> EnglishProductName, EnglishProductSubcategoryName,</a>
<a class="sourceLine" id="cb131-9" data-line-number="9">S.ProductSubcategoryKey <span class="kw">from</span> DimProduct <span class="kw">as</span> P <span class="kw">inner</span> <span class="kw">join</span></a>
<a class="sourceLine" id="cb131-10" data-line-number="10">DimProductSubcategory <span class="kw">as</span> S</a>
<a class="sourceLine" id="cb131-11" data-line-number="11"><span class="kw">on</span> P.ProductSubcategoryKey = S.ProductSubcategoryKey</a></code></pre></div>
<ul>
<li><strong>Trường hợp 3: Inner join</strong></li>
</ul>
<div class="sourceCode" id="cb132"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb132-1" data-line-number="1"><span class="kw">select</span> EnglishProductName, </a>
<a class="sourceLine" id="cb132-2" data-line-number="2">  EnglishProductSubcategoryName</a>
<a class="sourceLine" id="cb132-3" data-line-number="3">  ,EnglishProductCategoryName </a>
<a class="sourceLine" id="cb132-4" data-line-number="4"><span class="kw">from</span> DimProduct <span class="kw">as</span> P <span class="kw">inner</span> <span class="kw">join</span></a>
<a class="sourceLine" id="cb132-5" data-line-number="5">  DimProductSubcategory <span class="kw">as</span> S</a>
<a class="sourceLine" id="cb132-6" data-line-number="6">  <span class="kw">on</span> P.ProductSubcategoryKey = S.ProductSubcategoryKey</a>
<a class="sourceLine" id="cb132-7" data-line-number="7"><span class="kw">inner</span> <span class="kw">join</span> DimProductCategory <span class="kw">as</span> C</a>
<a class="sourceLine" id="cb132-8" data-line-number="8">  <span class="kw">on</span> S.ProductCategoryKey = C.ProductCategoryKey</a>
<a class="sourceLine" id="cb132-9" data-line-number="9"><span class="kw">where</span> EnglishProductName <span class="kw">like</span> <span class="st">&#39;%HL%&#39;</span></a></code></pre></div>
</div>
</div>
<div id="sub-query" class="section level2">
<h2><span class="header-section-number">4.4</span> Sub Query</h2>
<div id="sub-query-thong-thung" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Sub query thông thường</h3>
<p>Sub query thường được sử dụng sau điều kiện WHERE khi lọc điều kiện giữa nhiều bảng. Phần sub-queries được gọi là inner query. Xem lưu đồ dưới đây:</p>
<p><img src="Images/Plot1.gif" /></p>
<ul>
<li><strong>Trưởng hợp 1</strong>: Subquery sau WHERE</li>
</ul>
<div class="sourceCode" id="cb133"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb133-1" data-line-number="1"></a>
<a class="sourceLine" id="cb133-2" data-line-number="2"><span class="co">--Biến thể 1</span></a>
<a class="sourceLine" id="cb133-3" data-line-number="3">  <span class="kw">select</span> a.TXN_ID, a.AMOUNT , b.AVAIL_BALANCE</a>
<a class="sourceLine" id="cb133-4" data-line-number="4">  <span class="kw">from</span> [learnsql].[dbo].[ACC_TRANSACTION] a,</a>
<a class="sourceLine" id="cb133-5" data-line-number="5">        [learnsql].[dbo].[<span class="kw">ACCOUNT</span>] b</a>
<a class="sourceLine" id="cb133-6" data-line-number="6">  <span class="kw">where</span> a.TXN_ID &gt;= </a>
<a class="sourceLine" id="cb133-7" data-line-number="7">  (<span class="kw">select</span> (<span class="fu">max</span>(ACCOUNT_ID)-<span class="dv">3</span>)/<span class="dv">5</span> <span class="kw">from</span> [learnsql].[dbo].[<span class="kw">ACCOUNT</span>])</a>
<a class="sourceLine" id="cb133-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb133-9" data-line-number="9"><span class="co">--Biến thể 2</span></a>
<a class="sourceLine" id="cb133-10" data-line-number="10">  <span class="kw">select</span> a.TXN_ID, a.AMOUNT , b.AVAIL_BALANCE</a>
<a class="sourceLine" id="cb133-11" data-line-number="11">  <span class="kw">from</span> [learnsql].[dbo].[ACC_TRANSACTION] a,</a>
<a class="sourceLine" id="cb133-12" data-line-number="12">        [learnsql].[dbo].[<span class="kw">ACCOUNT</span>] b</a>
<a class="sourceLine" id="cb133-13" data-line-number="13">  <span class="kw">where</span> a.TXN_ID <span class="kw">in</span> </a>
<a class="sourceLine" id="cb133-14" data-line-number="14"> (<span class="kw">select</span> ACCOUNT_ID <span class="kw">from</span> [learnsql].[dbo].[<span class="kw">ACCOUNT</span>])</a></code></pre></div>
<ul>
<li><strong>Trường hợp 2</strong>: Subquery sau from</li>
</ul>
<div class="sourceCode" id="cb134"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb134-1" data-line-number="1"><span class="kw">select</span> <span class="fu">min</span>(a.amount) <span class="kw">as</span> <span class="fu">min</span></a>
<a class="sourceLine" id="cb134-2" data-line-number="2">    , <span class="fu">max</span>(a.amount) <span class="kw">as</span> <span class="fu">max</span></a>
<a class="sourceLine" id="cb134-3" data-line-number="3"><span class="kw">from</span> (<span class="kw">select</span> top <span class="dv">10</span> * <span class="kw">from</span> acc_transaction) a</a></code></pre></div>
<ul>
<li><strong>Trường hợp 3</strong>: Subquery trong select</li>
</ul>
<div class="sourceCode" id="cb135"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb135-1" data-line-number="1"><span class="kw">Select</span> Cus.Cust_Id</a>
<a class="sourceLine" id="cb135-2" data-line-number="2">     ,Cus.Address</a>
<a class="sourceLine" id="cb135-3" data-line-number="3">     ,Cus.Fed_Id</a>
<a class="sourceLine" id="cb135-4" data-line-number="4">     ,(<span class="kw">Select</span> <span class="fu">Sum</span>(Acc.Avail_Balance)</a>
<a class="sourceLine" id="cb135-5" data-line-number="5">       <span class="kw">From</span>   <span class="kw">Account</span> Acc</a>
<a class="sourceLine" id="cb135-6" data-line-number="6">       <span class="kw">Where</span>  Acc.Cust_Id = Cus.Cust_Id) <span class="kw">As</span> Sum_Avail_Balance</a>
<a class="sourceLine" id="cb135-7" data-line-number="7"><span class="kw">From</span> Customer Cus;</a></code></pre></div>
<p><strong>Lưu ý</strong>: Trong inner query, có 2 lưu ý sau:</p>
<ul>
<li>Phải liệt kê tất cả các bảng nếu các câu truy vấn có chứa biến từ bảng đó.</li>
<li>Các vị trí thường có trong subquery
<ul>
<li>Subquery sau FROM: Kết quả của subquery cần được đặt tên</li>
<li>Subquery sau WHERE: Kết quả có thể không cần đặt tên</li>
</ul></li>
</ul>
</div>
<div id="exists" class="section level3">
<h3><span class="header-section-number">4.4.2</span> Exists</h3>
<div class="sourceCode" id="cb136"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="co">---Exist</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2"><span class="kw">select</span> FirstName, </a>
<a class="sourceLine" id="cb136-3" data-line-number="3">           LastName </a>
<a class="sourceLine" id="cb136-4" data-line-number="4"><span class="kw">from</span> DimEmployee</a>
<a class="sourceLine" id="cb136-5" data-line-number="5"><span class="kw">where</span> <span class="kw">exists</span> (<span class="kw">select</span> LastName <span class="kw">from</span> DimCustomer <span class="kw">where</span> LastName =</a>
<a class="sourceLine" id="cb136-6" data-line-number="6"><span class="st">&#39;Zimmerman&#39;</span>)</a>
<a class="sourceLine" id="cb136-7" data-line-number="7"></a>
<a class="sourceLine" id="cb136-8" data-line-number="8"><span class="co">---Not exist</span></a>
<a class="sourceLine" id="cb136-9" data-line-number="9"><span class="kw">select</span> FirstName, </a>
<a class="sourceLine" id="cb136-10" data-line-number="10">        LastName </a>
<a class="sourceLine" id="cb136-11" data-line-number="11"><span class="kw">from</span> DimEmployee</a>
<a class="sourceLine" id="cb136-12" data-line-number="12"><span class="kw">where</span> <span class="kw">not</span> <span class="kw">exists</span> (<span class="kw">select</span> LastName <span class="kw">from</span> DimCustomer <span class="kw">where</span> LastName =</a>
<a class="sourceLine" id="cb136-13" data-line-number="13"><span class="st">&#39;Anh&#39;</span>)</a></code></pre></div>
</div>
<div id="any-vs.all" class="section level3">
<h3><span class="header-section-number">4.4.3</span> Any vs. All</h3>
<div class="sourceCode" id="cb137"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="co">---TH1: ANY</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2"><span class="kw">select</span> EnglishProductName, ListPrice <span class="kw">from</span> DimProduct</a>
<a class="sourceLine" id="cb137-3" data-line-number="3"><span class="kw">where</span> ListPrice &gt; <span class="kw">all</span>(<span class="kw">select</span> <span class="kw">any</span>(ListPrice) <span class="kw">from</span> DimProduct</a>
<a class="sourceLine" id="cb137-4" data-line-number="4"><span class="kw">group</span> <span class="kw">by</span> ProductSubcategoryKey)</a>
<a class="sourceLine" id="cb137-5" data-line-number="5"><span class="kw">order</span> <span class="kw">by</span> ListPrice <span class="kw">asc</span></a>
<a class="sourceLine" id="cb137-6" data-line-number="6"></a>
<a class="sourceLine" id="cb137-7" data-line-number="7"><span class="co">--TH2: ALL without having</span></a>
<a class="sourceLine" id="cb137-8" data-line-number="8"><span class="kw">select</span> EnglishProductName, ListPrice <span class="kw">from</span> DimProduct</a>
<a class="sourceLine" id="cb137-9" data-line-number="9"><span class="kw">where</span> ListPrice &gt; <span class="kw">all</span>(<span class="kw">select</span> <span class="fu">avg</span>(ListPrice) <span class="kw">from</span> DimProduct</a>
<a class="sourceLine" id="cb137-10" data-line-number="10"><span class="kw">group</span> <span class="kw">by</span> ProductSubcategoryKey)</a>
<a class="sourceLine" id="cb137-11" data-line-number="11"><span class="kw">order</span> <span class="kw">by</span> ListPrice <span class="kw">asc</span></a>
<a class="sourceLine" id="cb137-12" data-line-number="12"></a>
<a class="sourceLine" id="cb137-13" data-line-number="13"><span class="co">--TH3: ALL with having</span></a>
<a class="sourceLine" id="cb137-14" data-line-number="14"><span class="kw">select</span> EnglishProductName, ListPrice <span class="kw">from</span> DimProduct</a>
<a class="sourceLine" id="cb137-15" data-line-number="15"><span class="kw">where</span> ListPrice &gt; <span class="kw">all</span>(<span class="kw">select</span> <span class="fu">avg</span>(ListPrice) <span class="kw">from</span> DimProduct</a>
<a class="sourceLine" id="cb137-16" data-line-number="16"><span class="kw">group</span> <span class="kw">by</span> ProductSubcategoryKey</a>
<a class="sourceLine" id="cb137-17" data-line-number="17"><span class="kw">having</span> <span class="fu">avg</span>(ListPrice) <span class="kw">is</span> <span class="kw">not</span> <span class="kw">null</span>)</a>
<a class="sourceLine" id="cb137-18" data-line-number="18"><span class="kw">order</span> <span class="kw">by</span> ListPrice <span class="kw">asc</span></a></code></pre></div>
<p>Lưu ý:</p>
<ul>
<li>Với TH1, truy vấn sẽ tìm tất cả các giá trị lớn hơn min của avg(ListPrice)</li>
<li>Với TH2, vì có 1 dòng trong inner query bị NULL, do đó toàn bộ câu lệnh sẽ không ra kết quả do KHÔNG CHẮC CHẮN điều kiện lọc lớn hơn TẤT CẢ các giá trị trong inner query</li>
<li>Với TH3, sử dụng having giúp loại đi điều kiện NULL</li>
</ul>
</div>
</div>
<div id="data-manipulation" class="section level2">
<h2><span class="header-section-number">4.5</span> Data Manipulation</h2>
<ul>
<li><strong>Insert into</strong>: Thêm dòng vào bảng</li>
</ul>
<div class="sourceCode" id="cb138"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb138-1" data-line-number="1"><span class="kw">insert</span> <span class="kw">into</span> [<span class="kw">table</span>]</a>
<a class="sourceLine" id="cb138-2" data-line-number="2">(Column_1, Column_2,..., Column_n)</a>
<a class="sourceLine" id="cb138-3" data-line-number="3"><span class="kw">values</span>(Value_1,..., Value_n)</a>
<a class="sourceLine" id="cb138-4" data-line-number="4"></a>
<a class="sourceLine" id="cb138-5" data-line-number="5"><span class="co">-- Ví dụ</span></a>
<a class="sourceLine" id="cb138-6" data-line-number="6"><span class="kw">insert</span> <span class="kw">into</span> BILLS</a>
<a class="sourceLine" id="cb138-7" data-line-number="7">(NAME, AMOUNT, ACCOUNT_ID, <span class="kw">comment</span>)</a>
<a class="sourceLine" id="cb138-8" data-line-number="8"><span class="kw">values</span> (<span class="st">&#39;ANH&#39;</span>, <span class="dv">100</span>, <span class="dv">1</span>, <span class="st">&#39;OLA&#39;</span>)</a>
<a class="sourceLine" id="cb138-9" data-line-number="9"></a>
<a class="sourceLine" id="cb138-10" data-line-number="10"><span class="co">--Thêm tất cả các giá trị 1 bảng vào 1 bảng khác</span></a>
<a class="sourceLine" id="cb138-11" data-line-number="11"><span class="kw">insert</span> <span class="kw">into</span> new_2 (name <span class="kw">of</span> <span class="kw">all</span> <span class="kw">columns</span>) <span class="kw">select</span> * <span class="kw">from</span> bills</a>
<a class="sourceLine" id="cb138-12" data-line-number="12"></a>
<a class="sourceLine" id="cb138-13" data-line-number="13"><span class="co">--Thêm một số giá trị của 1 bảng vào một bảng khác</span></a>
<a class="sourceLine" id="cb138-14" data-line-number="14"><span class="kw">insert</span> <span class="kw">into</span> new_2 (NAME, <span class="kw">comment</span>) </a>
<a class="sourceLine" id="cb138-15" data-line-number="15"><span class="kw">select</span> <span class="kw">comment</span>, <span class="kw">comment</span> <span class="kw">from</span> bills</a></code></pre></div>
<p><strong>Trick</strong>: Khi insert into, để copy nhanh tên các bảng, ta có thể copy ra notepad</p>
<p><strong>Lưu ý</strong>: Khi viết tiếng Việt hoặc chèn ký tự tiếng Việt của Database cần có N ở phía trước.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb139-1" data-line-number="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> r2test ( [mychar] [<span class="dt">NVARCHAR</span>](<span class="dv">16</span>), [mynum] [<span class="dt">FLOAT</span>])</a>
<a class="sourceLine" id="cb139-2" data-line-number="2"><span class="kw">INSERT</span> <span class="kw">INTO</span> r2test (mychar,mynum) <span class="kw">VALUES</span> </a>
<a class="sourceLine" id="cb139-3" data-line-number="3">  (N<span class="st">&#39;Đức Việt&#39;</span>,<span class="fl">3.141593</span>) <span class="co">--Không lỗi</span></a>
<a class="sourceLine" id="cb139-4" data-line-number="4">  ,(<span class="st">&#39;Đức Việt&#39;</span>,<span class="fl">6.283185</span>) <span class="co">--Lỗi font</span></a>
<a class="sourceLine" id="cb139-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb139-6" data-line-number="6">  Hải Hoàng</a></code></pre></div>
<ul>
<li><strong>UPDATE</strong>: Thay đổi giá trị trong bảng</li>
</ul>
<div class="sourceCode" id="cb140"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb140-1" data-line-number="1"><span class="kw">update</span> <span class="kw">TABLE</span> </a>
<a class="sourceLine" id="cb140-2" data-line-number="2"><span class="kw">set</span> CONDITION_<span class="dv">1</span></a>
<a class="sourceLine" id="cb140-3" data-line-number="3"><span class="kw">where</span> CONDTION_<span class="dv">2</span></a>
<a class="sourceLine" id="cb140-4" data-line-number="4"></a>
<a class="sourceLine" id="cb140-5" data-line-number="5"><span class="co">--Ví dụ</span></a>
<a class="sourceLine" id="cb140-6" data-line-number="6">  <span class="kw">update</span> [learnsql].[dbo].[ACC_TRANSACTION]</a>
<a class="sourceLine" id="cb140-7" data-line-number="7">  <span class="kw">set</span> amount = <span class="dv">9999</span> <span class="kw">where</span> TXN_ID = <span class="dv">4</span></a></code></pre></div>
<ul>
<li><strong>DELETE FROM</strong>: Xóa giá trị</li>
</ul>
<div class="sourceCode" id="cb141"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb141-1" data-line-number="1"><span class="kw">DELETE</span> <span class="kw">from</span> <span class="kw">TABLE</span></a>
<a class="sourceLine" id="cb141-2" data-line-number="2"><span class="kw">where</span> CONDITION</a>
<a class="sourceLine" id="cb141-3" data-line-number="3"></a>
<a class="sourceLine" id="cb141-4" data-line-number="4"><span class="co">--Ví dụ</span></a>
<a class="sourceLine" id="cb141-5" data-line-number="5">  <span class="kw">delete</span> <span class="kw">from</span> [learnsql].[dbo].[ACC_TRANSACTION]</a>
<a class="sourceLine" id="cb141-6" data-line-number="6">  <span class="kw">where</span>  amount = <span class="dv">9999</span></a></code></pre></div>
<ul>
<li><strong>ALTER TABLE</strong>: Thêm xóa thêm cột mới</li>
</ul>
<div class="sourceCode" id="cb142"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb142-1" data-line-number="1"><span class="kw">alter</span> <span class="kw">table</span> BILLS </a>
<a class="sourceLine" id="cb142-2" data-line-number="2">add/drop NEW_VAR <span class="kw">TYPE</span></a>
<a class="sourceLine" id="cb142-3" data-line-number="3"></a>
<a class="sourceLine" id="cb142-4" data-line-number="4"><span class="co">-- Thêm cột</span></a>
<a class="sourceLine" id="cb142-5" data-line-number="5"><span class="kw">alter</span> <span class="kw">table</span> BILLS </a>
<a class="sourceLine" id="cb142-6" data-line-number="6"><span class="kw">add</span> <span class="kw">comment</span> <span class="dt">char</span>(<span class="dv">30</span>)</a>
<a class="sourceLine" id="cb142-7" data-line-number="7"></a>
<a class="sourceLine" id="cb142-8" data-line-number="8"><span class="co">-- Xóa tên cột</span></a>
<a class="sourceLine" id="cb142-9" data-line-number="9"><span class="kw">alter</span> <span class="kw">table</span> BILLS</a>
<a class="sourceLine" id="cb142-10" data-line-number="10"><span class="kw">drop</span> <span class="kw">column</span> COLUMN_NAME</a></code></pre></div>
<ul>
<li><strong>Lưu ý</strong>: SQL không hỗ trợ trực tiếp rename bằng các hàm thông thường, phải dùng sp_rename</li>
</ul>
<div class="sourceCode" id="cb143"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb143-1" data-line-number="1"><span class="co">-- Rename tên bảng</span></a>
<a class="sourceLine" id="cb143-2" data-line-number="2">sp_rename <span class="st">&#39;old_table&#39;</span>, <span class="st">&#39;new_table&#39;</span></a>
<a class="sourceLine" id="cb143-3" data-line-number="3"></a>
<a class="sourceLine" id="cb143-4" data-line-number="4"><span class="co">-- Rename tên cột trong bảng</span></a>
<a class="sourceLine" id="cb143-5" data-line-number="5">sp_rename <span class="st">&#39;table.old_column&#39;</span>, <span class="st">&#39;new_column&#39;</span>, <span class="st">&#39;column&#39;</span></a>
<a class="sourceLine" id="cb143-6" data-line-number="6">sp_rename <span class="st">&#39;my_table.var1&#39;</span>, <span class="st">&#39;variable1&#39;</span>, <span class="st">&#39;column&#39;</span></a>
<a class="sourceLine" id="cb143-7" data-line-number="7"></a>
<a class="sourceLine" id="cb143-8" data-line-number="8"><span class="co">-- Rename tên cột trong bảng tạm</span></a>
<a class="sourceLine" id="cb143-9" data-line-number="9">tempdb.sys.sp_rename <span class="st">&#39;##a.var2&#39;</span>, <span class="st">&#39;variable2&#39;</span>, <span class="st">&#39;column&#39;</span></a></code></pre></div>
</div>
<div id="tao-data-base" class="section level2">
<h2><span class="header-section-number">4.6</span> Tạo Data Base</h2>
<ul>
<li><strong>Create table</strong>:
<ul>
<li>Cấu trúc</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb144"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb144-1" data-line-number="1"><span class="kw">Create</span> <span class="kw">table</span> [TABLE_NAME](</a>
<a class="sourceLine" id="cb144-2" data-line-number="2">VAR_1 <span class="kw">TYPE</span> CONDITION,</a>
<a class="sourceLine" id="cb144-3" data-line-number="3">VAR_2 <span class="kw">TYPE</span> CONDITION,</a>
<a class="sourceLine" id="cb144-4" data-line-number="4">...</a>
<a class="sourceLine" id="cb144-5" data-line-number="5">VAR_N <span class="kw">TYPE</span> CONDITION,</a>
<a class="sourceLine" id="cb144-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb144-7" data-line-number="7"><span class="co">--Ví dụ</span></a>
<a class="sourceLine" id="cb144-8" data-line-number="8"><span class="kw">CREATE</span> <span class="kw">TABLE</span> BILLS (</a>
<a class="sourceLine" id="cb144-9" data-line-number="9">NAME <span class="dt">CHAR</span>(<span class="dv">30</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb144-10" data-line-number="10">AMOUNT <span class="dt">int</span>,</a>
<a class="sourceLine" id="cb144-11" data-line-number="11">ACCOUNT_ID <span class="dt">int</span> <span class="kw">NOT</span> <span class="kw">NULL</span>)</a></code></pre></div>
<ul>
<li><strong>DROP TABLE</strong>: Xóa bảng</li>
</ul>
<div class="sourceCode" id="cb145"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb145-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">table</span> TABLE_NAME</a></code></pre></div>
<ul>
<li>Kiểm tra điều kiện giá trị</li>
</ul>
<div class="sourceCode" id="cb146"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb146-1" data-line-number="1"><span class="co">-- Tạo Bảng</span></a>
<a class="sourceLine" id="cb146-2" data-line-number="2"><span class="kw">create</span> <span class="kw">table</span> test2</a>
<a class="sourceLine" id="cb146-3" data-line-number="3">(<span class="kw">id</span> <span class="dt">int</span> <span class="kw">Not</span> <span class="kw">Null</span>,</a>
<a class="sourceLine" id="cb146-4" data-line-number="4"> gender <span class="dt">nvarchar</span>(<span class="dv">5</span>) <span class="kw">check</span> (gender <span class="kw">in</span> (<span class="st">&#39;M&#39;</span>, <span class="st">&#39;F&#39;</span>)))</a>
<a class="sourceLine" id="cb146-5" data-line-number="5"></a>
<a class="sourceLine" id="cb146-6" data-line-number="6"><span class="co">-- Kiểm tra điều kiện khi insert</span></a>
<a class="sourceLine" id="cb146-7" data-line-number="7"><span class="kw">insert</span> <span class="kw">into</span> test2 <span class="kw">values</span></a>
<a class="sourceLine" id="cb146-8" data-line-number="8"> (<span class="dv">4</span>, <span class="st">&#39;M&#39;</span>) </a>
<a class="sourceLine" id="cb146-9" data-line-number="9"> (<span class="dv">3</span>, <span class="st">&#39;F&#39;</span>)</a>
<a class="sourceLine" id="cb146-10" data-line-number="10"></a>
<a class="sourceLine" id="cb146-11" data-line-number="11"><span class="co">-- Alter điều kiện check</span></a>
<a class="sourceLine" id="cb146-12" data-line-number="12"><span class="kw">alter</span> <span class="kw">table</span> test2 </a>
<a class="sourceLine" id="cb146-13" data-line-number="13"><span class="kw">add</span> <span class="kw">check</span> (gender <span class="kw">in</span> (<span class="st">&#39;M&#39;</span>, <span class="st">&#39;F&#39;</span>, <span class="st">&#39;MF&#39;</span>, <span class="st">&#39;MF2&#39;</span>))</a>
<a class="sourceLine" id="cb146-14" data-line-number="14"></a>
<a class="sourceLine" id="cb146-15" data-line-number="15"><span class="co">-- Drop điều kiện check</span></a>
<a class="sourceLine" id="cb146-16" data-line-number="16"><span class="kw">alter</span> <span class="kw">table</span> test2</a>
<a class="sourceLine" id="cb146-17" data-line-number="17"><span class="kw">drop</span> <span class="kw">constraint</span> CK__test2__gender__078C1F06</a></code></pre></div>
</div>
<div id="view" class="section level2">
<h2><span class="header-section-number">4.7</span> View</h2>
<p>View là hình thức tạo một bảng cho phép hiển thị, không tốn bộ nhớ thật của máy tính</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb147-1" data-line-number="1"><span class="kw">Create</span> <span class="kw">View</span> (COL_1, COL_2...) <span class="kw">as</span></a>
<a class="sourceLine" id="cb147-2" data-line-number="2"><span class="kw">select</span> COL_1,COL_2... <span class="kw">from</span> <span class="kw">TABLE</span></a>
<a class="sourceLine" id="cb147-3" data-line-number="3"></a>
<a class="sourceLine" id="cb147-4" data-line-number="4"><span class="co">--Ví dụ</span></a>
<a class="sourceLine" id="cb147-5" data-line-number="5"><span class="kw">create</span> <span class="kw">view</span> ducanh4 (CUS_ID, MAIL) <span class="kw">as</span> </a>
<a class="sourceLine" id="cb147-6" data-line-number="6"><span class="kw">select</span> CUST_ID, ADDRESS + <span class="st">&#39; ,&#39;</span> + CITY <span class="kw">from</span> customer</a>
<a class="sourceLine" id="cb147-7" data-line-number="7"></a>
<a class="sourceLine" id="cb147-8" data-line-number="8"><span class="co">--Lưu ý: Khi update trong View, ta sẽ update luôn thông tin từ bảng gốc</span></a>
<a class="sourceLine" id="cb147-9" data-line-number="9"><span class="kw">create</span> <span class="kw">view</span> ducanh5 <span class="kw">as</span> <span class="kw">select</span> * <span class="kw">from</span> <span class="kw">account</span></a>
<a class="sourceLine" id="cb147-10" data-line-number="10"><span class="kw">update</span> ducanh5</a>
<a class="sourceLine" id="cb147-11" data-line-number="11"><span class="kw">set</span> AVAIL_BALANCE = AVAIL_BALANCE * <span class="dv">10</span></a>
<a class="sourceLine" id="cb147-12" data-line-number="12"><span class="kw">select</span> * <span class="kw">from</span> <span class="kw">account</span></a>
<a class="sourceLine" id="cb147-13" data-line-number="13"></a>
<a class="sourceLine" id="cb147-14" data-line-number="14"><span class="co">--DROP VIEW TABLE</span></a>
<a class="sourceLine" id="cb147-15" data-line-number="15"><span class="kw">drop</span> <span class="kw">view</span> ducanh5</a></code></pre></div>
</div>
<div id="index" class="section level2">
<h2><span class="header-section-number">4.8</span> Index</h2>
<ul>
<li>Để tăng performance của query, ta có thể sử dụng Index. Index áp dụng B-Tree để tìm kiếm dữ liệu. Khi được đánh index, bảng sẽ là một bảng có cấu trúc, VD - theo thứ tự ABC. Nếu không đánh index, bảng sẽ được gọi là HEAP (nonsequential).</li>
<li>Khi đặt điều kiện unique key hoặc primary key, bảng sẽ tự động tạo index.</li>
<li>Khi tạo index, tốc độ truy vấn sẽ nhanh hơn tuy nhiên sẽ tốn dung lượng của ổ cứng lưu trữ</li>
</ul>
<p><img src="Images/btree.png" /></p>
<p><strong>Cơ chế hoạt động</strong>:</p>
<ul>
<li>Nếu cột customer_name được sử dụng làm index, sẽ chia làm 3 nhóm A, Q, T. Nếu tên khách hàng bắt đầu là R, sẽ nhảy luôn đến nhóm index Q &gt;&gt; R &gt;&gt; Tìm tên</li>
<li><p>Nếu không có index, sẽ phải scan từng dòng trong cả bảng để tìm</p></li>
<li><p>Trong SQL có 2 loại index: Clustered Index và Non-cluster index. Với cluster index, leaf - node cuối trong Btree, chứa toàn bộ thông tin của dòng dữ liệu. Với Non-cluster index, leaf trong Btree chỉ chứa index.</p></li>
</ul>
<div class="sourceCode" id="cb148"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb148-1" data-line-number="1"><span class="co">-- Clustered index</span></a>
<a class="sourceLine" id="cb148-2" data-line-number="2"><span class="kw">create</span> <span class="kw">index</span> new_2 <span class="kw">on</span> test2(<span class="kw">id</span>, gender)</a>
<a class="sourceLine" id="cb148-3" data-line-number="3"></a>
<a class="sourceLine" id="cb148-4" data-line-number="4"><span class="co">--Non clustered index</span></a>
<a class="sourceLine" id="cb148-5" data-line-number="5"><span class="kw">create</span> nonclustered <span class="kw">index</span> test_id</a>
<a class="sourceLine" id="cb148-6" data-line-number="6"><span class="kw">on</span> test(<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb148-7" data-line-number="7"></a>
<a class="sourceLine" id="cb148-8" data-line-number="8"><span class="co">-- Drop index</span></a>
<a class="sourceLine" id="cb148-9" data-line-number="9"><span class="kw">drop</span> <span class="kw">index</span> new_2 <span class="kw">on</span> test2</a></code></pre></div>
<div id="bang-tam" class="section level3">
<h3><span class="header-section-number">4.8.1</span> Bảng tạm</h3>
<ul>
<li>Bảng tạm là bảng chỉ tồn tại trong 1 session của SQL. Sau khi log out hoặc khởi động lại, bảng này sẽ tự động biến mấ.</li>
<li>Bảng tạm bắt đầu bằng dấu #</li>
<li>Bảng tạm với 1 dấu # gọi là bảng tạm local - sẽ tự xóa khi đóng query editor. Bạng tạm với ## gọi là bảng tạm global - chỉ xóa khi thoát khỏi SQL</li>
</ul>
<div class="sourceCode" id="cb149"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb149-1" data-line-number="1"><span class="co">--Chỉ tạo bảng</span></a>
<a class="sourceLine" id="cb149-2" data-line-number="2"><span class="kw">create</span> <span class="kw">table</span> #da (VAr1 <span class="dt">int</span>, var2 <span class="dt">char</span>(<span class="dv">30</span>))</a>
<a class="sourceLine" id="cb149-3" data-line-number="3"></a>
<a class="sourceLine" id="cb149-4" data-line-number="4"><span class="co">--Vừa tạo bảng vừa insert</span></a>
<a class="sourceLine" id="cb149-5" data-line-number="5"><span class="kw">select</span> * </a>
<a class="sourceLine" id="cb149-6" data-line-number="6"><span class="kw">into</span> #ducanh</a>
<a class="sourceLine" id="cb149-7" data-line-number="7"><span class="kw">from</span> <span class="kw">account</span></a></code></pre></div>
</div>
<div id="khai-quat-cac-cau-lnh-truy-vn-trong-sql" class="section level3">
<h3><span class="header-section-number">4.8.2</span> Khái quát các câu lệnh truy vấn trong SQL</h3>
<p>Các câu lệnh SQL diễn ra theo thứ tự sau:</p>
<p>SELECT &gt;&gt; FROM &gt;&gt; WHERE &gt;&gt; GROUP BY &gt;&gt; HAVING &gt;&gt; ORDER BY</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb150-1" data-line-number="1"><span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb150-2" data-line-number="2">[<span class="kw">DISTINCT</span>][TOP (n)] *, <span class="kw">columns</span>, <span class="kw">or</span> expressions</a>
<a class="sourceLine" id="cb150-3" data-line-number="3">[<span class="kw">FROM</span> <span class="kw">data</span> <span class="kw">source</span>(s)]</a>
<a class="sourceLine" id="cb150-4" data-line-number="4">[<span class="kw">JOIN</span> <span class="kw">data</span> <span class="kw">source</span></a>
<a class="sourceLine" id="cb150-5" data-line-number="5"><span class="kw">ON</span> condition](may include multiple joins)</a>
<a class="sourceLine" id="cb150-6" data-line-number="6">[<span class="kw">WHERE</span> conditions]</a>
<a class="sourceLine" id="cb150-7" data-line-number="7">[<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">columns</span>]</a>
<a class="sourceLine" id="cb150-8" data-line-number="8">[<span class="kw">HAVING</span> conditions]</a>
<a class="sourceLine" id="cb150-9" data-line-number="9">[<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">Columns</span>];</a></code></pre></div>
</div>
<div id="kim-tra-kiu-d-liu-trong-bang" class="section level3">
<h3><span class="header-section-number">4.8.3</span> Kiểm tra kiểu dữ liệu trong bảng</h3>
<div class="sourceCode" id="cb151"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb151-1" data-line-number="1"><span class="kw">SELECT</span> COLUMN_NAME, DATA_TYPE </a>
<a class="sourceLine" id="cb151-2" data-line-number="2"><span class="kw">FROM</span> INFORMATION_SCHEMA.COLUMNS </a>
<a class="sourceLine" id="cb151-3" data-line-number="3"><span class="kw">WHERE</span> TABLE_NAME = <span class="st">&#39;ACCOUNT&#39;</span> <span class="co">-- Điền tên bảng</span></a></code></pre></div>
</div>
</div>
<div id="sql-ng" class="section level2">
<h2><span class="header-section-number">4.9</span> SQL động</h2>
<div id="s-dung-exec" class="section level3">
<h3><span class="header-section-number">4.9.1</span> Sử dụng EXEC</h3>
<p>Sử dụng SQL động cho phép tùy biến các câu lệnh khi truy vấn và xử lý dữ liệu</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb152-1" data-line-number="1"><span class="co">-- Cách 1</span></a>
<a class="sourceLine" id="cb152-2" data-line-number="2"><span class="kw">declare</span> @id <span class="dt">int</span></a>
<a class="sourceLine" id="cb152-3" data-line-number="3"><span class="kw">set</span> @id = <span class="st">&#39;4&#39;</span></a>
<a class="sourceLine" id="cb152-4" data-line-number="4"><span class="kw">exec</span>(<span class="st">&#39;select * from ACCOUNT where ACCOUNT_ID = &#39;</span> + @id)</a>
<a class="sourceLine" id="cb152-5" data-line-number="5"></a>
<a class="sourceLine" id="cb152-6" data-line-number="6"><span class="co">-- Cách 2</span></a>
<a class="sourceLine" id="cb152-7" data-line-number="7"><span class="kw">declare</span> @id <span class="dt">varchar</span>(<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb152-8" data-line-number="8"><span class="kw">set</span> @id = <span class="st">&#39;4&#39;</span></a>
<a class="sourceLine" id="cb152-9" data-line-number="9"><span class="kw">declare</span> @sql <span class="dt">varchar</span>(<span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb152-10" data-line-number="10"><span class="kw">set</span> @sql = <span class="st">&#39;select * from ACCOUNT where account_id = &#39;</span> + @id</a>
<a class="sourceLine" id="cb152-11" data-line-number="11">print @sql <span class="co">-- Đảm bảo câu lệnh thực hiện đúng</span></a>
<a class="sourceLine" id="cb152-12" data-line-number="12"><span class="kw">exec</span>(@sql)</a></code></pre></div>
</div>
<div id="luu-y-khi-s-dung-sql-ng" class="section level3">
<h3><span class="header-section-number">4.9.2</span> Lưu ý khi sử dụng SQL động</h3>
<ul>
<li>Lưu ý dấu cách</li>
</ul>
<div class="sourceCode" id="cb153"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb153-1" data-line-number="1"><span class="kw">EXEC</span>(<span class="st">&#39; SELECT col1, col2, col3 &#39;</span> +</a>
<a class="sourceLine" id="cb153-2" data-line-number="2">     <span class="st">&#39; FROM &#39;</span> + @tblname +</a>
<a class="sourceLine" id="cb153-3" data-line-number="3">     <span class="st">&#39; WHERE keycol = </span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span> + @key + <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>)</a></code></pre></div>
</div>
</div>
<div id="t-sql" class="section level2">
<h2><span class="header-section-number">4.10</span> T-SQL</h2>
<p>Các câu lệnh Select, Insert, Update, Delete thuộc nhanh Standard SQL Data Manipulation Language (DML). Các câu lệnh này thiếu các chức năng cho phép lập trình các thuật toán và Procedure. Transact SQL (T-SQL) cho phép thức hiện việc này</p>
<div id="procedure" class="section level3">
<h3><span class="header-section-number">4.10.1</span> Procedure</h3>
</div>
<div id="hin-thi-tt-ca-cac-procedure-ang-luu-trong-h-thng" class="section level3">
<h3><span class="header-section-number">4.10.2</span> Hiển thị tất cả các procedure đang lưu trong hệ thống</h3>
<div class="sourceCode" id="cb154"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb154-1" data-line-number="1"><span class="co">-- Tất cả các procedure</span></a>
<a class="sourceLine" id="cb154-2" data-line-number="2"><span class="kw">SELECT</span> name, </a>
<a class="sourceLine" id="cb154-3" data-line-number="3">       <span class="kw">type</span></a>
<a class="sourceLine" id="cb154-4" data-line-number="4"><span class="kw">FROM</span> dbo.sysobjects</a>
<a class="sourceLine" id="cb154-5" data-line-number="5"><span class="kw">WHERE</span> (<span class="kw">type</span> = <span class="st">&#39;P&#39;</span>)</a>
<a class="sourceLine" id="cb154-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb154-7" data-line-number="7"><span class="co">-- Các procedure do người dùng tạo </span></a>
<a class="sourceLine" id="cb154-8" data-line-number="8">  <span class="kw">select</span> * </a>
<a class="sourceLine" id="cb154-9" data-line-number="9">  <span class="kw">from</span> master.information_schema.routines </a>
<a class="sourceLine" id="cb154-10" data-line-number="10">  <span class="kw">where</span> routine_type = <span class="st">&#39;PROCEDURE&#39;</span> </a>
<a class="sourceLine" id="cb154-11" data-line-number="11">        <span class="kw">and</span> <span class="kw">Left</span>(Routine_Name, <span class="dv">3</span>) <span class="kw">NOT</span> <span class="kw">IN</span> (<span class="st">&#39;sp_&#39;</span>, <span class="st">&#39;xp_&#39;</span>, <span class="st">&#39;ms_&#39;</span>)</a></code></pre></div>
<ul>
<li><strong>Xóa procedure</strong></li>
</ul>
<div class="sourceCode" id="cb155"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb155-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">procedure</span> cast_data</a></code></pre></div>
</div>
<div id="tao-procedure" class="section level3">
<h3><span class="header-section-number">4.10.3</span> Tạo procedure</h3>
<ul>
<li>Procedure không có biến</li>
</ul>
<div class="sourceCode" id="cb156"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb156-1" data-line-number="1"><span class="co">-- Tạo procedure</span></a>
<a class="sourceLine" id="cb156-2" data-line-number="2"><span class="kw">create</span> <span class="kw">procedure</span> getID_normal </a>
<a class="sourceLine" id="cb156-3" data-line-number="3"><span class="kw">as</span></a>
<a class="sourceLine" id="cb156-4" data-line-number="4"><span class="kw">select</span> * <span class="kw">from</span> <span class="kw">ACCOUNT</span></a>
<a class="sourceLine" id="cb156-5" data-line-number="5"><span class="co">-- Chạy procedure</span></a>
<a class="sourceLine" id="cb156-6" data-line-number="6"><span class="kw">execute</span> getID_normal</a></code></pre></div>
<ul>
<li>Procedure nhiều biến</li>
</ul>
<div class="sourceCode" id="cb157"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb157-1" data-line-number="1"><span class="co">--Tạo procedure</span></a>
<a class="sourceLine" id="cb157-2" data-line-number="2"><span class="kw">create</span> <span class="kw">procedure</span> PROD_CD </a>
<a class="sourceLine" id="cb157-3" data-line-number="3">  @prod <span class="dt">nvarchar</span>(<span class="dv">30</span>) = <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb157-4" data-line-number="4">  @AVAIL_BALANCE <span class="dt">float</span></a>
<a class="sourceLine" id="cb157-5" data-line-number="5"><span class="kw">as</span></a>
<a class="sourceLine" id="cb157-6" data-line-number="6">  <span class="kw">select</span> * <span class="kw">from</span> <span class="kw">ACCOUNT</span></a>
<a class="sourceLine" id="cb157-7" data-line-number="7">  <span class="kw">where</span> PRODUCT_CD = @prod <span class="kw">and</span></a>
<a class="sourceLine" id="cb157-8" data-line-number="8">  AVAIL_BALANCE &gt;= @AVAIL_BALANCE</a>
<a class="sourceLine" id="cb157-9" data-line-number="9">GO</a>
<a class="sourceLine" id="cb157-10" data-line-number="10"></a>
<a class="sourceLine" id="cb157-11" data-line-number="11"><span class="co">--Chạy procedure</span></a>
<a class="sourceLine" id="cb157-12" data-line-number="12">PROD_CD @prod = <span class="st">&#39;CHK&#39;</span>, @AVAIL_BALANCE = <span class="dv">10000</span></a></code></pre></div>
<p><strong>Lưu ý</strong>: Trong SQL có 2 loại biến:</p>
<ul>
<li>User defined variable: Bắt đầu bằng dấu **<span class="citation">(<span class="citeproc-not-found" data-reference-id="*"><strong>???</strong></span>)</span>*</li>
<li>System variable: Bắt đầu bằng dấu **@<span class="citation">(<span class="citeproc-not-found" data-reference-id="*"><strong>???</strong></span>)</span>* - loại này chỉ xuất hiện sau khi đã thực hiện xong 1 số câu lệnh</li>
</ul>
<div class="sourceCode" id="cb158"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb158-1" data-line-number="1"><span class="kw">select</span> * <span class="kw">from</span> [DimCustomer]</a>
<a class="sourceLine" id="cb158-2" data-line-number="2"><span class="kw">select</span> @@ROWCOUNT</a></code></pre></div>
</div>
<div id="gan-kt-qua-1-procedure-vao-bin" class="section level3">
<h3><span class="header-section-number">4.10.4</span> Gán kết quả 1 procedure vào biến</h3>
<div class="sourceCode" id="cb159"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb159-1" data-line-number="1"></a>
<a class="sourceLine" id="cb159-2" data-line-number="2"><span class="kw">drop</span> <span class="kw">procedure</span> <span class="kw">if</span> <span class="kw">exists</span> return_date</a>
<a class="sourceLine" id="cb159-3" data-line-number="3"><span class="kw">create</span> <span class="kw">procedure</span> [dbo].[return_date] (@no_date <span class="dt">int</span> = <span class="dv">0</span>, @no_date2 <span class="dt">int</span> = <span class="dv">2</span>,  @result <span class="dt">varchar</span>(<span class="dv">8</span>) output)</a>
<a class="sourceLine" id="cb159-4" data-line-number="4"><span class="kw">as</span></a>
<a class="sourceLine" id="cb159-5" data-line-number="5"><span class="kw">begin</span> </a>
<a class="sourceLine" id="cb159-6" data-line-number="6"><span class="kw">set</span> @result = (<span class="kw">select</span> <span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">8</span>), getdate() - @no_date + @no_date2, <span class="dv">112</span>))</a>
<a class="sourceLine" id="cb159-7" data-line-number="7"><span class="kw">end</span></a>
<a class="sourceLine" id="cb159-8" data-line-number="8"></a>
<a class="sourceLine" id="cb159-9" data-line-number="9"><span class="kw">declare</span> @result <span class="dt">varchar</span>(<span class="dv">8</span>)</a>
<a class="sourceLine" id="cb159-10" data-line-number="10"><span class="kw">execute</span> return_date <span class="dv">5</span>, <span class="dv">1</span>, @result output</a>
<a class="sourceLine" id="cb159-11" data-line-number="11">print @result</a></code></pre></div>
</div>
<div id="gan-kt-qua-function" class="section level3">
<h3><span class="header-section-number">4.10.5</span> Gán kết quả function</h3>
<div class="sourceCode" id="cb160"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb160-1" data-line-number="1"><span class="kw">DROP</span> <span class="kw">FUNCTION</span> <span class="kw">IF</span> <span class="kw">EXISTS</span> fn_return_date</a>
<a class="sourceLine" id="cb160-2" data-line-number="2"></a>
<a class="sourceLine" id="cb160-3" data-line-number="3"><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> [dbo].[fn_return_date] (@no_date <span class="dt">INT</span> = <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb160-4" data-line-number="4">RETURNS <span class="dt">INT</span></a>
<a class="sourceLine" id="cb160-5" data-line-number="5"><span class="kw">AS</span></a>
<a class="sourceLine" id="cb160-6" data-line-number="6"><span class="kw">BEGIN</span></a>
<a class="sourceLine" id="cb160-7" data-line-number="7">    <span class="kw">RETURN</span> (</a>
<a class="sourceLine" id="cb160-8" data-line-number="8">            <span class="kw">SELECT</span> <span class="fu">cast</span>(<span class="fu">convert</span>(<span class="dt">VARCHAR</span>(<span class="dv">8</span>), getdate() - @no_date, <span class="dv">112</span>) <span class="kw">AS</span> <span class="dt">INT</span>)</a>
<a class="sourceLine" id="cb160-9" data-line-number="9">            )</a>
<a class="sourceLine" id="cb160-10" data-line-number="10"><span class="kw">END</span>;</a>
<a class="sourceLine" id="cb160-11" data-line-number="11"></a>
<a class="sourceLine" id="cb160-12" data-line-number="12"><span class="co">-- Cách 1</span></a>
<a class="sourceLine" id="cb160-13" data-line-number="13"><span class="kw">declare</span> @result <span class="dt">int</span></a>
<a class="sourceLine" id="cb160-14" data-line-number="14"><span class="kw">select</span> @result = [dbo].[fn_return_date](<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb160-15" data-line-number="15">print @result</a>
<a class="sourceLine" id="cb160-16" data-line-number="16"></a>
<a class="sourceLine" id="cb160-17" data-line-number="17"><span class="co">-- Cách 2</span></a>
<a class="sourceLine" id="cb160-18" data-line-number="18"><span class="kw">declare</span> @result <span class="dt">int</span></a>
<a class="sourceLine" id="cb160-19" data-line-number="19"><span class="kw">set</span> @result = ([dbo].[fn_return_date](<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb160-20" data-line-number="20">print @result</a></code></pre></div>
</div>
<div id="vong-lp-voi-bang" class="section level3">
<h3><span class="header-section-number">4.10.6</span> Vòng lặp vơi bảng</h3>
<div class="sourceCode" id="cb161"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb161-1" data-line-number="1"></a>
<a class="sourceLine" id="cb161-2" data-line-number="2"><span class="kw">DROP</span> <span class="kw">FUNCTION</span> <span class="kw">IF</span> <span class="kw">EXISTS</span> fn_return_date</a>
<a class="sourceLine" id="cb161-3" data-line-number="3"></a>
<a class="sourceLine" id="cb161-4" data-line-number="4"><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> [dbo].[fn_return_date] (@no_date <span class="dt">INT</span> = <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb161-5" data-line-number="5">RETURNS <span class="dt">INT</span></a>
<a class="sourceLine" id="cb161-6" data-line-number="6"><span class="kw">AS</span></a>
<a class="sourceLine" id="cb161-7" data-line-number="7"><span class="kw">BEGIN</span></a>
<a class="sourceLine" id="cb161-8" data-line-number="8">    <span class="kw">RETURN</span> (</a>
<a class="sourceLine" id="cb161-9" data-line-number="9">            <span class="kw">SELECT</span> <span class="fu">cast</span>(<span class="fu">convert</span>(<span class="dt">VARCHAR</span>(<span class="dv">8</span>), getdate() - @no_date, <span class="dv">112</span>) <span class="kw">AS</span> <span class="dt">INT</span>)</a>
<a class="sourceLine" id="cb161-10" data-line-number="10">            )</a>
<a class="sourceLine" id="cb161-11" data-line-number="11"><span class="kw">END</span>;</a>
<a class="sourceLine" id="cb161-12" data-line-number="12"></a>
<a class="sourceLine" id="cb161-13" data-line-number="13"><span class="kw">declare</span> @result <span class="dt">int</span></a>
<a class="sourceLine" id="cb161-14" data-line-number="14"><span class="kw">select</span> @result = [dbo].[fn_return_date](<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb161-15" data-line-number="15">print @result</a>
<a class="sourceLine" id="cb161-16" data-line-number="16"></a>
<a class="sourceLine" id="cb161-17" data-line-number="17"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> #temp</a>
<a class="sourceLine" id="cb161-18" data-line-number="18"><span class="kw">create</span> <span class="kw">table</span> #temp (<span class="dt">date</span> <span class="dt">int</span>)</a>
<a class="sourceLine" id="cb161-19" data-line-number="19"><span class="kw">select</span> * <span class="kw">from</span> #temp</a>
<a class="sourceLine" id="cb161-20" data-line-number="20"></a>
<a class="sourceLine" id="cb161-21" data-line-number="21"><span class="kw">insert</span> <span class="kw">into</span> #temp (<span class="dt">date</span>)</a>
<a class="sourceLine" id="cb161-22" data-line-number="22"><span class="kw">select</span> [dbo].[fn_return_date](<span class="dv">1</span>) <span class="kw">as</span> <span class="dt">date</span></a>
<a class="sourceLine" id="cb161-23" data-line-number="23"><span class="kw">insert</span> <span class="kw">into</span> #temp (<span class="dt">date</span>)</a>
<a class="sourceLine" id="cb161-24" data-line-number="24"><span class="kw">select</span> [dbo].[fn_return_date](<span class="dv">2</span>) <span class="kw">as</span> <span class="dt">date</span></a>
<a class="sourceLine" id="cb161-25" data-line-number="25"><span class="kw">insert</span> <span class="kw">into</span> #temp (<span class="dt">date</span>)</a>
<a class="sourceLine" id="cb161-26" data-line-number="26"><span class="kw">select</span> [dbo].[fn_return_date](<span class="dv">3</span>) <span class="kw">as</span> <span class="dt">date</span></a>
<a class="sourceLine" id="cb161-27" data-line-number="27"></a>
<a class="sourceLine" id="cb161-28" data-line-number="28"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> #temp2</a>
<a class="sourceLine" id="cb161-29" data-line-number="29"><span class="kw">select</span> * </a>
<a class="sourceLine" id="cb161-30" data-line-number="30"><span class="kw">into</span> #temp2</a>
<a class="sourceLine" id="cb161-31" data-line-number="31"><span class="kw">from</span> #temp</a>
<a class="sourceLine" id="cb161-32" data-line-number="32"></a>
<a class="sourceLine" id="cb161-33" data-line-number="33"><span class="kw">alter</span> <span class="kw">table</span> #temp2</a>
<a class="sourceLine" id="cb161-34" data-line-number="34"><span class="kw">add</span> <span class="kw">new</span> <span class="dt">varchar</span>(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb161-35" data-line-number="35"></a>
<a class="sourceLine" id="cb161-36" data-line-number="36"><span class="kw">select</span> * <span class="kw">from</span> #temp2</a>
<a class="sourceLine" id="cb161-37" data-line-number="37"></a>
<a class="sourceLine" id="cb161-38" data-line-number="38"><span class="kw">update</span> #temp2 </a>
<a class="sourceLine" id="cb161-39" data-line-number="39"><span class="kw">set</span> <span class="kw">new</span> = <span class="fu">cast</span>(<span class="dt">date</span> <span class="kw">as</span> <span class="dt">varchar</span>(<span class="dv">20</span>)) + <span class="st">&#39;abc&#39;</span></a>
<a class="sourceLine" id="cb161-40" data-line-number="40"></a>
<a class="sourceLine" id="cb161-41" data-line-number="41"></a>
<a class="sourceLine" id="cb161-42" data-line-number="42"><span class="co">--Reference</span></a>
<a class="sourceLine" id="cb161-43" data-line-number="43"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> #ref</a>
<a class="sourceLine" id="cb161-44" data-line-number="44"></a>
<a class="sourceLine" id="cb161-45" data-line-number="45"><span class="kw">create</span> <span class="kw">table</span> #ref (</a>
<a class="sourceLine" id="cb161-46" data-line-number="46">[<span class="kw">index</span>] <span class="dt">int</span> identity(<span class="dv">1</span>,<span class="dv">1</span>) <span class="kw">not</span> <span class="kw">null</span>,</a>
<a class="sourceLine" id="cb161-47" data-line-number="47">[<span class="dt">date</span>] <span class="dt">int</span></a>
<a class="sourceLine" id="cb161-48" data-line-number="48">)</a>
<a class="sourceLine" id="cb161-49" data-line-number="49"></a>
<a class="sourceLine" id="cb161-50" data-line-number="50"><span class="kw">insert</span> <span class="kw">into</span> #ref (<span class="dt">date</span>)</a>
<a class="sourceLine" id="cb161-51" data-line-number="51"><span class="kw">select</span> [<span class="dt">date</span>] <span class="kw">from</span> #temp <span class="kw">order</span> <span class="kw">by</span> [<span class="dt">date</span>]</a>
<a class="sourceLine" id="cb161-52" data-line-number="52"></a>
<a class="sourceLine" id="cb161-53" data-line-number="53"><span class="kw">select</span> * <span class="kw">from</span> #ref</a>
<a class="sourceLine" id="cb161-54" data-line-number="54"></a>
<a class="sourceLine" id="cb161-55" data-line-number="55"><span class="co">-- VERSION 1: DOES NOT WORK</span></a>
<a class="sourceLine" id="cb161-56" data-line-number="56"></a>
<a class="sourceLine" id="cb161-57" data-line-number="57"><span class="kw">declare</span> @loopcounter <span class="dt">int</span>, @maxcounter <span class="dt">int</span> </a>
<a class="sourceLine" id="cb161-58" data-line-number="58"><span class="kw">set</span> @loopcounter = (<span class="kw">select</span> <span class="fu">min</span>(<span class="dt">date</span>) <span class="kw">from</span> #temp2)</a>
<a class="sourceLine" id="cb161-59" data-line-number="59"><span class="kw">set</span> @maxcounter = (<span class="kw">select</span> <span class="fu">max</span>(<span class="dt">date</span>) <span class="kw">from</span> #temp2)</a>
<a class="sourceLine" id="cb161-60" data-line-number="60"></a>
<a class="sourceLine" id="cb161-61" data-line-number="61"><span class="kw">while</span> (@loopcounter &lt;= @maxcounter)</a>
<a class="sourceLine" id="cb161-62" data-line-number="62"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb161-63" data-line-number="63">    <span class="kw">select</span> * <span class="kw">from</span> #temp2 <span class="kw">where</span></a>
<a class="sourceLine" id="cb161-64" data-line-number="64">    <span class="dt">date</span> = @loopcounter</a>
<a class="sourceLine" id="cb161-65" data-line-number="65">    <span class="kw">set</span> @loopcounter = @loopcounter + <span class="dv">1</span></a>
<a class="sourceLine" id="cb161-66" data-line-number="66"><span class="kw">end</span></a>
<a class="sourceLine" id="cb161-67" data-line-number="67"></a>
<a class="sourceLine" id="cb161-68" data-line-number="68"></a>
<a class="sourceLine" id="cb161-69" data-line-number="69"><span class="co">-- VERSION 2: WORK WELL</span></a>
<a class="sourceLine" id="cb161-70" data-line-number="70"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> #result</a>
<a class="sourceLine" id="cb161-71" data-line-number="71"><span class="kw">create</span> <span class="kw">table</span> #result (<span class="dt">date</span> <span class="dt">int</span>, <span class="kw">new</span> <span class="dt">varchar</span>(<span class="dv">20</span>))</a>
<a class="sourceLine" id="cb161-72" data-line-number="72"><span class="kw">select</span> * <span class="kw">from</span> #result</a>
<a class="sourceLine" id="cb161-73" data-line-number="73"></a>
<a class="sourceLine" id="cb161-74" data-line-number="74"><span class="kw">declare</span> @loopcounter <span class="dt">int</span>, @maxcounter <span class="dt">int</span> </a>
<a class="sourceLine" id="cb161-75" data-line-number="75"><span class="kw">set</span> @loopcounter = (<span class="kw">select</span> <span class="fu">min</span>([<span class="kw">index</span>]) <span class="kw">from</span> #ref)</a>
<a class="sourceLine" id="cb161-76" data-line-number="76"><span class="kw">set</span> @maxcounter = (<span class="kw">select</span> <span class="fu">max</span>([<span class="kw">index</span>]) <span class="kw">from</span> #ref)</a>
<a class="sourceLine" id="cb161-77" data-line-number="77"></a>
<a class="sourceLine" id="cb161-78" data-line-number="78"><span class="kw">while</span> (@loopcounter &lt;= @maxcounter)</a>
<a class="sourceLine" id="cb161-79" data-line-number="79"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb161-80" data-line-number="80">    <span class="kw">declare</span> @date <span class="dt">int</span> </a>
<a class="sourceLine" id="cb161-81" data-line-number="81">    <span class="kw">set</span> @date = (<span class="kw">select</span> [<span class="dt">date</span>] <span class="kw">from</span> #ref <span class="kw">where</span> [<span class="kw">index</span>] = @loopcounter)</a>
<a class="sourceLine" id="cb161-82" data-line-number="82">    </a>
<a class="sourceLine" id="cb161-83" data-line-number="83">    <span class="kw">insert</span> <span class="kw">into</span> #result ([<span class="dt">date</span>], <span class="kw">new</span>)</a>
<a class="sourceLine" id="cb161-84" data-line-number="84">    <span class="kw">select</span> * <span class="kw">from</span> #temp2 <span class="kw">where</span></a>
<a class="sourceLine" id="cb161-85" data-line-number="85">    [<span class="dt">date</span>] = @date</a>
<a class="sourceLine" id="cb161-86" data-line-number="86">    <span class="kw">set</span> @loopcounter = @loopcounter + <span class="dv">1</span></a>
<a class="sourceLine" id="cb161-87" data-line-number="87"><span class="kw">end</span></a>
<a class="sourceLine" id="cb161-88" data-line-number="88"></a>
<a class="sourceLine" id="cb161-89" data-line-number="89"><span class="kw">select</span> * <span class="kw">from</span> #result</a></code></pre></div>
<div id="ifelse" class="section level4">
<h4><span class="header-section-number">4.10.6.1</span> If…Else</h4>
<div class="sourceCode" id="cb162"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb162-1" data-line-number="1"><span class="kw">if</span> <span class="dv">1</span> = <span class="dv">1</span></a>
<a class="sourceLine" id="cb162-2" data-line-number="2"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb162-3" data-line-number="3">print <span class="st">&#39;wrong&#39;</span></a>
<a class="sourceLine" id="cb162-4" data-line-number="4">print <span class="st">&#39;not sure&#39;</span></a>
<a class="sourceLine" id="cb162-5" data-line-number="5"><span class="kw">end</span></a>
<a class="sourceLine" id="cb162-6" data-line-number="6"><span class="kw">else</span></a>
<a class="sourceLine" id="cb162-7" data-line-number="7"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb162-8" data-line-number="8">print <span class="st">&#39;right&#39;</span></a>
<a class="sourceLine" id="cb162-9" data-line-number="9">print <span class="st">&#39;absolutely right&#39;</span></a></code></pre></div>
<p><strong>Lưu ý</strong>: Sau mệnh đề else, if, nếu có nhiều câu lệnh cùng thực hiện, cần khai báo begin…end</p>
</div>
<div id="check-iu-kin--thc-thi-tip" class="section level4">
<h4><span class="header-section-number">4.10.6.2</span> Check điều kiện để thực thi tiếp</h4>
<ul>
<li>Kiểm tra điều kiện tồn tại của bảng</li>
<li>Nếu tồn tại, chạy tiếp</li>
<li>Nếu không tồn tại, skip các câu lệnh tiếp theo</li>
</ul>
<div class="sourceCode" id="cb163"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb163-1" data-line-number="1"><span class="co">--SQL CMD</span></a>
<a class="sourceLine" id="cb163-2" data-line-number="2"><span class="ch">:on</span> error exit</a>
<a class="sourceLine" id="cb163-3" data-line-number="3"></a>
<a class="sourceLine" id="cb163-4" data-line-number="4"><span class="kw">declare</span> @tbl sysname</a>
<a class="sourceLine" id="cb163-5" data-line-number="5"><span class="kw">set</span> @tbl = <span class="st">&#39;TBL_I2B_USERS_F0_20180502&#39;</span></a>
<a class="sourceLine" id="cb163-6" data-line-number="6"></a>
<a class="sourceLine" id="cb163-7" data-line-number="7"><span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (<span class="kw">SELECT</span> * <span class="kw">FROM</span> ANHNT67.DBS_DAILY.DBO.SYSOBJECTS </a>
<a class="sourceLine" id="cb163-8" data-line-number="8">                <span class="kw">WHERE</span> NAME = @tbl)</a>
<a class="sourceLine" id="cb163-9" data-line-number="9"><span class="kw">BEGIN</span></a>
<a class="sourceLine" id="cb163-10" data-line-number="10">raiserror(<span class="st">&#39;Table does not exist&#39;</span>, <span class="dv">15</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb163-11" data-line-number="11">print(@tbl)</a>
<a class="sourceLine" id="cb163-12" data-line-number="12"><span class="kw">return</span></a>
<a class="sourceLine" id="cb163-13" data-line-number="13"><span class="kw">END</span></a>
<a class="sourceLine" id="cb163-14" data-line-number="14"></a>
<a class="sourceLine" id="cb163-15" data-line-number="15"><span class="kw">EXEC</span>(<span class="st">&#39;select top 10 * FROM ANHNT67.DBS_DAILY.DBO.&#39;</span> + @tbl)</a></code></pre></div>
</div>
</div>
<div id="window-function" class="section level3">
<h3><span class="header-section-number">4.10.7</span> Window function</h3>
<div class="sourceCode" id="cb164"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb164-1" data-line-number="1"><span class="kw">select</span> CUST_ID, </a>
<a class="sourceLine" id="cb164-2" data-line-number="2">        AVAIL_BALANCE,</a>
<a class="sourceLine" id="cb164-3" data-line-number="3">        <span class="fu">ROW_NUMBER</span>() <span class="kw">over</span>(<span class="kw">partition</span> <span class="kw">by</span> cust_id <span class="kw">order</span> <span class="kw">by</span> AVAIL_BALANCE) <span class="kw">as</span> [<span class="kw">ORDER</span>],</a>
<a class="sourceLine" id="cb164-4" data-line-number="4">        <span class="fu">avg</span>(AVAIL_BALANCE) <span class="kw">over</span>(<span class="kw">partition</span> <span class="kw">by</span> cust_id) <span class="kw">as</span> AVG_BALANCE_ID</a>
<a class="sourceLine" id="cb164-5" data-line-number="5"><span class="kw">from</span> <span class="kw">ACCOUNT</span></a></code></pre></div>
<p><strong>Giải thich</strong>:</p>
<ul>
<li>Nhóm cust_id</li>
<li>Tính giá trị trung bình, row_number, trả ra kết quả</li>
<li>Hàm OVER PARTITION BY ứng với group_by %&gt;% mutate trong R</li>
</ul>
<div id="tim-tt-ca-cac-bang-ct-trong-database" class="section level4">
<h4><span class="header-section-number">4.10.7.1</span> Tìm tất cả các bảng, cột trong Database</h4>
<div class="sourceCode" id="cb165"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb165-1" data-line-number="1"><span class="kw">SELECT</span> <span class="st">&#39;SERVER_74&#39;</span> <span class="kw">as</span> SERVER,</a>
<a class="sourceLine" id="cb165-2" data-line-number="2">        <span class="st">&#39;BICDATA&#39;</span> <span class="kw">as</span> DATA_BASE,</a>
<a class="sourceLine" id="cb165-3" data-line-number="3">        lst.name <span class="kw">AS</span> Table_Name, </a>
<a class="sourceLine" id="cb165-4" data-line-number="4">        lsc.name <span class="kw">AS</span> Column_Name, </a>
<a class="sourceLine" id="cb165-5" data-line-number="5">        lsc.max_length <span class="kw">as</span> Max_Length</a>
<a class="sourceLine" id="cb165-6" data-line-number="6"><span class="kw">FROM</span> [M74].[BICDATA].[sys].[<span class="kw">tables</span>] lst</a>
<a class="sourceLine" id="cb165-7" data-line-number="7">    <span class="kw">INNER</span> <span class="kw">JOIN</span> [M74].[BICDATA].[sys].[<span class="kw">columns</span>] lsc</a>
<a class="sourceLine" id="cb165-8" data-line-number="8">        <span class="kw">ON</span> lst.OBJECT_ID=lsc.object_id</a>
<a class="sourceLine" id="cb165-9" data-line-number="9"><span class="kw">union</span> </a>
<a class="sourceLine" id="cb165-10" data-line-number="10"><span class="kw">SELECT</span> <span class="st">&#39;SERVER_16&#39;</span> <span class="kw">as</span> SERVER,</a>
<a class="sourceLine" id="cb165-11" data-line-number="11">       <span class="st">&#39;VPB_WHR2&#39;</span> <span class="kw">as</span> DATA_BASE,</a>
<a class="sourceLine" id="cb165-12" data-line-number="12">       lst.name <span class="kw">AS</span> Table_Name, </a>
<a class="sourceLine" id="cb165-13" data-line-number="13">       lsc.name <span class="kw">AS</span> Column_Name, </a>
<a class="sourceLine" id="cb165-14" data-line-number="14">       lsc.max_length <span class="kw">as</span> Max_Length</a>
<a class="sourceLine" id="cb165-15" data-line-number="15"><span class="kw">FROM</span> [M16].[VPB_WHR2].[sys].[<span class="kw">tables</span>] lst</a>
<a class="sourceLine" id="cb165-16" data-line-number="16">    <span class="kw">INNER</span> <span class="kw">JOIN</span> [M16].[VPB_WHR2].[sys].[<span class="kw">columns</span>] lsc</a>
<a class="sourceLine" id="cb165-17" data-line-number="17">        <span class="kw">ON</span> lst.OBJECT_ID=lsc.object_id</a>
<a class="sourceLine" id="cb165-18" data-line-number="18"><span class="kw">ORDER</span> <span class="kw">BY</span> DATA_BASE, lst.name, lsc.name</a></code></pre></div>
</div>
</div>
</div>
<div id="pivot---unpivot" class="section level2">
<h2><span class="header-section-number">4.11</span> Pivot - Unpivot</h2>
<div class="sourceCode" id="cb166"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb166-1" data-line-number="1">#Tạo bảng</a>
<a class="sourceLine" id="cb166-2" data-line-number="2"><span class="kw">create</span> <span class="kw">table</span> #student</a>
<a class="sourceLine" id="cb166-3" data-line-number="3">(</a>
<a class="sourceLine" id="cb166-4" data-line-number="4"><span class="kw">id</span> <span class="dt">int</span>,</a>
<a class="sourceLine" id="cb166-5" data-line-number="5">mark1 <span class="dt">float</span>,</a>
<a class="sourceLine" id="cb166-6" data-line-number="6">mark2 <span class="dt">float</span>,</a>
<a class="sourceLine" id="cb166-7" data-line-number="7">mark3 <span class="dt">float</span></a>
<a class="sourceLine" id="cb166-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb166-9" data-line-number="9"></a>
<a class="sourceLine" id="cb166-10" data-line-number="10"><span class="kw">insert</span> <span class="kw">into</span> #student <span class="kw">values</span> (<span class="dv">1</span>, <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb166-11" data-line-number="11"><span class="kw">insert</span> <span class="kw">into</span> #student <span class="kw">values</span> (<span class="dv">2</span>, <span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)</a>
<a class="sourceLine" id="cb166-12" data-line-number="12"><span class="kw">insert</span> <span class="kw">into</span> #student <span class="kw">values</span> (<span class="dv">3</span>, <span class="dv">7</span>,<span class="dv">4</span>,<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb166-13" data-line-number="13"></a>
<a class="sourceLine" id="cb166-14" data-line-number="14">#UNPIVOT</a>
<a class="sourceLine" id="cb166-15" data-line-number="15"></a>
<a class="sourceLine" id="cb166-16" data-line-number="16"><span class="kw">SELECT</span> * <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb166-17" data-line-number="17">(<span class="kw">SELECT</span> *</a>
<a class="sourceLine" id="cb166-18" data-line-number="18"><span class="kw">FROM</span> #Student) a</a>
<a class="sourceLine" id="cb166-19" data-line-number="19">UNPIVOT</a>
<a class="sourceLine" id="cb166-20" data-line-number="20">(value_var <span class="kw">FOR</span> group_var <span class="kw">IN</span> (Mark1, Mark2, Mark3)</a>
<a class="sourceLine" id="cb166-21" data-line-number="21">) b</a>
<a class="sourceLine" id="cb166-22" data-line-number="22"></a>
<a class="sourceLine" id="cb166-23" data-line-number="23">#PIVOT</a>
<a class="sourceLine" id="cb166-24" data-line-number="24"></a>
<a class="sourceLine" id="cb166-25" data-line-number="25"><span class="kw">SELECT</span> * </a>
<a class="sourceLine" id="cb166-26" data-line-number="26"><span class="kw">into</span> #student_pivot <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb166-27" data-line-number="27">(<span class="kw">SELECT</span> *</a>
<a class="sourceLine" id="cb166-28" data-line-number="28"><span class="kw">FROM</span> #Student) a</a>
<a class="sourceLine" id="cb166-29" data-line-number="29">UNPIVOT</a>
<a class="sourceLine" id="cb166-30" data-line-number="30">(value_var <span class="kw">FOR</span> group_var <span class="kw">IN</span> (Mark1, Mark2, Mark3)</a>
<a class="sourceLine" id="cb166-31" data-line-number="31">) b</a>
<a class="sourceLine" id="cb166-32" data-line-number="32"></a>
<a class="sourceLine" id="cb166-33" data-line-number="33"></a>
<a class="sourceLine" id="cb166-34" data-line-number="34"><span class="kw">select</span> * <span class="kw">from</span> </a>
<a class="sourceLine" id="cb166-35" data-line-number="35">(<span class="kw">select</span> * <span class="kw">from</span> #student_pivot) a</a>
<a class="sourceLine" id="cb166-36" data-line-number="36">pivot </a>
<a class="sourceLine" id="cb166-37" data-line-number="37">(<span class="fu">sum</span>(value_var) <span class="kw">for</span> group_var <span class="kw">in</span> (mark1, mark2, mark3)) b</a></code></pre></div>
<div id="procedure-pivot" class="section level4">
<h4><span class="header-section-number">4.11.0.1</span> Procedure pivot</h4>
<ul>
<li>Dynamic sql</li>
</ul>
<div class="sourceCode" id="cb167"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb167-1" data-line-number="1"><span class="kw">declare</span> @data <span class="dt">nvarchar</span>(<span class="dv">30</span>)</a>
<a class="sourceLine" id="cb167-2" data-line-number="2"><span class="kw">declare</span> @group <span class="dt">nvarchar</span>(<span class="dv">30</span>)</a>
<a class="sourceLine" id="cb167-3" data-line-number="3"><span class="kw">set</span> @data = <span class="st">&#39;#student_pivot&#39;</span></a>
<a class="sourceLine" id="cb167-4" data-line-number="4"><span class="kw">set</span> @group = STUFF(</a>
<a class="sourceLine" id="cb167-5" data-line-number="5">(<span class="kw">SELECT</span> <span class="st">&#39;,&#39;</span> + b.group_var</a>
<a class="sourceLine" id="cb167-6" data-line-number="6">              <span class="kw">FROM</span> </a>
<a class="sourceLine" id="cb167-7" data-line-number="7">              (<span class="kw">select</span> <span class="kw">distinct</span> group_var <span class="kw">from</span> #student_pivot</a>
<a class="sourceLine" id="cb167-8" data-line-number="8">              <span class="kw">where</span> group_var <span class="kw">not</span> <span class="kw">like</span> <span class="st">&#39;mark1&#39;</span>) b</a>
<a class="sourceLine" id="cb167-9" data-line-number="9">              <span class="kw">FOR</span> XML PATH (<span class="st">&#39;&#39;</span>)),<span class="dv">1</span>,<span class="dv">1</span>,<span class="st">&#39;&#39;</span>)</a>
<a class="sourceLine" id="cb167-10" data-line-number="10"></a>
<a class="sourceLine" id="cb167-11" data-line-number="11"><span class="kw">declare</span> @sqlstr <span class="dt">nvarchar</span>(<span class="fu">max</span>)</a>
<a class="sourceLine" id="cb167-12" data-line-number="12"><span class="kw">set</span> @sqlstr = N<span class="st">&#39;select * from </span></a>
<a class="sourceLine" id="cb167-13" data-line-number="13"><span class="st">(select * from &#39;</span>+ @data +<span class="st">&#39;) a</span></a>
<a class="sourceLine" id="cb167-14" data-line-number="14"><span class="st">pivot </span></a>
<a class="sourceLine" id="cb167-15" data-line-number="15"><span class="st">(sum(value_var) for group_var in (&#39;</span> + @group + <span class="st">&#39;)) b</span></a>
<a class="sourceLine" id="cb167-16" data-line-number="16"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb167-17" data-line-number="17"><span class="kw">exec</span> sp_executesql @sqlstr</a></code></pre></div>
<ul>
<li>Procedure</li>
</ul>
<div class="sourceCode" id="cb168"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb168-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">procedure</span> <span class="kw">if</span> <span class="kw">exists</span> sql_pivot</a>
<a class="sourceLine" id="cb168-2" data-line-number="2"><span class="kw">create</span> <span class="kw">procedure</span> sql_pivot  @data <span class="dt">nvarchar</span>(<span class="fu">max</span>),</a>
<a class="sourceLine" id="cb168-3" data-line-number="3">                            @group <span class="dt">nvarchar</span>(<span class="fu">max</span>), <span class="co">-- Variable to pivot</span></a>
<a class="sourceLine" id="cb168-4" data-line-number="4">                            @row <span class="dt">nvarchar</span>(<span class="fu">max</span>), <span class="co">-- Column to keep as key</span></a>
<a class="sourceLine" id="cb168-5" data-line-number="5">                            @value <span class="dt">nvarchar</span>(<span class="fu">max</span>), <span class="co">-- Column to calculate</span></a>
<a class="sourceLine" id="cb168-6" data-line-number="6">                            @function <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;sum&#39;</span>, <span class="co">-- Function to calculate</span></a>
<a class="sourceLine" id="cb168-7" data-line-number="7">                            @stored_data <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;##pivot_result&#39;</span> <span class="co">-- Store data result</span></a>
<a class="sourceLine" id="cb168-8" data-line-number="8"><span class="kw">as</span></a>
<a class="sourceLine" id="cb168-9" data-line-number="9"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb168-10" data-line-number="10"><span class="kw">declare</span> @sql <span class="dt">nvarchar</span>(<span class="fu">max</span>)</a>
<a class="sourceLine" id="cb168-11" data-line-number="11"><span class="kw">set</span> @sql = <span class="st">&#39;</span></a>
<a class="sourceLine" id="cb168-12" data-line-number="12"><span class="st">declare @group_value nvarchar(max)</span></a>
<a class="sourceLine" id="cb168-13" data-line-number="13"><span class="st">set @group_value = STUFF(</span></a>
<a class="sourceLine" id="cb168-14" data-line-number="14"><span class="st">(SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + b.&#39;</span>+@group+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb168-15" data-line-number="15"><span class="st">              FROM </span></a>
<a class="sourceLine" id="cb168-16" data-line-number="16"><span class="st">              (select distinct &#39;</span>+ @group +<span class="st">&#39; from &#39;</span>+ @data +<span class="st">&#39;) b</span></a>
<a class="sourceLine" id="cb168-17" data-line-number="17"><span class="st">              FOR XML PATH (</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb168-18" data-line-number="18"></a>
<a class="sourceLine" id="cb168-19" data-line-number="19"><span class="st">declare @sqlstr nvarchar(max)</span></a>
<a class="sourceLine" id="cb168-20" data-line-number="20"><span class="st">set @sqlstr = N</span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb168-21" data-line-number="21"><span class="st">drop table if exists &#39;</span>+ @stored_data +<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb168-22" data-line-number="22"><span class="st">select * </span></a>
<a class="sourceLine" id="cb168-23" data-line-number="23"><span class="st">into &#39;</span>+ @stored_data +<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb168-24" data-line-number="24"><span class="st">from </span></a>
<a class="sourceLine" id="cb168-25" data-line-number="25"><span class="st">(select &#39;</span>+ @group+ <span class="st">&#39;,&#39;</span> + @row + <span class="st">&#39;, &#39;</span>+@value +<span class="st">&#39;  from &#39;</span>+ @data +<span class="st">&#39;) a</span></a>
<a class="sourceLine" id="cb168-26" data-line-number="26"><span class="st">pivot </span></a>
<a class="sourceLine" id="cb168-27" data-line-number="27"><span class="st">(&#39;</span>+@function+<span class="st">&#39;(&#39;</span>+ @value +<span class="st">&#39;) for &#39;</span>+@group+<span class="st">&#39; in (</span><span class="ch">&#39;&#39;</span><span class="st"> + @group_value + </span><span class="ch">&#39;&#39;</span><span class="st">)) b</span></a>
<a class="sourceLine" id="cb168-28" data-line-number="28"><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb168-29" data-line-number="29"><span class="st">exec sp_executesql @sqlstr</span></a>
<a class="sourceLine" id="cb168-30" data-line-number="30"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb168-31" data-line-number="31"><span class="kw">exec</span> sp_executesql @sql</a>
<a class="sourceLine" id="cb168-32" data-line-number="32"><span class="kw">end</span>;</a></code></pre></div>
<ul>
<li>Ví dụ:</li>
</ul>
<div class="sourceCode" id="cb169"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb169-1" data-line-number="1">sql_pivot @data = <span class="st">&#39;##student_pivot&#39;</span>, @row = <span class="st">&#39;id&#39;</span>,</a>
<a class="sourceLine" id="cb169-2" data-line-number="2"><span class="ot">@group= &#39;group_var&#39;, @value = &#39;value_var&#39;, @function = &#39;sum&#39;</span></a>
<a class="sourceLine" id="cb169-3" data-line-number="3"><span class="kw">select</span> * <span class="kw">from</span> ##pivot_result</a></code></pre></div>
</div>
<div id="procedure-unpivot" class="section level3">
<h3><span class="header-section-number">4.11.1</span> Procedure unpivot</h3>
<ul>
<li><p>Dynamic sql: Cho phép nhiều ID</p></li>
<li><p>Cách 1: Chỉ sử dụng với các data trong máy local</p></li>
</ul>
<div class="sourceCode" id="cb170"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb170-1" data-line-number="1"><span class="kw">declare</span> @data <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;student&#39;</span></a>
<a class="sourceLine" id="cb170-2" data-line-number="2"><span class="kw">declare</span> @id_var <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">id</span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st">mark1</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb170-3" data-line-number="3"><span class="kw">declare</span> @group_var <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;group_var&#39;</span></a>
<a class="sourceLine" id="cb170-4" data-line-number="4"><span class="kw">declare</span> @value_var <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;value_var&#39;</span></a>
<a class="sourceLine" id="cb170-5" data-line-number="5"></a>
<a class="sourceLine" id="cb170-6" data-line-number="6"><span class="kw">declare</span> @sql <span class="dt">nvarchar</span>(<span class="fu">max</span>)</a>
<a class="sourceLine" id="cb170-7" data-line-number="7"><span class="kw">set</span> @sql = <span class="st">&#39;</span></a>
<a class="sourceLine" id="cb170-8" data-line-number="8"><span class="st">declare @cols AS NVARCHAR(MAX)</span></a>
<a class="sourceLine" id="cb170-9" data-line-number="9"><span class="st">   select @cols = STUFF((SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + QUOTENAME(column_name) </span></a>
<a class="sourceLine" id="cb170-10" data-line-number="10"><span class="st">                    FROM (</span></a>
<a class="sourceLine" id="cb170-11" data-line-number="11"><span class="st">                        select   table_name, column_name, ordinal_position, data_type</span></a>
<a class="sourceLine" id="cb170-12" data-line-number="12"><span class="st">                        from   information_schema.columns</span></a>
<a class="sourceLine" id="cb170-13" data-line-number="13"><span class="st">                        where   table_name = </span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>+@data+<span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st"> and </span></a>
<a class="sourceLine" id="cb170-14" data-line-number="14"><span class="st">                        column_name not in (&#39;</span>+@id_var+<span class="st">&#39;) </span></a>
<a class="sourceLine" id="cb170-15" data-line-number="15"><span class="st">                        ) cols</span></a>
<a class="sourceLine" id="cb170-16" data-line-number="16"><span class="st">                    ORDER BY ordinal_position               </span></a>
<a class="sourceLine" id="cb170-17" data-line-number="17"><span class="st">                    FOR XML PATH(</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">), TYPE).value(</span><span class="ch">&#39;&#39;</span><span class="st">.</span><span class="ch">&#39;&#39;</span><span class="st">, </span><span class="ch">&#39;&#39;</span><span class="st">NVARCHAR(MAX)</span><span class="ch">&#39;&#39;</span><span class="st">),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb170-18" data-line-number="18"><span class="st">select @cols</span></a>
<a class="sourceLine" id="cb170-19" data-line-number="19"></a>
<a class="sourceLine" id="cb170-20" data-line-number="20"><span class="st">declare @key AS NVARCHAR(MAX)</span></a>
<a class="sourceLine" id="cb170-21" data-line-number="21"><span class="st">   select @key = STUFF((SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + QUOTENAME(column_name) </span></a>
<a class="sourceLine" id="cb170-22" data-line-number="22"><span class="st">                    FROM (</span></a>
<a class="sourceLine" id="cb170-23" data-line-number="23"><span class="st">                        select   table_name, column_name, ordinal_position, data_type</span></a>
<a class="sourceLine" id="cb170-24" data-line-number="24"><span class="st">                        from   information_schema.columns</span></a>
<a class="sourceLine" id="cb170-25" data-line-number="25"><span class="st">                        where   table_name = </span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span>+@data+<span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st"> and </span></a>
<a class="sourceLine" id="cb170-26" data-line-number="26"><span class="st">                        column_name in (&#39;</span>+@id_var+<span class="st">&#39;) </span></a>
<a class="sourceLine" id="cb170-27" data-line-number="27"><span class="st">                        ) cols</span></a>
<a class="sourceLine" id="cb170-28" data-line-number="28"><span class="st">                    ORDER BY ordinal_position               </span></a>
<a class="sourceLine" id="cb170-29" data-line-number="29"><span class="st">                    FOR XML PATH(</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">), TYPE).value(</span><span class="ch">&#39;&#39;</span><span class="st">.</span><span class="ch">&#39;&#39;</span><span class="st">, </span><span class="ch">&#39;&#39;</span><span class="st">NVARCHAR(MAX)</span><span class="ch">&#39;&#39;</span><span class="st">),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb170-30" data-line-number="30"><span class="st">select @key</span></a>
<a class="sourceLine" id="cb170-31" data-line-number="31"></a>
<a class="sourceLine" id="cb170-32" data-line-number="32"><span class="st">declare @sqlstr nvarchar(max)</span></a>
<a class="sourceLine" id="cb170-33" data-line-number="33"><span class="st">set @sqlstr = N</span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb170-34" data-line-number="34"><span class="st">            select </span><span class="ch">&#39;&#39;</span><span class="st">+@key+</span><span class="ch">&#39;&#39;</span><span class="st">, &#39;</span>+@group_var+<span class="st">&#39;, &#39;</span>+@value_var+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb170-35" data-line-number="35"><span class="st">            from(</span></a>
<a class="sourceLine" id="cb170-36" data-line-number="36"><span class="st">               select *</span></a>
<a class="sourceLine" id="cb170-37" data-line-number="37"><span class="st">               from &#39;</span>+@data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb170-38" data-line-number="38"><span class="st">            ) as a</span></a>
<a class="sourceLine" id="cb170-39" data-line-number="39"><span class="st">            unpivot</span></a>
<a class="sourceLine" id="cb170-40" data-line-number="40"><span class="st">            (</span></a>
<a class="sourceLine" id="cb170-41" data-line-number="41"><span class="st">              &#39;</span>+@value_var+<span class="st">&#39; for &#39;</span>+@group_var+<span class="st">&#39; in (</span><span class="ch">&#39;&#39;</span><span class="st"> + @cols + </span><span class="ch">&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb170-42" data-line-number="42"><span class="st">            ) as b</span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb170-43" data-line-number="43"><span class="st">print @sqlstr</span></a>
<a class="sourceLine" id="cb170-44" data-line-number="44"><span class="st">exec sp_executesql @sqlstr</span></a>
<a class="sourceLine" id="cb170-45" data-line-number="45"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb170-46" data-line-number="46">  </a>
<a class="sourceLine" id="cb170-47" data-line-number="47"><span class="kw">exec</span> sp_executesql @sql</a></code></pre></div>
<ul>
<li>Cách 2: Khái quát dynamic sql</li>
</ul>
<div class="sourceCode" id="cb171"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb171-1" data-line-number="1"><span class="kw">declare</span> @db <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;tempdb&#39;</span></a>
<a class="sourceLine" id="cb171-2" data-line-number="2"><span class="kw">declare</span> @data <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;##student&#39;</span></a>
<a class="sourceLine" id="cb171-3" data-line-number="3"><span class="kw">declare</span> @id_var <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">id</span><span class="ch">&#39;&#39;</span><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-4" data-line-number="4"><span class="kw">declare</span> @group_var <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;group_var&#39;</span></a>
<a class="sourceLine" id="cb171-5" data-line-number="5"><span class="kw">declare</span> @value_var <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;value_var&#39;</span></a>
<a class="sourceLine" id="cb171-6" data-line-number="6"><span class="kw">declare</span> @stored_data <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;##a&#39;</span></a>
<a class="sourceLine" id="cb171-7" data-line-number="7"><span class="kw">declare</span> @sql <span class="dt">nvarchar</span>(<span class="fu">max</span>) </a>
<a class="sourceLine" id="cb171-8" data-line-number="8"></a>
<a class="sourceLine" id="cb171-9" data-line-number="9"><span class="kw">set</span> @sql = N<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-10" data-line-number="10"><span class="st">drop table if exists ##all_cols</span></a>
<a class="sourceLine" id="cb171-11" data-line-number="11"><span class="st">select name into ##all_cols</span></a>
<a class="sourceLine" id="cb171-12" data-line-number="12"><span class="st">from &#39;</span>+@db+<span class="st">&#39;.sys.columns </span></a>
<a class="sourceLine" id="cb171-13" data-line-number="13"><span class="st">where object_id in (select object_id from &#39;</span>+@db+<span class="st">&#39;.sys.tables where name like </span><span class="ch">&#39;&#39;</span><span class="st">%&#39;</span>+@data+<span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb171-14" data-line-number="14"></a>
<a class="sourceLine" id="cb171-15" data-line-number="15"><span class="st">declare @cols AS NVARCHAR(MAX)</span></a>
<a class="sourceLine" id="cb171-16" data-line-number="16"><span class="st">   select @cols = STUFF((SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + QUOTENAME(name) </span></a>
<a class="sourceLine" id="cb171-17" data-line-number="17"><span class="st">                    FROM (</span></a>
<a class="sourceLine" id="cb171-18" data-line-number="18"><span class="st">                        select name from ##all_cols </span></a>
<a class="sourceLine" id="cb171-19" data-line-number="19"><span class="st">                        where name not in (&#39;</span>+@id_var+<span class="st">&#39;) </span></a>
<a class="sourceLine" id="cb171-20" data-line-number="20"><span class="st">                        ) cols            </span></a>
<a class="sourceLine" id="cb171-21" data-line-number="21"><span class="st">                    FOR XML PATH(</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">), TYPE).value(</span><span class="ch">&#39;&#39;</span><span class="st">.</span><span class="ch">&#39;&#39;</span><span class="st">, </span><span class="ch">&#39;&#39;</span><span class="st">NVARCHAR(MAX)</span><span class="ch">&#39;&#39;</span><span class="st">),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb171-22" data-line-number="22"><span class="st">select @cols</span></a>
<a class="sourceLine" id="cb171-23" data-line-number="23"></a>
<a class="sourceLine" id="cb171-24" data-line-number="24"><span class="st">declare @key AS NVARCHAR(MAX)</span></a>
<a class="sourceLine" id="cb171-25" data-line-number="25"><span class="st">   select @key = STUFF((SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + QUOTENAME(name) </span></a>
<a class="sourceLine" id="cb171-26" data-line-number="26"><span class="st">                    FROM (</span></a>
<a class="sourceLine" id="cb171-27" data-line-number="27"><span class="st">                        select name from ##all_cols </span></a>
<a class="sourceLine" id="cb171-28" data-line-number="28"><span class="st">                        where name in (&#39;</span>+@id_var+<span class="st">&#39;) </span></a>
<a class="sourceLine" id="cb171-29" data-line-number="29"><span class="st">                        ) cols            </span></a>
<a class="sourceLine" id="cb171-30" data-line-number="30"><span class="st">                    FOR XML PATH(</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">), TYPE).value(</span><span class="ch">&#39;&#39;</span><span class="st">.</span><span class="ch">&#39;&#39;</span><span class="st">, </span><span class="ch">&#39;&#39;</span><span class="st">NVARCHAR(MAX)</span><span class="ch">&#39;&#39;</span><span class="st">),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb171-31" data-line-number="31"><span class="st">select @key</span></a>
<a class="sourceLine" id="cb171-32" data-line-number="32"></a>
<a class="sourceLine" id="cb171-33" data-line-number="33"><span class="st">--Run procedure</span></a>
<a class="sourceLine" id="cb171-34" data-line-number="34"></a>
<a class="sourceLine" id="cb171-35" data-line-number="35"><span class="st">declare @sqlstr nvarchar(max)</span></a>
<a class="sourceLine" id="cb171-36" data-line-number="36"><span class="st">set @sqlstr = N</span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb171-37" data-line-number="37"><span class="st">            drop table if exists &#39;</span>+@stored_data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-38" data-line-number="38"><span class="st">            select </span><span class="ch">&#39;&#39;</span><span class="st">+@key+</span><span class="ch">&#39;&#39;</span><span class="st">, &#39;</span>+@group_var+<span class="st">&#39;, &#39;</span>+@value_var+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-39" data-line-number="39"><span class="st">            into &#39;</span>+@stored_data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-40" data-line-number="40"><span class="st">            from(</span></a>
<a class="sourceLine" id="cb171-41" data-line-number="41"><span class="st">               select *</span></a>
<a class="sourceLine" id="cb171-42" data-line-number="42"><span class="st">               from &#39;</span>+@db+<span class="st">&#39;.dbo.[&#39;</span>+@data+<span class="st">&#39;]</span></a>
<a class="sourceLine" id="cb171-43" data-line-number="43"><span class="st">            ) as a</span></a>
<a class="sourceLine" id="cb171-44" data-line-number="44"><span class="st">            unpivot</span></a>
<a class="sourceLine" id="cb171-45" data-line-number="45"><span class="st">            (</span></a>
<a class="sourceLine" id="cb171-46" data-line-number="46"><span class="st">              &#39;</span>+@value_var+<span class="st">&#39; for &#39;</span>+@group_var+<span class="st">&#39; in (</span><span class="ch">&#39;&#39;</span><span class="st"> + @cols + </span><span class="ch">&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb171-47" data-line-number="47"><span class="st">            ) as b</span></a>
<a class="sourceLine" id="cb171-48" data-line-number="48"><span class="st">            select * from &#39;</span>+@stored_data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-49" data-line-number="49"><span class="st">            </span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb171-50" data-line-number="50"><span class="st">print @sqlstr</span></a>
<a class="sourceLine" id="cb171-51" data-line-number="51"><span class="st">exec sp_executesql @sqlstr</span></a>
<a class="sourceLine" id="cb171-52" data-line-number="52"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb171-53" data-line-number="53"><span class="kw">exec</span> sp_executesql @sql</a></code></pre></div>
<p>**Lưu ý*: Các bảng phải là bảng trong db hoặc bảng lưu ở global environment</p>
<ul>
<li>Procedure</li>
</ul>
<div class="sourceCode" id="cb172"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb172-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">procedure</span> <span class="kw">if</span> <span class="kw">exists</span> sql_unpivot</a>
<a class="sourceLine" id="cb172-2" data-line-number="2"><span class="kw">create</span> <span class="kw">procedure</span> sql_unpivot </a>
<a class="sourceLine" id="cb172-3" data-line-number="3"> @db <span class="dt">nvarchar</span>(<span class="fu">max</span>) = <span class="st">&#39;tempdb&#39;</span>, <span class="co">--Database contains data</span></a>
<a class="sourceLine" id="cb172-4" data-line-number="4"><span class="ot">@data nvarchar(max), -- Name of data</span></a>
<a class="sourceLine" id="cb172-5" data-line-number="5"><span class="ot">@id_var nvarchar(max), -- Key variables</span></a>
<a class="sourceLine" id="cb172-6" data-line-number="6"><span class="ot">@group_var nvarchar(max) = &#39;group_var&#39;, --Name of groups variable</span></a>
<a class="sourceLine" id="cb172-7" data-line-number="7"><span class="ot">@value_var nvarchar(max) = &#39;value_var&#39;, -- Name of value variable</span></a>
<a class="sourceLine" id="cb172-8" data-line-number="8"><span class="ot">@stored_data nvarchar(max) = &#39;##unpivot_result&#39;  -- Data storage</span></a>
<a class="sourceLine" id="cb172-9" data-line-number="9"><span class="kw">as</span> </a>
<a class="sourceLine" id="cb172-10" data-line-number="10"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb172-11" data-line-number="11"><span class="kw">declare</span> @sql <span class="dt">nvarchar</span>(<span class="fu">max</span>) </a>
<a class="sourceLine" id="cb172-12" data-line-number="12"><span class="kw">set</span> @sql = N<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb172-13" data-line-number="13"><span class="st">drop table if exists ##all_cols</span></a>
<a class="sourceLine" id="cb172-14" data-line-number="14"><span class="st">select name into ##all_cols</span></a>
<a class="sourceLine" id="cb172-15" data-line-number="15"><span class="st">from &#39;</span>+@db+<span class="st">&#39;.sys.columns </span></a>
<a class="sourceLine" id="cb172-16" data-line-number="16"><span class="st">where object_id in (select object_id from &#39;</span>+@db+<span class="st">&#39;.sys.tables where name like </span><span class="ch">&#39;&#39;</span><span class="st">%&#39;</span>+@data+<span class="st">&#39;</span><span class="ch">&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb172-17" data-line-number="17"></a>
<a class="sourceLine" id="cb172-18" data-line-number="18"><span class="st">declare @cols AS NVARCHAR(MAX)</span></a>
<a class="sourceLine" id="cb172-19" data-line-number="19"><span class="st">   select @cols = STUFF((SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + QUOTENAME(name) </span></a>
<a class="sourceLine" id="cb172-20" data-line-number="20"><span class="st">                    FROM (</span></a>
<a class="sourceLine" id="cb172-21" data-line-number="21"><span class="st">                        select name from ##all_cols </span></a>
<a class="sourceLine" id="cb172-22" data-line-number="22"><span class="st">                        where name not in (&#39;</span>+@id_var+<span class="st">&#39;) </span></a>
<a class="sourceLine" id="cb172-23" data-line-number="23"><span class="st">                        ) cols            </span></a>
<a class="sourceLine" id="cb172-24" data-line-number="24"><span class="st">                    FOR XML PATH(</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">), TYPE).value(</span><span class="ch">&#39;&#39;</span><span class="st">.</span><span class="ch">&#39;&#39;</span><span class="st">, </span><span class="ch">&#39;&#39;</span><span class="st">NVARCHAR(MAX)</span><span class="ch">&#39;&#39;</span><span class="st">),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb172-25" data-line-number="25"><span class="st">-- Show columns</span></a>
<a class="sourceLine" id="cb172-26" data-line-number="26"><span class="st">print @cols </span></a>
<a class="sourceLine" id="cb172-27" data-line-number="27"></a>
<a class="sourceLine" id="cb172-28" data-line-number="28"><span class="st">declare @key AS NVARCHAR(MAX)</span></a>
<a class="sourceLine" id="cb172-29" data-line-number="29"><span class="st">   select @key = STUFF((SELECT </span><span class="ch">&#39;&#39;</span><span class="st">,</span><span class="ch">&#39;&#39;</span><span class="st"> + QUOTENAME(name) </span></a>
<a class="sourceLine" id="cb172-30" data-line-number="30"><span class="st">                    FROM (</span></a>
<a class="sourceLine" id="cb172-31" data-line-number="31"><span class="st">                        select name from ##all_cols </span></a>
<a class="sourceLine" id="cb172-32" data-line-number="32"><span class="st">                        where name in (&#39;</span>+@id_var+<span class="st">&#39;) </span></a>
<a class="sourceLine" id="cb172-33" data-line-number="33"><span class="st">                        ) cols            </span></a>
<a class="sourceLine" id="cb172-34" data-line-number="34"><span class="st">                    FOR XML PATH(</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">), TYPE).value(</span><span class="ch">&#39;&#39;</span><span class="st">.</span><span class="ch">&#39;&#39;</span><span class="st">, </span><span class="ch">&#39;&#39;</span><span class="st">NVARCHAR(MAX)</span><span class="ch">&#39;&#39;</span><span class="st">),1,1,</span><span class="ch">&#39;&#39;&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb172-35" data-line-number="35"><span class="st">-- Show key</span></a>
<a class="sourceLine" id="cb172-36" data-line-number="36"><span class="st">print @key </span></a>
<a class="sourceLine" id="cb172-37" data-line-number="37"></a>
<a class="sourceLine" id="cb172-38" data-line-number="38"><span class="st">--Run procedure</span></a>
<a class="sourceLine" id="cb172-39" data-line-number="39"></a>
<a class="sourceLine" id="cb172-40" data-line-number="40"><span class="st">declare @sqlstr nvarchar(max)</span></a>
<a class="sourceLine" id="cb172-41" data-line-number="41"><span class="st">set @sqlstr = N</span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb172-42" data-line-number="42"><span class="st">            drop table if exists &#39;</span>+@stored_data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb172-43" data-line-number="43"><span class="st">            select </span><span class="ch">&#39;&#39;</span><span class="st">+@key+</span><span class="ch">&#39;&#39;</span><span class="st">, &#39;</span>+@group_var+<span class="st">&#39;, &#39;</span>+@value_var+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb172-44" data-line-number="44"><span class="st">            into &#39;</span>+@stored_data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb172-45" data-line-number="45"><span class="st">            from(</span></a>
<a class="sourceLine" id="cb172-46" data-line-number="46"><span class="st">               select *</span></a>
<a class="sourceLine" id="cb172-47" data-line-number="47"><span class="st">               from &#39;</span>+@db+<span class="st">&#39;.dbo.[&#39;</span>+@data+<span class="st">&#39;]</span></a>
<a class="sourceLine" id="cb172-48" data-line-number="48"><span class="st">            ) as a</span></a>
<a class="sourceLine" id="cb172-49" data-line-number="49"><span class="st">            unpivot</span></a>
<a class="sourceLine" id="cb172-50" data-line-number="50"><span class="st">            (</span></a>
<a class="sourceLine" id="cb172-51" data-line-number="51"><span class="st">              &#39;</span>+@value_var+<span class="st">&#39; for &#39;</span>+@group_var+<span class="st">&#39; in (</span><span class="ch">&#39;&#39;</span><span class="st"> + @cols + </span><span class="ch">&#39;&#39;</span><span class="st">)</span></a>
<a class="sourceLine" id="cb172-52" data-line-number="52"><span class="st">            ) as b</span></a>
<a class="sourceLine" id="cb172-53" data-line-number="53"><span class="st">            select * from &#39;</span>+@stored_data+<span class="st">&#39;</span></a>
<a class="sourceLine" id="cb172-54" data-line-number="54"><span class="st">            </span><span class="ch">&#39;&#39;</span></a>
<a class="sourceLine" id="cb172-55" data-line-number="55"><span class="st">print @sqlstr</span></a>
<a class="sourceLine" id="cb172-56" data-line-number="56"><span class="st">exec sp_executesql @sqlstr</span></a>
<a class="sourceLine" id="cb172-57" data-line-number="57"><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb172-58" data-line-number="58"><span class="kw">exec</span> sp_executesql @sql</a>
<a class="sourceLine" id="cb172-59" data-line-number="59"><span class="kw">end</span></a></code></pre></div>
<div class="sourceCode" id="cb173"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb173-1" data-line-number="1"><span class="kw">exec</span> sql_unpivot @db = <span class="st">&#39;loan_db&#39;</span>, @data = <span class="st">&#39;MONTHLY_LCY_AMOUNT - M74 - BICDATA&#39;</span>, </a>
<a class="sourceLine" id="cb173-2" data-line-number="2"><span class="ot">@id_var = &#39;&#39;&#39;id&#39;&#39;, &#39;&#39;YEARMONTH&#39;&#39;, &#39;&#39;APP&#39;&#39;,&#39;&#39;ACCTNO&#39;&#39;, &#39;&#39;CIF&#39;&#39;, &#39;&#39;AVERAGE_BAL&#39;&#39;, &#39;&#39;BI_SEGMENT&#39;&#39;&#39;</span></a></code></pre></div>
<p><strong>Lưu ý</strong>:</p>
<ul>
<li>Bắt buộc phải có alias sau bảng</li>
</ul>
</div>
</div>
<div id="s-dung-index" class="section level2">
<h2><span class="header-section-number">4.12</span> Sử dụng Index</h2>
<ul>
<li>Bảng có index sẽ hoạt động nhanh hơn bảng thường do cơ chế sau:
<ul>
<li>Không có index: Scan từng dòng trong bảng và tìm điều kiện</li>
<li>Có index: Tìm theo khu vực index. VD: ID = 5
<ul>
<li>Nếu không có index, sẽ tìm từng dòng và trả về kết quả với ID = 5.</li>
<li>Nếu có index, sẽ tìm với thuật toán chia đôi</li>
</ul></li>
</ul></li>
<li>Các loại index:
<ul>
<li>Clustered: Sắp xếp lại cách lưu trữ dữ liệu trong DB</li>
<li>Nonclustered: Không sắp xepps</li>
</ul></li>
</ul>
</div>
<div id="cac-luu-y-khac" class="section level2">
<h2><span class="header-section-number">4.13</span> Các lưu ý khác</h2>
<ul>
<li>Tên các bảng thường bắt đầu bằng Dim - viết tắt của Dimension</li>
<li>Xóa bảng nếu tồn tại</li>
</ul>
<div class="sourceCode" id="cb174"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb174-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> CROSS_SELLING_RESULTS</a></code></pre></div>
<ul>
<li>Tìm kiếm kiểu dữ liệu trong bảng của db</li>
</ul>
<div class="sourceCode" id="cb175"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb175-1" data-line-number="1"><span class="co">-- Kiểm tra thông tin kiểu dữ liệu trong bảng</span></a>
<a class="sourceLine" id="cb175-2" data-line-number="2"><span class="kw">select</span> table_name, column_name, data_type <span class="kw">from</span> [learningsql].[INFORMATION_SCHEMA].[<span class="kw">columns</span>]</a></code></pre></div>
<ul>
<li>DROP và CREATE không thể chạy cùng trong 1 batch, khi muốn sử dụng phải thêm câu lệnh GO</li>
</ul>
<div class="sourceCode" id="cb176"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb176-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> #temp</a>
<a class="sourceLine" id="cb176-2" data-line-number="2">GO</a>
<a class="sourceLine" id="cb176-3" data-line-number="3"></a>
<a class="sourceLine" id="cb176-4" data-line-number="4"><span class="kw">create</span> <span class="kw">table</span> #temp(abc <span class="dt">int</span>)</a>
<a class="sourceLine" id="cb176-5" data-line-number="5"><span class="kw">insert</span> <span class="kw">into</span> #temp(abc)</a>
<a class="sourceLine" id="cb176-6" data-line-number="6"><span class="kw">values</span> (<span class="dv">1</span>), (<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb176-7" data-line-number="7">GO</a></code></pre></div>
<ul>
<li>SQL không phân biệt được định dạng numeric &amp; integer ngay lập tức</li>
</ul>
<div class="sourceCode" id="cb177"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb177-1" data-line-number="1"><span class="kw">select</span> <span class="dv">7</span>/<span class="dv">10</span>  <span class="co">-- Trả kết quả 0</span></a>
<a class="sourceLine" id="cb177-2" data-line-number="2"></a>
<a class="sourceLine" id="cb177-3" data-line-number="3"><span class="co">--So sánh</span></a>
<a class="sourceLine" id="cb177-4" data-line-number="4"></a>
<a class="sourceLine" id="cb177-5" data-line-number="5"><span class="kw">select</span> <span class="fl">7.0</span>/<span class="dv">10</span> <span class="co">-- Chạy đúng</span></a></code></pre></div>
</div>
<div id="so-sanh-khac" class="section level2">
<h2><span class="header-section-number">4.14</span> So sánh khác</h2>
<ul>
<li>varchar vs. nvarchar: nvarchar cho phép lưu trữ ký tự Unicode, varchar không cho phép</li>
<li>varchar(n) vs. varchar(max):
varchar(n) | varchar(max)
———–|————-
Tối đa 8000 ký tự | Tối đa hơn 2 tỷ, khoảng 2G
Cho phép tạo index | Không cho phép tạo index</li>
</ul>
<div class="sourceCode" id="cb178"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb178-1" data-line-number="1"><span class="co">--Varchar(50): Work</span></a>
<a class="sourceLine" id="cb178-2" data-line-number="2"><span class="kw">CREATE</span> <span class="kw">TABLE</span> dbo.Employee</a>
<a class="sourceLine" id="cb178-3" data-line-number="3">(<span class="kw">id</span> <span class="dt">INT</span> identity(<span class="dv">1</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb178-4" data-line-number="4">   <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</a>
<a class="sourceLine" id="cb178-5" data-line-number="5"> Name <span class="dt">VARCHAR</span>(<span class="dv">50</span>))</a>
<a class="sourceLine" id="cb178-6" data-line-number="6">GO</a>
<a class="sourceLine" id="cb178-7" data-line-number="7"><span class="kw">CREATE</span> <span class="kw">INDEX</span> IX_EmployeeName </a>
<a class="sourceLine" id="cb178-8" data-line-number="8"> <span class="kw">ON</span> dbo.Employee(Name)</a>
<a class="sourceLine" id="cb178-9" data-line-number="9">GO</a>
<a class="sourceLine" id="cb178-10" data-line-number="10"></a>
<a class="sourceLine" id="cb178-11" data-line-number="11"><span class="co">--Varchar(max): Not work</span></a>
<a class="sourceLine" id="cb178-12" data-line-number="12"><span class="kw">CREATE</span> <span class="kw">TABLE</span> dbo.Employee</a>
<a class="sourceLine" id="cb178-13" data-line-number="13">(<span class="kw">id</span> <span class="dt">INT</span> identity(<span class="dv">1</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb178-14" data-line-number="14">   <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</a>
<a class="sourceLine" id="cb178-15" data-line-number="15"> Name <span class="dt">VARCHAR</span>(<span class="fu">Max</span>))</a>
<a class="sourceLine" id="cb178-16" data-line-number="16">GO</a>
<a class="sourceLine" id="cb178-17" data-line-number="17"><span class="kw">CREATE</span> <span class="kw">INDEX</span> IX_EmployeeName</a>
<a class="sourceLine" id="cb178-18" data-line-number="18"> <span class="kw">ON</span> dbo.Employee(Name)</a>
<a class="sourceLine" id="cb178-19" data-line-number="19">GO </a></code></pre></div>
<p>-Primary key vs. Unique key</p>
<table>
<thead>
<tr class="header">
<th>Tiêu chí</th>
<th>Primary key</th>
<th>Unique key</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>NULL</td>
<td>Không cho phép null</td>
<td>Cho phép MỘT giá trị NULL</td>
</tr>
<tr class="even">
<td>Index</td>
<td>Default là clustered index</td>
<td>Default là unique non-cluster index</td>
</tr>
<tr class="odd">
<td>Limit</td>
<td>Chỉ có 1 key</td>
<td>Có thể có nhiều key</td>
</tr>
</tbody>
</table>
<ul>
<li>EXEC vs. EXEC():
<ul>
<li>Exec dùng để thực hiện các procedure. VD: <code>exec sp_pivot</code></li>
<li>Exec() dùng để thực hiện dinamic SQL.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb179"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb179-1" data-line-number="1"><span class="kw">exec</span>(<span class="st">&#39;Select top 10 * from @table&#39;</span>)</a></code></pre></div>
<p>##Tricks khác</p>
<div id="auto-wrap-in-mssql" class="section level3">
<h3><span class="header-section-number">4.14.1</span> Auto Wrap in MSSQL</h3>
<p>Tools &gt;&gt; Options &gt;&gt; Text Editor &gt;&gt; Transact SQL &gt;&gt; General &gt;&gt; WordWrap</p>
</div>
<div id="sa-lai-font-mau-cua-text-editor" class="section level3">
<h3><span class="header-section-number">4.14.2</span> Sửa lại font màu của Text Editor</h3>
</div>
<div id="format-inh-dang-them-ky-t-00-truc-s" class="section level3">
<h3><span class="header-section-number">4.14.3</span> Format định dạng thêm ký tự 00 trước số</h3>
<div class="sourceCode" id="cb180"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb180-1" data-line-number="1"><span class="kw">select</span> FORMAT(<span class="dv">01</span>,<span class="st">&#39;00#&#39;</span>) <span class="kw">as</span> <span class="kw">index</span></a></code></pre></div>
</div>
<div id="kim-tra-inh-dang-d-liu-mt-bang" class="section level3">
<h3><span class="header-section-number">4.14.4</span> Kiểm tra định dạng dữ liệu một bảng</h3>
<div class="sourceCode" id="cb181"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb181-1" data-line-number="1"><span class="co">-- Với Link server</span></a>
<a class="sourceLine" id="cb181-2" data-line-number="2"><span class="kw">select</span> * <span class="kw">from</span> ANHNT67.DATA.INFORMATION_SCHEMA.COLUMNS <span class="kw">where</span> TABLE_NAME=<span class="st">&#39;CARD_LIVE&#39;</span></a>
<a class="sourceLine" id="cb181-3" data-line-number="3"></a>
<a class="sourceLine" id="cb181-4" data-line-number="4"><span class="co">-- Với Local</span></a>
<a class="sourceLine" id="cb181-5" data-line-number="5"><span class="kw">select</span> * <span class="kw">from</span> <span class="kw">COLUMNS</span> <span class="kw">where</span> TABLE_NAME=<span class="st">&#39;CARD_LIVE&#39;</span></a>
<a class="sourceLine" id="cb181-6" data-line-number="6"></a>
<a class="sourceLine" id="cb181-7" data-line-number="7"><span class="co">-- Kiểm tra toàn bộ thông tin</span></a>
<a class="sourceLine" id="cb181-8" data-line-number="8">sp_help table_name </a>
<a class="sourceLine" id="cb181-9" data-line-number="9">sp_help CARD_LIVE</a></code></pre></div>
</div>
<div id="convert-t-ting-vit-co-du-sang-khong-du" class="section level3">
<h3><span class="header-section-number">4.14.5</span> Convert từ tiếng Việt có dấu sang không dấu</h3>
<div class="sourceCode" id="cb182"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb182-1" data-line-number="1"><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> [dbo].[fChuyenCoDauThanhKhongDau](@inputVar <span class="dt">NVARCHAR</span>(<span class="fu">MAX</span>) )</a>
<a class="sourceLine" id="cb182-2" data-line-number="2">RETURNS <span class="dt">NVARCHAR</span>(<span class="fu">MAX</span>)</a>
<a class="sourceLine" id="cb182-3" data-line-number="3"><span class="kw">AS</span></a>
<a class="sourceLine" id="cb182-4" data-line-number="4"><span class="kw">BEGIN</span>    </a>
<a class="sourceLine" id="cb182-5" data-line-number="5">    <span class="kw">IF</span> (@inputVar <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">OR</span> @inputVar = <span class="st">&#39;&#39;</span>)  <span class="kw">RETURN</span> <span class="st">&#39;&#39;</span></a>
<a class="sourceLine" id="cb182-6" data-line-number="6">   </a>
<a class="sourceLine" id="cb182-7" data-line-number="7">    <span class="kw">DECLARE</span> @RT <span class="dt">NVARCHAR</span>(<span class="fu">MAX</span>)</a>
<a class="sourceLine" id="cb182-8" data-line-number="8">    <span class="kw">DECLARE</span> @SIGN_CHARS <span class="dt">NCHAR</span>(<span class="dv">256</span>)</a>
<a class="sourceLine" id="cb182-9" data-line-number="9">    <span class="kw">DECLARE</span> @UNSIGN_CHARS <span class="dt">NCHAR</span> (<span class="dv">256</span>)</a>
<a class="sourceLine" id="cb182-10" data-line-number="10"></a>
<a class="sourceLine" id="cb182-11" data-line-number="11">    <span class="kw">SET</span> @SIGN_CHARS = N<span class="st">&#39;ăâđêôơưàảãạáằẳẵặắầẩẫậấèẻẽẹéềểễệếìỉĩịíòỏõọóồổỗộốờởỡợớùủũụúừửữựứỳỷỹỵýĂÂĐÊÔƠƯÀẢÃẠÁẰẲẴẶẮẦẨẪẬẤÈẺẼẸÉỀỂỄỆẾÌỈĨỊÍÒỎÕỌÓỒỔỖỘỐỜỞỠỢỚÙỦŨỤÚỪỬỮỰỨỲỶỸỴÝ&#39;</span> + <span class="dt">NCHAR</span>(<span class="dv">272</span>) + <span class="dt">NCHAR</span>(<span class="dv">208</span>)</a>
<a class="sourceLine" id="cb182-12" data-line-number="12">    <span class="kw">SET</span> @UNSIGN_CHARS = N<span class="st">&#39;aadeoouaaaaaaaaaaaaaaaeeeeeeeeeeiiiiiooooooooooooooouuuuuuuuuuyyyyyAADEOOUAAAAAAAAAAAAAAAEEEEEEEEEEIIIIIOOOOOOOOOOOOOOOUUUUUUUUUUYYYYYDD&#39;</span></a>
<a class="sourceLine" id="cb182-13" data-line-number="13"></a>
<a class="sourceLine" id="cb182-14" data-line-number="14">    <span class="kw">DECLARE</span> @COUNTER <span class="dt">int</span></a>
<a class="sourceLine" id="cb182-15" data-line-number="15">    <span class="kw">DECLARE</span> @COUNTER1 <span class="dt">int</span></a>
<a class="sourceLine" id="cb182-16" data-line-number="16">   </a>
<a class="sourceLine" id="cb182-17" data-line-number="17">    <span class="kw">SET</span> @COUNTER = <span class="dv">1</span></a>
<a class="sourceLine" id="cb182-18" data-line-number="18">    <span class="kw">WHILE</span> (@COUNTER &lt;= LEN(@inputVar))</a>
<a class="sourceLine" id="cb182-19" data-line-number="19">    <span class="kw">BEGIN</span>  </a>
<a class="sourceLine" id="cb182-20" data-line-number="20">        <span class="kw">SET</span> @COUNTER1 = <span class="dv">1</span></a>
<a class="sourceLine" id="cb182-21" data-line-number="21">        <span class="kw">WHILE</span> (@COUNTER1 &lt;= LEN(@SIGN_CHARS) + <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb182-22" data-line-number="22">        <span class="kw">BEGIN</span></a>
<a class="sourceLine" id="cb182-23" data-line-number="23">            <span class="kw">IF</span> UNICODE(SUBSTRING(@SIGN_CHARS, @COUNTER1,<span class="dv">1</span>)) = UNICODE(SUBSTRING(@inputVar,@COUNTER ,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb182-24" data-line-number="24">            <span class="kw">BEGIN</span>          </a>
<a class="sourceLine" id="cb182-25" data-line-number="25">                <span class="kw">IF</span> @COUNTER = <span class="dv">1</span></a>
<a class="sourceLine" id="cb182-26" data-line-number="26">                    <span class="kw">SET</span> @inputVar = SUBSTRING(@UNSIGN_CHARS, @COUNTER1,<span class="dv">1</span>) + SUBSTRING(@inputVar, @COUNTER+<span class="dv">1</span>,LEN(@inputVar)-<span class="dv">1</span>)      </a>
<a class="sourceLine" id="cb182-27" data-line-number="27">                <span class="kw">ELSE</span></a>
<a class="sourceLine" id="cb182-28" data-line-number="28">                    <span class="kw">SET</span> @inputVar = SUBSTRING(@inputVar, <span class="dv">1</span>, @COUNTER<span class="dv">-1</span>) +SUBSTRING(@UNSIGN_CHARS, @COUNTER1,<span class="dv">1</span>) + SUBSTRING(@inputVar, @COUNTER+<span class="dv">1</span>,LEN(@inputVar)- @COUNTER)</a>
<a class="sourceLine" id="cb182-29" data-line-number="29">                <span class="kw">BREAK</span></a>
<a class="sourceLine" id="cb182-30" data-line-number="30">            <span class="kw">END</span></a>
<a class="sourceLine" id="cb182-31" data-line-number="31">            <span class="kw">SET</span> @COUNTER1 = @COUNTER1 +<span class="dv">1</span></a>
<a class="sourceLine" id="cb182-32" data-line-number="32">        <span class="kw">END</span></a>
<a class="sourceLine" id="cb182-33" data-line-number="33">        <span class="kw">SET</span> @COUNTER = @COUNTER +<span class="dv">1</span></a>
<a class="sourceLine" id="cb182-34" data-line-number="34">    <span class="kw">END</span></a>
<a class="sourceLine" id="cb182-35" data-line-number="35">    <span class="co">-- SET @inputVar = replace(@inputVar,&#39; &#39;,&#39;-&#39;)</span></a>
<a class="sourceLine" id="cb182-36" data-line-number="36">    <span class="kw">RETURN</span> @inputVar</a>
<a class="sourceLine" id="cb182-37" data-line-number="37"><span class="kw">END</span></a></code></pre></div>
<ul>
<li>Example</li>
</ul>
<div class="sourceCode" id="cb183"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb183-1" data-line-number="1"><span class="kw">select</span> dbo.fChuyenCoDauThanhKhongDau(N<span class="st">&#39;Một thiên thần&#39;</span>) </a></code></pre></div>
</div>
<div id="cac-luu-y-giup-tang-tc--truy-vn" class="section level3">
<h3><span class="header-section-number">4.14.6</span> Các lưu ý giúp tăng tốc độ truy vấn</h3>
<ul>
<li>Không nên dùng select *, sẽ tốn tài nguyên</li>
<li>Không dùng distinct, gây chậm câu lệnh</li>
<li>Khi dùng câu lệnh UNION, kết quả tương tự như SELECT DISTINCT. Do đó nếu biết chắc rằng không có 1 hàng nào trùng lắp được tạo ra từ kết quả của UNION thì ta nên sử dụng câu lệnh UNION ALL.</li>
<li>Ưu tiên sử dụng câu lệnh theo mức độ ưu tiên: IN &gt;&gt; OR, EXISTS &gt;&gt; IN, BETWEEN &gt;&gt; IN</li>
<li>Khi truy vấn, phải đảm bảo điều kiệu sargable (search argument able):
<ul>
<li>Tránh sử dụng function trong điều kiện where</li>
<li>Các cột nào là index nên đưa vào trước</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb184"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb184-1" data-line-number="1"><span class="co">--VD 1</span></a>
<a class="sourceLine" id="cb184-2" data-line-number="2"><span class="co">-- câu lệnh 1 (non-sargable)</span></a>
<a class="sourceLine" id="cb184-3" data-line-number="3"><span class="kw">SELECT</span> * <span class="kw">FROM</span> Sales.Individual</a>
<a class="sourceLine" id="cb184-4" data-line-number="4"><span class="kw">WHERE</span> CustomerID+<span class="dv">2</span> = <span class="dv">11002</span></a>
<a class="sourceLine" id="cb184-5" data-line-number="5"></a>
<a class="sourceLine" id="cb184-6" data-line-number="6"><span class="co">-- câu lệnh 2 (sargable)</span></a>
<a class="sourceLine" id="cb184-7" data-line-number="7"><span class="kw">SELECT</span> * <span class="kw">FROM</span> Sales.Individual</a>
<a class="sourceLine" id="cb184-8" data-line-number="8"><span class="kw">WHERE</span> CustomerID = <span class="dv">11000</span></a>
<a class="sourceLine" id="cb184-9" data-line-number="9"></a>
<a class="sourceLine" id="cb184-10" data-line-number="10"><span class="co">----</span></a>
<a class="sourceLine" id="cb184-11" data-line-number="11"><span class="co">--VD2</span></a>
<a class="sourceLine" id="cb184-12" data-line-number="12"><span class="co">-- Câu lệnh 1: Non-sargable</span></a>
<a class="sourceLine" id="cb184-13" data-line-number="13"><span class="kw">SELECT</span> member_number, first_name, last_name</a>
<a class="sourceLine" id="cb184-14" data-line-number="14"><span class="kw">FROM</span> members</a>
<a class="sourceLine" id="cb184-15" data-line-number="15"><span class="kw">WHERE</span> DATEDIFF(yy,datofbirth,GETDATE()) &gt; <span class="dv">21</span> </a>
<a class="sourceLine" id="cb184-16" data-line-number="16"></a>
<a class="sourceLine" id="cb184-17" data-line-number="17"><span class="co">-- Câu lệnh 2: Sargable</span></a>
<a class="sourceLine" id="cb184-18" data-line-number="18"><span class="kw">SELECT</span> member_number, first_name, last_name</a>
<a class="sourceLine" id="cb184-19" data-line-number="19"><span class="kw">FROM</span> members</a>
<a class="sourceLine" id="cb184-20" data-line-number="20"><span class="kw">WHERE</span> dateofbirth &lt; DATEADD(yy,-<span class="dv">21</span>,GETDATE()) </a></code></pre></div>
<ul>
<li>Khi dùng IN, có thể thay thế bằng UNION ALL</li>
</ul>
<div class="sourceCode" id="cb185"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb185-1" data-line-number="1"><span class="co">-- Câu lệnh 1: 242 ms </span></a>
<a class="sourceLine" id="cb185-2" data-line-number="2"><span class="kw">set</span> <span class="kw">statistics</span> <span class="dt">time</span> <span class="kw">on</span> </a>
<a class="sourceLine" id="cb185-3" data-line-number="3"><span class="kw">select</span> * <span class="kw">from</span> [CUSTOMER - M74 - BICDATA] <span class="kw">where</span> cus_name <span class="kw">like</span> <span class="st">&#39;VO%&#39;</span> <span class="kw">or</span> cus_name <span class="kw">like</span> <span class="st">&#39;%PHAN%&#39;</span></a>
<a class="sourceLine" id="cb185-4" data-line-number="4"></a>
<a class="sourceLine" id="cb185-5" data-line-number="5"><span class="co">-- Câu lệnh 2: 172 ms</span></a>
<a class="sourceLine" id="cb185-6" data-line-number="6"><span class="kw">set</span> <span class="kw">statistics</span> <span class="dt">time</span> <span class="kw">on</span> </a>
<a class="sourceLine" id="cb185-7" data-line-number="7"><span class="kw">select</span> * <span class="kw">from</span> [CUSTOMER - M74 - BICDATA] <span class="kw">where</span> cus_name <span class="kw">like</span> <span class="st">&#39;VO%&#39;</span></a>
<a class="sourceLine" id="cb185-8" data-line-number="8"><span class="kw">union</span> <span class="kw">all</span></a>
<a class="sourceLine" id="cb185-9" data-line-number="9"><span class="kw">select</span> * <span class="kw">from</span> [CUSTOMER - M74 - BICDATA] <span class="kw">where</span> cus_name <span class="kw">like</span> <span class="st">&#39;%PHAN%&#39;</span></a></code></pre></div>
<ul>
<li><p>Khi muốn xác định sự tồn tại của 1 record, không nên dùng count(*), nên dùng if exists</p></li>
<li><p>Dùng hàm tính toán tổng hợp với IN</p></li>
</ul>
<div class="sourceCode" id="cb186"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb186-1" data-line-number="1"><span class="co">-- Câu lệnh 1: 18 ms</span></a>
<a class="sourceLine" id="cb186-2" data-line-number="2"><span class="kw">set</span> <span class="kw">statistics</span> <span class="dt">time</span> <span class="kw">on</span></a>
<a class="sourceLine" id="cb186-3" data-line-number="3"><span class="kw">SELECT</span> <span class="fu">MIN</span>(IntDataColumn) </a>
<a class="sourceLine" id="cb186-4" data-line-number="4">  <span class="kw">FROM</span> [dbo].[<span class="kw">Parent</span>]</a>
<a class="sourceLine" id="cb186-5" data-line-number="5"> <span class="kw">WHERE</span> ParentID <span class="kw">IN</span> (<span class="kw">SELECT</span> TOP <span class="dv">2</span> ParentID </a>
<a class="sourceLine" id="cb186-6" data-line-number="6">                      <span class="kw">FROM</span> [dbo].[<span class="kw">Parent</span>] </a>
<a class="sourceLine" id="cb186-7" data-line-number="7">                    <span class="kw">ORDER</span> <span class="kw">BY</span> IntDataColumn <span class="kw">DESC</span>)</a>
<a class="sourceLine" id="cb186-8" data-line-number="8"></a>
<a class="sourceLine" id="cb186-9" data-line-number="9"><span class="co">-- Câu lệnh 2: 0 ms</span></a>
<a class="sourceLine" id="cb186-10" data-line-number="10"><span class="kw">set</span> <span class="kw">statistics</span> <span class="dt">time</span> <span class="kw">on</span></a>
<a class="sourceLine" id="cb186-11" data-line-number="11"><span class="kw">SELECT</span> <span class="fu">MIN</span>(IntDataColumn) </a>
<a class="sourceLine" id="cb186-12" data-line-number="12">  <span class="kw">FROM</span> (<span class="kw">SELECT</span> TOP <span class="dv">2</span> IntDataColumn </a>
<a class="sourceLine" id="cb186-13" data-line-number="13">          <span class="kw">FROM</span> [dbo].[<span class="kw">Parent</span>] </a>
<a class="sourceLine" id="cb186-14" data-line-number="14">        <span class="kw">ORDER</span> <span class="kw">BY</span> IntDataColumn <span class="kw">DESC</span>) <span class="kw">AS</span> A</a></code></pre></div>
</div>
</div>
<div id="tai-liu-tham-khao" class="section level2">
<h2><span class="header-section-number">4.15</span> Tài liệu tham khảo</h2>
<ul>
<li>Microsoft SQL Bible</li>
<li><a href="http://vietjack.com/sql/">SQL Vietjack</a></li>
<li><a href="https://www.mssqltips.com/sqlservertutorial/172/reducing-amount-of-network-data-for-sql-server-stored-procedures/">MSSQL tips</a></li>
<li>Practical SQL Queries for MS SQL Server 2008</li>
<li><a href="http://sqlhints.com/all-articles/">SQL Hints</a></li>
<li><a href="http://sqlhints.com/2015/06/21/looping-through-table-records-in-sql-server/" class="uri">http://sqlhints.com/2015/06/21/looping-through-table-records-in-sql-server/</a></li>
</ul>
<p><strong>Lưu ý</strong>:</p>
<ul>
<li>Dữ liệu ví dụ được lấy từ DB AdventureWorks2012, scritp learnsql và WideWorldImporters</li>
</ul>
</div>
<div id="xay-dng-data-warehouse-data-mart" class="section level2">
<h2><span class="header-section-number">4.16</span> Xây dựng Data warehouse &amp; Data Mart</h2>
<p>Khi xây dựng Data Model, có 2 loại bảng chính: Dim &amp; Fact</p>
<ul>
<li>Fact table: Ghi nhận kết quả như bán hàng, tồn kho,… Fact table có các tính chất:
<ul>
<li>Additive - như số lượng đơn hàng. Tổng số hàng cả nước là tổng số hàng mỗi đơn vị</li>
<li>Semi-additive - Số lượng khách hàng trong cả nước ko hẳn là tổng số khách hàng mỗi đơn vị do 1 khách hàng có thể thuộc nhiều đơn vị</li>
<li>Non-additive - Tỷ lệ phần trăm lợi nhuận của toàn hàng không phải là tổng tỷ lệ phần trăm lợi nhuận mỗi đơn vị</li>
</ul></li>
<li><p>Dimension: Là chiều để tổng hợp fact
- Granularity: Là độ chi tiết của dimension. VD: Chi nhánh &lt; Thành phố &lt; Vùng
- Slow changing dimension: Các dimension có thể thay đổi theo thời gian. VD: Khi mở thêm chi nhánh, sẽ có thêm dimension Branch_name. Đối với loại này, cần có thểm thông tin effective date
- Time dimension: Loại dimension rất đặc biệt, có thể có các dạng sau:
- Theo lịch: Year &gt; Month &gt; Date hoặc Year &gt; Month &gt; Week &gt; Weekday &gt; Date
- Theo năm tài chính: Fiscal year</p>
<pre><code>  Time dimension có thể làm như sau:</code></pre></li>
</ul>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb188-1" data-line-number="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb188-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb188-3" data-line-number="3">datekey &lt;-<span class="st"> </span><span class="dv">20160101</span><span class="op">:</span><span class="dv">20160130</span></a>
<a class="sourceLine" id="cb188-4" data-line-number="4">data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">datekey =</span> datekey)</a>
<a class="sourceLine" id="cb188-5" data-line-number="5">data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb188-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">ymd</span>(datekey)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb188-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(date),</a>
<a class="sourceLine" id="cb188-8" data-line-number="8">         <span class="dt">quarter =</span> <span class="kw">quarter</span>(date),</a>
<a class="sourceLine" id="cb188-9" data-line-number="9">         <span class="dt">month =</span> <span class="kw">month</span>(date),</a>
<a class="sourceLine" id="cb188-10" data-line-number="10">         <span class="dt">month_name =</span> <span class="kw">month</span>(date, <span class="dt">label =</span> T, <span class="dt">abbr =</span> F),</a>
<a class="sourceLine" id="cb188-11" data-line-number="11">         <span class="dt">day_of_month =</span> <span class="kw">day</span>(date),</a>
<a class="sourceLine" id="cb188-12" data-line-number="12">         <span class="dt">day_of_week =</span> <span class="kw">wday</span>(date),</a>
<a class="sourceLine" id="cb188-13" data-line-number="13">         <span class="dt">day_name =</span> <span class="kw">wday</span>(date, <span class="dt">label =</span> T, <span class="dt">abbr =</span> F)</a>
<a class="sourceLine" id="cb188-14" data-line-number="14">         )</a>
<a class="sourceLine" id="cb188-15" data-line-number="15">DT<span class="op">::</span><span class="kw">datatable</span>(data)</a></code></pre></div>
<p><strong>Script tạo thông tin bảng</strong>:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb189-1" data-line-number="1"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> dimDate</a>
<a class="sourceLine" id="cb189-2" data-line-number="2"><span class="co">--Step1: Tạo DimDate table</span></a>
<a class="sourceLine" id="cb189-3" data-line-number="3"></a>
<a class="sourceLine" id="cb189-4" data-line-number="4"><span class="kw">CREATE</span> <span class="kw">TABLE</span> [dbo].[DimDate](</a>
<a class="sourceLine" id="cb189-5" data-line-number="5">[DateKey] [<span class="dt">int</span>] <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-6" data-line-number="6">[DateFullName] [<span class="dt">varchar</span>](<span class="dv">50</span>) <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-7" data-line-number="7">[DateFull] [<span class="dt">date</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-8" data-line-number="8">[<span class="dt">Year</span>] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-9" data-line-number="9">[Quarter] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-10" data-line-number="10">[QuarterName] [<span class="dt">varchar</span>](<span class="dv">50</span>) <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-11" data-line-number="11">[QuarterKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-12" data-line-number="12">[<span class="dt">Month</span>] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-13" data-line-number="13">[MonthKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-14" data-line-number="14">[MonthName] [<span class="dt">varchar</span>](<span class="dv">50</span>) <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-15" data-line-number="15">[DayOfMonth] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-16" data-line-number="16">[NumberOfDaysInTheMonth] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-17" data-line-number="17">[DayOfYear] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-18" data-line-number="18">[WeekOfYear] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-19" data-line-number="19">[WeekOfYearKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-20" data-line-number="20">[ISOWeek] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-21" data-line-number="21">[ISOWeekKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-22" data-line-number="22">[WeekDay] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-23" data-line-number="23">[WeekDayName] [<span class="dt">varchar</span>](<span class="dv">50</span>) <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-24" data-line-number="24">[FiscalYear] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-25" data-line-number="25">[FiscalQuarter] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-26" data-line-number="26">[FiscalQuarterKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-27" data-line-number="27">[FiscalMonth] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-28" data-line-number="28">[FiscalMonthKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-29" data-line-number="29">[IsWorkDayKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-30" data-line-number="30">[IsWorkDayDescription] [<span class="dt">varchar</span>](<span class="dv">50</span>) <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-31" data-line-number="31">[IsPublicHolidayKey] [<span class="dt">int</span>] <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-32" data-line-number="32">[IsPublicHolidayDescription] [<span class="dt">varchar</span>](<span class="dv">50</span>) <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb189-33" data-line-number="33"><span class="kw">CONSTRAINT</span> [PK_DimDate] <span class="kw">PRIMARY</span> <span class="kw">KEY</span> CLUSTERED</a>
<a class="sourceLine" id="cb189-34" data-line-number="34">(</a>
<a class="sourceLine" id="cb189-35" data-line-number="35">[DateKey] <span class="kw">ASC</span></a>
<a class="sourceLine" id="cb189-36" data-line-number="36">)<span class="kw">WITH</span> (PAD_INDEX = <span class="kw">OFF</span>, STATISTICS_NORECOMPUTE = <span class="kw">OFF</span>, IGNORE_DUP_KEY = <span class="kw">OFF</span>, ALLOW_ROW_LOCKS = <span class="kw">ON</span>, ALLOW_PAGE_LOCKS = <span class="kw">ON</span>) <span class="kw">ON</span> [<span class="kw">PRIMARY</span>]</a>
<a class="sourceLine" id="cb189-37" data-line-number="37">) <span class="kw">ON</span> [<span class="kw">PRIMARY</span>]</a>
<a class="sourceLine" id="cb189-38" data-line-number="38"></a>
<a class="sourceLine" id="cb189-39" data-line-number="39"></a>
<a class="sourceLine" id="cb189-40" data-line-number="40"><span class="co">--Step 2: Tạo các biến date</span></a>
<a class="sourceLine" id="cb189-41" data-line-number="41"></a>
<a class="sourceLine" id="cb189-42" data-line-number="42"><span class="kw">declare</span> @CurrentDate <span class="dt">date</span></a>
<a class="sourceLine" id="cb189-43" data-line-number="43"><span class="kw">declare</span> @FiscalYearStartMonth <span class="dt">int</span></a>
<a class="sourceLine" id="cb189-44" data-line-number="44"><span class="kw">declare</span> @WeeklyHolidays <span class="kw">table</span> ([WeekDay] <span class="dt">int</span>) <span class="co">-- weekday, sunday is 1 and saturday is 7</span></a>
<a class="sourceLine" id="cb189-45" data-line-number="45"><span class="kw">declare</span> @AnnulPublicHolidays <span class="kw">table</span>([<span class="dt">Date</span>] <span class="dt">int</span>) <span class="co">-- int in YYYYMMDD format</span></a>
<a class="sourceLine" id="cb189-46" data-line-number="46"><span class="kw">declare</span> @FirstDate <span class="dt">date</span> </a>
<a class="sourceLine" id="cb189-47" data-line-number="47"><span class="kw">declare</span> @NumberOfYearsToGenerate <span class="dt">int</span></a>
<a class="sourceLine" id="cb189-48" data-line-number="48"><span class="kw">declare</span> @LastDate <span class="dt">date</span></a>
<a class="sourceLine" id="cb189-49" data-line-number="49"></a>
<a class="sourceLine" id="cb189-50" data-line-number="50"></a>
<a class="sourceLine" id="cb189-51" data-line-number="51"><span class="kw">set</span> @FirstDate=<span class="st">&#39;1990-01-01&#39;</span></a>
<a class="sourceLine" id="cb189-52" data-line-number="52"><span class="kw">set</span> @NumberOfYearsToGenerate=<span class="dv">40</span></a>
<a class="sourceLine" id="cb189-53" data-line-number="53"></a>
<a class="sourceLine" id="cb189-54" data-line-number="54"><span class="co">-- do not change line below</span></a>
<a class="sourceLine" id="cb189-55" data-line-number="55"><span class="kw">set</span> @LastDate=DATEADD(<span class="dt">YEAR</span>,@NumberOfYearsToGenerate,@FirstDate)</a>
<a class="sourceLine" id="cb189-56" data-line-number="56"></a>
<a class="sourceLine" id="cb189-57" data-line-number="57"><span class="kw">set</span> @CurrentDate=@FirstDate</a>
<a class="sourceLine" id="cb189-58" data-line-number="58"><span class="kw">set</span> @FiscalYearStartMonth=<span class="dv">7</span></a>
<a class="sourceLine" id="cb189-59" data-line-number="59"></a>
<a class="sourceLine" id="cb189-60" data-line-number="60"><span class="co">-- insert weekly holidays </span></a>
<a class="sourceLine" id="cb189-61" data-line-number="61"><span class="kw">insert</span> <span class="kw">into</span> @WeeklyHolidays([WeekDay]) <span class="kw">values</span>(<span class="dv">1</span>) <span class="co">-- sunday</span></a>
<a class="sourceLine" id="cb189-62" data-line-number="62"><span class="kw">insert</span> <span class="kw">into</span> @WeeklyHolidays([WeekDay]) <span class="kw">values</span>(<span class="dv">7</span>) <span class="co">-- saturday</span></a>
<a class="sourceLine" id="cb189-63" data-line-number="63"></a>
<a class="sourceLine" id="cb189-64" data-line-number="64"><span class="co">-- insert annual public holidays</span></a>
<a class="sourceLine" id="cb189-65" data-line-number="65"><span class="kw">insert</span> <span class="kw">into</span> @AnnulPublicHolidays([<span class="dt">Date</span>]) <span class="kw">values</span>(<span class="dv">20130101</span>) <span class="co">-- New Year&#39;s Day</span></a>
<a class="sourceLine" id="cb189-66" data-line-number="66"><span class="kw">insert</span> <span class="kw">into</span> @AnnulPublicHolidays([<span class="dt">Date</span>]) <span class="kw">values</span>(<span class="dv">20130102</span>) <span class="co">-- Day after New Year&#39;s Day</span></a>
<a class="sourceLine" id="cb189-67" data-line-number="67"><span class="kw">insert</span> <span class="kw">into</span> @AnnulPublicHolidays([<span class="dt">Date</span>]) <span class="kw">values</span>(<span class="dv">20130430</span>) <span class="co">-- Day after New Year&#39;s Day</span></a>
<a class="sourceLine" id="cb189-68" data-line-number="68"><span class="kw">insert</span> <span class="kw">into</span> @AnnulPublicHolidays([<span class="dt">Date</span>]) <span class="kw">values</span>(<span class="dv">20130501</span>) <span class="co">-- Day after New Year&#39;s Day</span></a>
<a class="sourceLine" id="cb189-69" data-line-number="69"><span class="kw">insert</span> <span class="kw">into</span> @AnnulPublicHolidays([<span class="dt">Date</span>]) <span class="kw">values</span>(<span class="dv">20130902</span>) <span class="co">-- Day after New Year&#39;s Day</span></a>
<a class="sourceLine" id="cb189-70" data-line-number="70"></a>
<a class="sourceLine" id="cb189-71" data-line-number="71"><span class="co">-- Step 3: Chạy vòng lặp</span></a>
<a class="sourceLine" id="cb189-72" data-line-number="72"></a>
<a class="sourceLine" id="cb189-73" data-line-number="73"><span class="kw">while</span>(@CurrentDate&lt;@LastDate)</a>
<a class="sourceLine" id="cb189-74" data-line-number="74"><span class="kw">begin</span></a>
<a class="sourceLine" id="cb189-75" data-line-number="75"></a>
<a class="sourceLine" id="cb189-76" data-line-number="76"><span class="kw">INSERT</span> <span class="kw">INTO</span> [dbo].[DimDate]</a>
<a class="sourceLine" id="cb189-77" data-line-number="77">           ([DateKey]</a>
<a class="sourceLine" id="cb189-78" data-line-number="78">           ,[DateFullName]</a>
<a class="sourceLine" id="cb189-79" data-line-number="79">           ,[DateFull]</a>
<a class="sourceLine" id="cb189-80" data-line-number="80">           ,[<span class="dt">Year</span>]</a>
<a class="sourceLine" id="cb189-81" data-line-number="81">           ,[Quarter]</a>
<a class="sourceLine" id="cb189-82" data-line-number="82">           ,[QuarterName]</a>
<a class="sourceLine" id="cb189-83" data-line-number="83">           ,[QuarterKey]</a>
<a class="sourceLine" id="cb189-84" data-line-number="84">           ,[<span class="dt">Month</span>]</a>
<a class="sourceLine" id="cb189-85" data-line-number="85">           ,[MonthKey]</a>
<a class="sourceLine" id="cb189-86" data-line-number="86">           ,[MonthName]</a>
<a class="sourceLine" id="cb189-87" data-line-number="87">           ,[DayOfMonth]</a>
<a class="sourceLine" id="cb189-88" data-line-number="88">           ,[NumberOfDaysInTheMonth]</a>
<a class="sourceLine" id="cb189-89" data-line-number="89">           ,[DayOfYear]</a>
<a class="sourceLine" id="cb189-90" data-line-number="90">           ,[WeekOfYear]</a>
<a class="sourceLine" id="cb189-91" data-line-number="91">           ,[WeekOfYearKey]</a>
<a class="sourceLine" id="cb189-92" data-line-number="92">           ,[ISOWeek]</a>
<a class="sourceLine" id="cb189-93" data-line-number="93">           ,[ISOWeekKey]</a>
<a class="sourceLine" id="cb189-94" data-line-number="94">           ,[WeekDay]</a>
<a class="sourceLine" id="cb189-95" data-line-number="95">           ,[WeekDayName]</a>
<a class="sourceLine" id="cb189-96" data-line-number="96">           ,[FiscalYear]</a>
<a class="sourceLine" id="cb189-97" data-line-number="97">           ,[FiscalQuarter]</a>
<a class="sourceLine" id="cb189-98" data-line-number="98">           ,[FiscalQuarterKey]</a>
<a class="sourceLine" id="cb189-99" data-line-number="99">           ,[FiscalMonth]</a>
<a class="sourceLine" id="cb189-100" data-line-number="100">           ,[FiscalMonthKey]</a>
<a class="sourceLine" id="cb189-101" data-line-number="101">           ,[IsWorkDayKey]</a>
<a class="sourceLine" id="cb189-102" data-line-number="102">           ,[IsWorkDayDescription]</a>
<a class="sourceLine" id="cb189-103" data-line-number="103">           ,[IsPublicHolidayKey]</a>
<a class="sourceLine" id="cb189-104" data-line-number="104">           ,[IsPublicHolidayDescription])</a>
<a class="sourceLine" id="cb189-105" data-line-number="105"></a>
<a class="sourceLine" id="cb189-106" data-line-number="106"></a>
<a class="sourceLine" id="cb189-107" data-line-number="107"><span class="kw">select</span> </a>
<a class="sourceLine" id="cb189-108" data-line-number="108"><span class="fu">convert</span>(<span class="dt">int</span>,<span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">8</span>),@CurrentDate,<span class="dv">112</span>)) <span class="kw">as</span> [DateKey],</a>
<a class="sourceLine" id="cb189-109" data-line-number="109"><span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="fu">max</span>),@CurrentDate,<span class="dv">106</span>) <span class="kw">as</span> [DateFullName],</a>
<a class="sourceLine" id="cb189-110" data-line-number="110"><span class="ot">@CurrentDate as [DateFull],</span></a>
<a class="sourceLine" id="cb189-111" data-line-number="111">datepart(<span class="dt">year</span>,@CurrentDate) <span class="kw">as</span> [<span class="dt">Year</span>],</a>
<a class="sourceLine" id="cb189-112" data-line-number="112">datepart(QUARTER,@CurrentDate) <span class="kw">as</span> [Quarter],</a>
<a class="sourceLine" id="cb189-113" data-line-number="113"><span class="st">&#39;QTR &#39;</span>+datename(QUARTER,@CurrentDate) <span class="kw">as</span> [QuarterName],</a>
<a class="sourceLine" id="cb189-114" data-line-number="114"><span class="fu">convert</span>(<span class="dt">int</span>,datename(<span class="dt">year</span>,@CurrentDate)+datename(QUARTER,@CurrentDate)) <span class="kw">as</span> [QuarterKey],</a>
<a class="sourceLine" id="cb189-115" data-line-number="115">datepart(<span class="dt">month</span>,@CurrentDate) <span class="kw">as</span> [<span class="dt">Month</span>],</a>
<a class="sourceLine" id="cb189-116" data-line-number="116"><span class="fu">convert</span>(<span class="dt">int</span>,datename(<span class="dt">year</span>,@CurrentDate)+right(<span class="st">&#39;0&#39;</span>+convert(<span class="dt">varchar</span>(<span class="dv">2</span>),datepart(<span class="dt">month</span>,@CurrentDate)),<span class="dv">2</span>)) <span class="kw">as</span> [MonthKey],</a>
<a class="sourceLine" id="cb189-117" data-line-number="117">datename(<span class="dt">month</span>,@CurrentDate) <span class="kw">as</span> [MonthName],</a>
<a class="sourceLine" id="cb189-118" data-line-number="118">datepart(<span class="dt">day</span>,@CurrentDate) <span class="kw">as</span> [DayOfMonth],</a>
<a class="sourceLine" id="cb189-119" data-line-number="119">datepart(<span class="dt">day</span>,EOMONTH(@CurrentDate)) <span class="kw">as</span> [NumberOfDaysInTheMonth],</a>
<a class="sourceLine" id="cb189-120" data-line-number="120">datepart(DAYOFYEAR,@CurrentDate) <span class="kw">as</span> [DayOfYear],</a>
<a class="sourceLine" id="cb189-121" data-line-number="121">datepart(WEEK,@CurrentDate) <span class="kw">as</span> [WeekOfYear],</a>
<a class="sourceLine" id="cb189-122" data-line-number="122">datename(<span class="dt">year</span>,@CurrentDate)+right(<span class="st">&#39;0&#39;</span>+datename(week,@CurrentDate),<span class="dv">2</span>) <span class="kw">as</span> [WeekOfYearKey],</a>
<a class="sourceLine" id="cb189-123" data-line-number="123">datepart(ISO_WEEK,@CurrentDate) <span class="kw">as</span> [ISOWeek],</a>
<a class="sourceLine" id="cb189-124" data-line-number="124">datename(<span class="dt">year</span>,@CurrentDate)+right(<span class="st">&#39;0&#39;</span>+convert(<span class="dt">varchar</span>(<span class="dv">2</span>),datepart(ISO_WEEK,@CurrentDate)),<span class="dv">2</span>) <span class="kw">as</span> [ISOWeekKey],</a>
<a class="sourceLine" id="cb189-125" data-line-number="125">datepart(WEEKDAY,@CurrentDate) <span class="kw">as</span> [WeekDay],</a>
<a class="sourceLine" id="cb189-126" data-line-number="126">datename(WEEKDAY,@CurrentDate) <span class="kw">as</span> [WeekDayName],</a>
<a class="sourceLine" id="cb189-127" data-line-number="127"><span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)&lt;@FiscalYearStartMonth <span class="kw">then</span> <span class="dt">year</span>(@CurrentDate) <span class="kw">else</span> <span class="dt">year</span>(@CurrentDate)+<span class="dv">1</span> <span class="kw">end</span> <span class="kw">as</span> [FiscalYear],</a>
<a class="sourceLine" id="cb189-128" data-line-number="128">ceiling(<span class="fu">convert</span>(<span class="dt">float</span>,(<span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)=<span class="dv">13</span>-@FiscalYearStartMonth <span class="kw">then</span> <span class="dv">12</span> <span class="kw">else</span> ((@FiscalYearStartMonth<span class="dv">-1</span>)+month(@CurrentDate))%<span class="dv">12</span> <span class="kw">end</span>))/<span class="dv">3</span>) <span class="kw">as</span> [FiscalQuarter],</a>
<a class="sourceLine" id="cb189-129" data-line-number="129"><span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">4</span>),<span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)&lt;@FiscalYearStartMonth <span class="kw">then</span> <span class="dt">year</span>(@CurrentDate) <span class="kw">else</span> <span class="dt">year</span>(@CurrentDate)+<span class="dv">1</span> <span class="kw">end</span>)</a>
<a class="sourceLine" id="cb189-130" data-line-number="130">+</a>
<a class="sourceLine" id="cb189-131" data-line-number="131"><span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">1</span>),ceiling(<span class="fu">convert</span>(<span class="dt">float</span>,(<span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)=<span class="dv">13</span>-@FiscalYearStartMonth <span class="kw">then</span> <span class="dv">12</span> <span class="kw">else</span> ((@FiscalYearStartMonth<span class="dv">-1</span>)+month(@CurrentDate))%<span class="dv">12</span> <span class="kw">end</span>))/<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb189-132" data-line-number="132"><span class="kw">as</span> [FiscalQuarterKey],</a>
<a class="sourceLine" id="cb189-133" data-line-number="133"><span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)=<span class="dv">13</span>-@FiscalYearStartMonth <span class="kw">then</span> <span class="dv">12</span> <span class="kw">else</span> ((@FiscalYearStartMonth<span class="dv">-1</span>)+month(@CurrentDate))%<span class="dv">12</span> <span class="kw">end</span> <span class="kw">as</span> [FiscalMonth],</a>
<a class="sourceLine" id="cb189-134" data-line-number="134"><span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">4</span>),<span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)&lt;@FiscalYearStartMonth <span class="kw">then</span> <span class="dt">year</span>(@CurrentDate) <span class="kw">else</span> <span class="dt">year</span>(@CurrentDate)+<span class="dv">1</span> <span class="kw">end</span>)</a>
<a class="sourceLine" id="cb189-135" data-line-number="135">+</a>
<a class="sourceLine" id="cb189-136" data-line-number="136"><span class="kw">right</span>(<span class="st">&#39;0&#39;</span>+convert(<span class="dt">varchar</span>(<span class="dv">2</span>),<span class="kw">case</span> <span class="kw">when</span> <span class="dt">month</span>(@CurrentDate)=<span class="dv">13</span>-@FiscalYearStartMonth <span class="kw">then</span> <span class="dv">12</span> <span class="kw">else</span> ((@FiscalYearStartMonth<span class="dv">-1</span>)+month(@CurrentDate))%<span class="dv">12</span> <span class="kw">end</span>),<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb189-137" data-line-number="137"><span class="kw">as</span> [FiscalMonthKey],</a>
<a class="sourceLine" id="cb189-138" data-line-number="138"><span class="kw">case</span> <span class="kw">when</span> datepart(WEEKDAY,@CurrentDate) <span class="kw">in</span> (<span class="kw">select</span> [weekday] <span class="kw">from</span> @WeeklyHolidays) <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">0</span> <span class="kw">end</span> <span class="kw">as</span> [IsWorkDayKey],</a>
<a class="sourceLine" id="cb189-139" data-line-number="139"><span class="kw">case</span> <span class="kw">when</span> datepart(WEEKDAY,@CurrentDate) <span class="kw">in</span> (<span class="kw">select</span> [weekday] <span class="kw">from</span> @WeeklyHolidays) <span class="kw">then</span> <span class="st">&#39;Weekend&#39;</span> <span class="kw">else</span> <span class="st">&#39;Workday&#39;</span> <span class="kw">end</span> <span class="kw">as</span> [IsWorkDayDescription],</a>
<a class="sourceLine" id="cb189-140" data-line-number="140"><span class="kw">case</span> <span class="kw">when</span> <span class="fu">convert</span>(<span class="dt">int</span>,<span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">8</span>),@CurrentDate,<span class="dv">112</span>)) <span class="kw">in</span> (<span class="kw">select</span> [<span class="dt">Date</span>] <span class="kw">from</span> @AnnulPublicHolidays) <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">0</span> <span class="kw">end</span> <span class="kw">as</span> [IsPublicHolidayKey],</a>
<a class="sourceLine" id="cb189-141" data-line-number="141"><span class="kw">case</span> <span class="kw">when</span> <span class="fu">convert</span>(<span class="dt">int</span>,<span class="fu">convert</span>(<span class="dt">varchar</span>(<span class="dv">8</span>),@CurrentDate,<span class="dv">112</span>)) <span class="kw">in</span> (<span class="kw">select</span> [<span class="dt">Date</span>] <span class="kw">from</span> @AnnulPublicHolidays) <span class="kw">then</span> <span class="st">&#39;Holiday&#39;</span> <span class="kw">else</span> <span class="st">&#39;Non Holiday&#39;</span> <span class="kw">end</span> <span class="kw">as</span> [IsPublicHolidayDescription]</a>
<a class="sourceLine" id="cb189-142" data-line-number="142"></a>
<a class="sourceLine" id="cb189-143" data-line-number="143"><span class="kw">set</span> @CurrentDate=dateadd(<span class="dt">day</span>,<span class="dv">1</span>,@CurrentDate)</a>
<a class="sourceLine" id="cb189-144" data-line-number="144"><span class="kw">end</span></a></code></pre></div>
<p>Cấu trúc xây dựng có 2 dạng chính: Star schema hoặc Snow schema. Việc lựa chọn cấu trúc tùy thuộc vào performance</p>
<div id="xay-dng-bang" class="section level3">
<h3><span class="header-section-number">4.16.1</span> Xây dựng bảng</h3>
<div id="atomic-data" class="section level4">
<h4><span class="header-section-number">4.16.1.1</span> Atomic data</h4>
<ul>
<li><strong>Atomic data</strong>: Là một thông tin không thể/hoặc không nên chia nhỏ hơn. VD</li>
</ul>
<p><strong>Non-atomic</strong></p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Street</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>123</td>
<td>89 Lang Ha, Dong Da, Ha Noi</td>
</tr>
</tbody>
</table>
<p><strong>Atomic</strong></p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>No</th>
<th>Street</th>
<th>District</th>
<th>City</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>123</td>
<td>89</td>
<td>Lang Ha</td>
<td>Dong Da</td>
<td>Hanoi</td>
</tr>
</tbody>
</table>
<p><strong>Phương pháp xác định Atomic Data</strong></p>
<ul>
<li>Một bảng atomic không thể có nhiều giá trị thuộc cùng 1 loại trong cột</li>
</ul>
<p>VD:</p>
<table>
<thead>
<tr class="header">
<th>food_name</th>
<th>ingredients</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>bread</td>
<td>flour, milk, egg</td>
</tr>
</tbody>
</table>
<ul>
<li>Một bảng atomic không thể có nhiều column thuộc cùng 1 loại</li>
</ul>
<table>
<thead>
<tr class="header">
<th>teacher</th>
<th>student_1</th>
<th>student_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>D.Anh</td>
<td>Trang</td>
<td>Ha</td>
</tr>
</tbody>
</table>
</div>
<div id="primary-key" class="section level4">
<h4><span class="header-section-number">4.16.1.2</span> Primary key</h4>
<ul>
<li>Primary key là cột khiến mỗi bản ghi (record) duy nhất</li>
<li>Quy tắc:
<ul>
<li>Không được NULL</li>
<li>Mỗi khi ghi thêm một record, phải có thêm một giá trị của primary key</li>
<li>Là duy nhất</li>
<li>Không được thay đổi</li>
</ul></li>
<li><p>Bảng chứa primary key được sử dụng làm foreign key ở bảng khác được gọi là bảng mẹ (parent table), bảng kia được gọi là bảng con (child table)</p></li>
<li><p>Các bảng được xây dựng dựa trên nguyên tắc Atomic Datađược gọi là NF1 (First Normal Form)</p></li>
</ul>
</div>
</div>
<div id="xay-dng-database" class="section level3">
<h3><span class="header-section-number">4.16.2</span> Xây dựng database</h3>
<ul>
<li>Tạo constraint để join các bảng: Lợi ích, chỉ cho phép</li>
</ul>
<div class="sourceCode" id="cb190"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb190-1" data-line-number="1"><span class="kw">use</span> tempdb</a>
<a class="sourceLine" id="cb190-2" data-line-number="2"><span class="kw">drop</span> <span class="kw">table</span> <span class="kw">if</span> <span class="kw">exists</span> test1</a>
<a class="sourceLine" id="cb190-3" data-line-number="3"><span class="kw">create</span> <span class="kw">table</span> test1</a>
<a class="sourceLine" id="cb190-4" data-line-number="4">(<span class="kw">id</span> <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">primary</span> <span class="kw">key</span>,</a>
<a class="sourceLine" id="cb190-5" data-line-number="5"> name <span class="dt">varchar</span>(<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb190-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb190-7" data-line-number="7"> <span class="kw">create</span> <span class="kw">table</span> test2</a>
<a class="sourceLine" id="cb190-8" data-line-number="8"> (id_new <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span>,</a>
<a class="sourceLine" id="cb190-9" data-line-number="9">  CIF <span class="dt">int</span> <span class="kw">not</span> <span class="kw">null</span> ,</a>
<a class="sourceLine" id="cb190-10" data-line-number="10">  job <span class="dt">varchar</span>(<span class="dv">10</span>),</a>
<a class="sourceLine" id="cb190-11" data-line-number="11">  <span class="kw">constraint</span> id_key</a>
<a class="sourceLine" id="cb190-12" data-line-number="12">  <span class="kw">foreign</span> <span class="kw">key</span> (id_new)</a>
<a class="sourceLine" id="cb190-13" data-line-number="13">  <span class="kw">references</span> test1(<span class="kw">id</span>))</a></code></pre></div>
<ul>
<li>Các kiểu quan hệ:
<ul>
<li>Quan hệ 1-1: Một dòng trong bảng join với 1 dòng trong bảng khác. VD: Customer vs. Customer_contact, nguyên tắc 1-1, join với nhau bằng Customer_ID</li>
<li>Quan hệ 1-n: Một dòng join với nhiều dòng khác. VD: 1 khách hàng có thể có nhiều giao dịch</li>
<li>Quan hệ n-n: Một dòng có thể join với nhiều dòng và ngược lại. VD: Một phụ nữ có thể mua nhiều loại giày và một loại giày (shoes_id) có thể được mua bởi nhiều người phụ nữ</li>
</ul></li>
</ul>
<p><strong>Trick</strong>: Sử dụng <em>junction table</em> để làm proxy với mối quan hệ n-n. Ví dụ:</p>
<p><img src="Images/junction_table.png" /></p>
<ul>
<li>Nguyên tắc ATOMIC data đặc biệt quan trọng khi xây dựng bảng. Nếu 1 bảng không tuân thủ nguyên tắc đó thì phải chia nhỏ thành nhiều bảng.</li>
</ul>
<p><img src="Images/nf_1.png" />
<img src="Images/nf_2.png" /></p>
<p><strong>Composite key</strong>: Key được tạo từ 2 hoặc nhiều cột</p>
<p><strong>2NF</strong>: 1NF là 2NF nếu tất cả các cột trong bảng là MỘT PHẦN của Primary key hoặc có một cột primary key duy nhất</p>
<p><img src="Images/2nf.png" /></p>
</div>
</div>
<div id="s-dung-sqlcmd" class="section level2">
<h2><span class="header-section-number">4.17</span> Sử dụng SQLCMD</h2>
<ul>
<li>Bật SQLCMD Mode
<ul>
<li>Bật SQL Script &gt;&gt; Query &gt;&gt; SQLCMD Mode</li>
</ul></li>
<li>Bật SQLCMD Mode default: Tools &gt;&gt; Options &gt;&gt; Query Execution &gt;&gt; SQLCMD Mode</li>
</ul>
<p>** Chạy script từ script**</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb191-1" data-line-number="1"><span class="ch">:setvar</span> path <span class="ot">&quot;F:\OneDrive - VPBank\1. Personal projects\SQL in R\sqlcmd example&quot;</span></a>
<a class="sourceLine" id="cb191-2" data-line-number="2"></a>
<a class="sourceLine" id="cb191-3" data-line-number="3"><span class="ch">:r</span> $(path)<span class="ot">&quot;\test\test_1.sql&quot;</span></a></code></pre></div>
<ul>
<li>Chạy SQL từ bat</li>
</ul>
<div class="sourceCode" id="cb192"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb192-1" data-line-number="1">sqlcmd -S HON-BICC-PC0035 -U sa -P <span class="dv">123</span> -i master.sql -o out.log</a></code></pre></div>
<ul>
<li>Đặt job với SQLCMD option</li>
</ul>
<div class="sourceCode" id="cb193"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb193-1" data-line-number="1">sqlcmd -i <span class="ot">&quot;F:/OneDrive - VPBank/1. Personal projects/SQL in R/sqlcmd example/master.sql&quot;</span></a></code></pre></div>
<p><img src="Images/job_sqlcmd.png" /></p>


</div>
</div>



</div>
            </section>

          </div>
        </div>
      </div>
<a href="ng-phap-cua-bin-i-d-liu-vi-dplyr.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="trc-quan-hoa-d-liu.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yihui/bookdown-crc/edit/master/60-sql-in-r.Rmd",
"text": "Edit"
},
"download": ["bookdown.pdf", "bookdown.epub"],
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>

---
title: "Biến đổi dữ liệu nâng cao trong purrr"
author: "Hoàng Đức Anh"
date: "2019-05-05"
categories:
  - data-manipulation
tags:
  - purrr
summary: "Sử dụng hàm modify, compose trong purrr để biến đổi nhanh dữ liệu"
banner: "img/banners/banner-40.png"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

Bài viết này tiếp nối series về ứng dụng của `purrr` trong phân tích dữ liệu. Ở phần trước, chúng ta đã học về cách sử dụng `map`. Trong bài viết này, `Ranalytics` sẽ hướng dẫn các bạn sử dụng thêm 3 ứng dụng thường dùng của `purrr`:

- Thay đổi biến với `modify`
- Tạo các hàm khi sử dụng cùng map
- Tạo các chuỗi hàm với `compose`

---

## Sửa đổi giá trị với `modify`

Tương tự như `map`, `modify` cho áp dụng hàm vào một nhóm các list. Tuy nhiên, khác với `map`, `modify` cho ra kết quả với cấu trúc dữ liệu ban đâu.

```{r}
library(tidyverse)
# map đổi cấu trúc của dataframe
iris %>% 
  map_if(is.factor, as.character) %>% 
  str
# modify giữ nguyên cấu trúc
iris %>% 
  modify_if(is.factor, as.character) %>% 
  str
```

## Tạo hàm nhanh với `as_mapper`

`as_mapper` cho phép tạo hàm nhanh, đặc biệt hữu ích khi ta chỉ muốn tạo và sử dụng một hàm trong một vài trường hợp đặc biệt.

Công thức tổng quát

```{r, eval = F}
# Với một tham số
as_mapper(~f(.x))
# Với hai tham số
as_mapper(f(.x, .y))
```

Xem các ví dụ sau:

```{r}
# Cộng 10 vào mỗi giá trị
map_dbl(1:3, ~ .x+10)
# Cộng hai vector với nhau
map2_dbl(1:3, 5:7, ~.x + .y)
# Cách viết khác
map2_dbl(1:3, 5:7, as_mapper(~.x + .y))
```

## Xây dựng chuỗi các hàm liên tiếp với `compose`

Hàm `compose` cho phép kết hợp nhiều hàm với nhau với hàm ở bên phải là input đầu vào cho hàm bên trái. Cấu trúc như sau.

```{r, eval = F}
compose(f_2, f_1) 
# Tương đương với
argument %>% f_2 %>% f_1
```

Xem ví dụ sau:

```{r}
library(tidyverse)
library(broom)
lm(Sepal.Length ~ Sepal.Width, data = iris) %>% 
  tidy
```

Cách viết trên có thể thay thế như sau

```{r}
tidy_lm <- compose(tidy, lm)
tidy_lm(Sepal.Length ~ Sepal.Width, data = iris)
```

Ta có thể thêm các nhóm hàm khác đi cùng với `compose` như `filter`

```{r}
my_func <- compose(
  as_mapper(~filter(.x, p.value < 0.05)),
  tidy, 
  lm)
my_func(Sepal.Length ~ Sepal.Width, data = iris)
```

---

Như vậy, với bài viết này, chúng ta đã sử dụng được các hàm thường dùng nhất của `purrr` là `map`, `modify` và `compose`.

Chúc các bạn học tập và làm việc hiệu quả với ``Ranalytics.vn``!